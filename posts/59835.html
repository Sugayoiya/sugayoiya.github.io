

<!DOCTYPE html>
<html lang="zh-CN" data-default-color-scheme=auto>



<head>
  <meta charset="UTF-8">
  <link rel="apple-touch-icon" sizes="76x76" href="/img/browser.png">
  <link rel="icon" href="/img/browser.png">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, shrink-to-fit=no">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  
  <meta name="theme-color" content="#2f4154">
  <meta name="author" content="Sugayoiya">
  <meta name="keywords" content="">
  
    <meta name="description" content="AOPï¼ˆAspect-Oriented Programmingï¼Œé¢å‘åˆ‡é¢ç¼–ç¨‹ï¼‰æ˜¯ä¸€ç§ç¼–ç¨‹èŒƒå¼ï¼Œæ—¨åœ¨é€šè¿‡æ¨ªåˆ‡å…³æ³¨ç‚¹ï¼ˆCross-cutting Concernsï¼‰çš„æŠ½è±¡å’Œæ¨¡å—åŒ–ï¼Œå°†ç³»ç»Ÿçš„åŠŸèƒ½å’ŒéåŠŸèƒ½éœ€æ±‚åˆ†ç¦»ï¼Œä»è€Œæé«˜ä»£ç çš„å¯ç»´æŠ¤æ€§ã€å¯é‡ç”¨æ€§å’Œçµæ´»æ€§">
<meta property="og:type" content="article">
<meta property="og:title" content="ä»£ç† Proxy åå°„ Reflect ä¸ Spring AOP">
<meta property="og:url" content="https://sugayoiya.github.io/posts/59835.html">
<meta property="og:site_name" content="æ±æ–¹ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆ">
<meta property="og:description" content="AOPï¼ˆAspect-Oriented Programmingï¼Œé¢å‘åˆ‡é¢ç¼–ç¨‹ï¼‰æ˜¯ä¸€ç§ç¼–ç¨‹èŒƒå¼ï¼Œæ—¨åœ¨é€šè¿‡æ¨ªåˆ‡å…³æ³¨ç‚¹ï¼ˆCross-cutting Concernsï¼‰çš„æŠ½è±¡å’Œæ¨¡å—åŒ–ï¼Œå°†ç³»ç»Ÿçš„åŠŸèƒ½å’ŒéåŠŸèƒ½éœ€æ±‚åˆ†ç¦»ï¼Œä»è€Œæé«˜ä»£ç çš„å¯ç»´æŠ¤æ€§ã€å¯é‡ç”¨æ€§å’Œçµæ´»æ€§">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://sugayoiya.github.io/img/post/Fu4UyT-aMAEnBuE.jpeg">
<meta property="article:published_time" content="2021-08-01T13:03:44.000Z">
<meta property="article:modified_time" content="2023-07-25T08:55:47.000Z">
<meta property="article:author" content="Sugayoiya">
<meta property="article:tag" content="Java">
<meta property="article:tag" content="AOP">
<meta property="article:tag" content="Reflect">
<meta property="article:tag" content="Proxy">
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:image" content="https://sugayoiya.github.io/img/post/Fu4UyT-aMAEnBuE.jpeg">
  
  
    <meta name="referrer" content="no-referrer-when-downgrade">
  
  
  <title>ä»£ç† Proxy åå°„ Reflect ä¸ Spring AOP - æ±æ–¹ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆ</title>

  <link  rel="stylesheet" href="https://lib.baomitu.com/twitter-bootstrap/4.6.1/css/bootstrap.min.css" />



  <link  rel="stylesheet" href="https://lib.baomitu.com/github-markdown-css/4.0.0/github-markdown.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/hint.css/2.7.0/hint.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.css" />



<!-- ä¸»é¢˜ä¾èµ–çš„å›¾æ ‡åº“ï¼Œä¸è¦è‡ªè¡Œä¿®æ”¹ -->
<!-- Do not modify the link that theme dependent icons -->

<link rel="stylesheet" href="//at.alicdn.com/t/font_1749284_hj8rtnfg7um.css">



<link rel="stylesheet" href="//at.alicdn.com/t/font_1736178_lbnruvf0jn.css">


<link  rel="stylesheet" href="/css/main.css" />


  <link id="highlight-css" rel="stylesheet" href="/css/highlight.css" />
  
    <link id="highlight-css-dark" rel="stylesheet" href="/css/highlight-dark.css" />
  




  <script id="fluid-configs">
    var Fluid = window.Fluid || {};
    Fluid.ctx = Object.assign({}, Fluid.ctx)
    var CONFIG = {"hostname":"sugayoiya.github.io","root":"/","version":"1.9.5-a","typing":{"enable":true,"typeSpeed":70,"cursorChar":"_","loop":false,"scope":[]},"anchorjs":{"enable":true,"element":"h1,h2,h3,h4,h5,h6","placement":"left","visible":"hover","icon":""},"progressbar":{"enable":true,"height_px":3,"color":"#29d","options":{"showSpinner":false,"trickleSpeed":100}},"code_language":{"enable":true,"default":"TEXT"},"copy_btn":true,"image_caption":{"enable":true},"image_zoom":{"enable":true,"img_url_replace":["",""]},"toc":{"enable":true,"placement":"right","headingSelector":"h1,h2,h3,h4,h5,h6","collapseDepth":0},"lazyload":{"enable":true,"loading_img":"/img/loading.gif","onlypost":false,"offset_factor":2},"web_analytics":{"enable":true,"follow_dnt":true,"baidu":null,"google":{"measurement_id":null},"tencent":{"sid":null,"cid":null},"woyaola":null,"cnzz":null,"leancloud":{"app_id":"vggcI4F6j2ISzL56HSxMZF9V-MdYXbMMI","app_key":"yKtFKhuP8rhbpXecJ4jmPFmq","server_url":null,"path":"window.location.pathname","ignore_local":false}},"search_path":"/local-search.xml","include_content_in_search":true};

    if (CONFIG.web_analytics.follow_dnt) {
      var dntVal = navigator.doNotTrack || window.doNotTrack || navigator.msDoNotTrack;
      Fluid.ctx.dnt = dntVal && (dntVal.startsWith('1') || dntVal.startsWith('yes') || dntVal.startsWith('on'));
    }
  </script>
  <script  src="/js/utils.js" ></script>
  <script  src="/js/color-schema.js" ></script>
  

  

  
    <!-- Google tag (gtag.js) -->
    <script async>
      if (!Fluid.ctx.dnt) {
        Fluid.utils.createScript("https://www.googletagmanager.com/gtag/js?id=", function() {
          window.dataLayer = window.dataLayer || [];
          function gtag() {
            dataLayer.push(arguments);
          }
          gtag('js', new Date());
          gtag('config', '');
        });
      }
    </script>
  

  

  

  

  
    
  



  
<meta name="generator" content="Hexo 6.3.0"></head>


<body>
  

  <header>
    

<div class="header-inner" style="height: 70vh;">
  <nav id="navbar" class="navbar fixed-top  navbar-expand-lg navbar-dark scrolling-navbar">
  <div class="container">
    <a class="navbar-brand" href="/">
      <strong>Sugayoiya</strong>
    </a>

    <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse"
            data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <div class="animated-icon"><span></span><span></span><span></span></div>
    </button>

    <!-- Collapsible content -->
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav ml-auto text-center">
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/">
                <i class="iconfont icon-home-fill"></i>
                <span>å¦–æ€ªã®å±±</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/archives/">
                <i class="iconfont icon-archive-fill"></i>
                <span>ç´…é­”é¤¨</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/categories/">
                <i class="iconfont icon-category-fill"></i>
                <span>é›¾ä¹‹æ¹–</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/tags/">
                <i class="iconfont icon-tags-fill"></i>
                <span>äººé–“ã®é‡Œ</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/about/">
                <i class="iconfont icon-user-fill"></i>
                <span>æ°¸é äº­</span>
              </a>
            </li>
          
        
        
          <li class="nav-item" id="search-btn">
            <a class="nav-link" target="_self" href="javascript:;" data-toggle="modal" data-target="#modalSearch" aria-label="Search">
              <i class="iconfont icon-search"></i>
            </a>
          </li>
          
        
        
          <li class="nav-item" id="color-toggle-btn">
            <a class="nav-link" target="_self" href="javascript:;" aria-label="Color Toggle">
              <i class="iconfont icon-dark" id="color-toggle-icon"></i>
            </a>
          </li>
        
      </ul>
    </div>
  </div>
</nav>

  

<div id="banner" class="banner" parallax=true
     style="background: url('/img/post/%E5%91%BD%E3%81%AB%E5%AB%8C%E3%82%8F%E3%82%8C%E3%81%A6%E3%81%84%E3%82%8B.jpeg') no-repeat center center; background-size: cover;">
  <div class="full-bg-img">
    <div class="mask flex-center" style="background-color: rgba(0, 0, 0, 0.3)">
      <div class="banner-text text-center fade-in-up">
        <div class="h2">
          
            <span id="subtitle" data-typed-text="ä»£ç† Proxy åå°„ Reflect ä¸ Spring AOP"></span>
          
        </div>

        
          
  <div class="mt-3">
    
    
      <span class="post-meta">
        <i class="iconfont icon-date-fill" aria-hidden="true"></i>
        <time datetime="2021-08-01 21:03" pubdate>
          2021å¹´8æœˆ1æ—¥ æ™šä¸Š
        </time>
      </span>
    
  </div>

  <div class="mt-1">
    
      <span class="post-meta mr-2">
        <i class="iconfont icon-chart"></i>
        
          65k å­—
        
      </span>
    

    
      <span class="post-meta mr-2">
        <i class="iconfont icon-clock-fill"></i>
        
        
        
          109 åˆ†é’Ÿ
        
      </span>
    

    
    
      
        <span id="busuanzi_container_page_pv" style="display: none">
          <i class="iconfont icon-eye" aria-hidden="true"></i>
          <span id="busuanzi_value_page_pv"></span> æ¬¡
        </span>
        
      
    
  </div>


        
      </div>

      
    </div>
  </div>
</div>

</div>

  </header>

  <main>
    
      

<div class="container-fluid nopadding-x">
  <div class="row nomargin-x">
    <div class="side-col d-none d-lg-block col-lg-2">
      

    </div>

    <div class="col-lg-8 nopadding-x-md">
      <div class="container nopadding-x-md" id="board-ctn">
        <div id="board">
          <article class="post-content mx-auto">
            <h1 id="seo-header">ä»£ç† Proxy åå°„ Reflect ä¸ Spring AOP</h1>
            
            
              <div class="markdown-body">
                
                <p><strong>AOP</strong>ï¼ˆ<em>Aspect-Oriented Programming</em>ï¼Œé¢å‘åˆ‡é¢ç¼–ç¨‹ï¼‰æ˜¯ä¸€ç§ç¼–ç¨‹èŒƒå¼ï¼Œæ—¨åœ¨é€šè¿‡æ¨ªåˆ‡å…³æ³¨ç‚¹ï¼ˆ<em>Cross-cutting Concerns</em>ï¼‰çš„æŠ½è±¡å’Œæ¨¡å—åŒ–ï¼Œå°†ç³»ç»Ÿçš„åŠŸèƒ½å’ŒéåŠŸèƒ½éœ€æ±‚åˆ†ç¦»ï¼Œä»è€Œæé«˜ä»£ç çš„å¯ç»´æŠ¤æ€§ã€å¯é‡ç”¨æ€§å’Œçµæ´»æ€§</p>
<span id="more"></span>

<h3 id="ä»£ç†æ¨¡å¼"><a href="#ä»£ç†æ¨¡å¼" class="headerlink" title="ä»£ç†æ¨¡å¼"></a>ä»£ç†æ¨¡å¼</h3><p>AOPçš„è¿™ç§æ¨¡å¼ï¼Œåº•å±‚å°±æ˜¯åŸºäºä»£ç†æ¨¡å¼å®ç°</p>
<p><strong>ä»£ç†æ¨¡å¼</strong>ï¼ˆ<em>Proxy Pattern</em>ï¼‰æ˜¯ä¸€ç§ç»“æ„å‹è®¾è®¡æ¨¡å¼ï¼Œä¹Ÿå«<strong>å§”æ‰˜æ¨¡å¼</strong>ï¼Œå®ƒå…è®¸é€šè¿‡ä¸€ä¸ªä»£ç†å¯¹è±¡æ¥æ§åˆ¶å¯¹å¦ä¸€ä¸ªå¯¹è±¡çš„è®¿é—®ã€‚ä»£ç†å¯¹è±¡å……å½“å¦ä¸€ä¸ªå¯¹è±¡çš„æ¥å£ï¼Œä»¥æ§åˆ¶å¯¹è¯¥å¯¹è±¡çš„è®¿é—®ï¼Œå¹¶åœ¨å¿…è¦æ—¶æ·»åŠ é¢å¤–çš„é€»è¾‘ã€‚ä»£ç†æ¨¡å¼ä¸»è¦ç”¨äºå¯¹ç›®æ ‡å¯¹è±¡çš„è®¿é—®è¿›è¡Œæ§åˆ¶ï¼Œå¯ä»¥ç”¨äºå®ç°æ‡’åŠ è½½ã€è®¿é—®æ§åˆ¶ã€ç¼“å­˜ã€æ—¥å¿—è®°å½•ç­‰åŠŸèƒ½</p>
<p>ä»£ç†æ¨¡å¼ä¸€èˆ¬åˆ†ä¸ºä»¥ä¸‹ä¸‰ä¸ªè§’è‰²ï¼š</p>
<ol>
<li><p><strong>æŠ½è±¡ä¸»é¢˜</strong>ï¼ˆSubjectï¼‰ï¼šå®šä¹‰äº†ç›®æ ‡å¯¹è±¡å’Œä»£ç†å¯¹è±¡çš„å…±åŒæ¥å£ï¼Œè¿™æ ·åœ¨ä»»ä½•ä½¿ç”¨ç›®æ ‡å¯¹è±¡çš„åœ°æ–¹éƒ½å¯ä»¥ä½¿ç”¨ä»£ç†å¯¹è±¡</p>
</li>
<li><p><strong>çœŸå®ä¸»é¢˜</strong>ï¼ˆReal Subjectï¼‰ï¼šä¹Ÿç§°ä¸ºè¢«ä»£ç†å¯¹è±¡æˆ–ç›®æ ‡å¯¹è±¡ï¼Œå®ƒæ˜¯ä»£ç†æ¨¡å¼ä¸­çš„çœŸæ­£ä¸šåŠ¡é€»è¾‘çš„å®ç°</p>
</li>
<li><p><strong>ä»£ç†</strong>ï¼ˆProxyï¼‰ï¼šä»£ç†å¯¹è±¡ï¼Œå®ƒæŒæœ‰å¯¹çœŸå®ä¸»é¢˜çš„å¼•ç”¨ï¼Œå¹¶å®ç°äº†æŠ½è±¡ä¸»é¢˜çš„æ¥å£ã€‚ä»£ç†å¯¹è±¡é€šå¸¸åœ¨å®¢æˆ·ç«¯ä¸çœŸå®ä¸»é¢˜ä¹‹é—´èµ·åˆ°ä¸­ä»‹çš„ä½œç”¨ï¼Œå®ƒå¯ä»¥åœ¨è°ƒç”¨çœŸå®ä¸»é¢˜ä¹‹å‰æˆ–ä¹‹åæ‰§è¡Œä¸€äº›é™„åŠ æ“ä½œ</p>
</li>
</ol>
<h5 id="ä»£ç†æ¨¡å¼å®ç°"><a href="#ä»£ç†æ¨¡å¼å®ç°" class="headerlink" title="ä»£ç†æ¨¡å¼å®ç°"></a>ä»£ç†æ¨¡å¼å®ç°</h5><p>ä¸‹é¢æ˜¯ä¸€ä¸ªç®€å•çš„Javaä¸­ä»£ç†æ¨¡å¼çš„å®ç°ç¤ºä¾‹ï¼Œä½¿ç”¨äº†é™æ€ä»£ç†æ–¹å¼ï¼š</p>
<ol>
<li>å®šä¹‰æŠ½è±¡ä¸»é¢˜æ¥å£ï¼ˆSubjectï¼‰ï¼š</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// Subject.java</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">Subject</span> &#123;<br>    <span class="hljs-keyword">void</span> <span class="hljs-title function_">doSomething</span><span class="hljs-params">()</span>;<br>&#125;<br></code></pre></td></tr></table></figure>

<ol start="2">
<li>å®šä¹‰çœŸå®ä¸»é¢˜ç±»ï¼ˆRealSubjectï¼‰ï¼š</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// RealSubject.java</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">RealSubject</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Subject</span> &#123;<br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">doSomething</span><span class="hljs-params">()</span> &#123;<br>        System.out.println(<span class="hljs-string">&quot;RealSubject is doing something...&quot;</span>);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<ol start="3">
<li>å®šä¹‰ä»£ç†ç±»ï¼ˆProxyï¼‰ï¼š</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// Proxy.java</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Proxy</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Subject</span> &#123;<br>    <span class="hljs-keyword">private</span> RealSubject realSubject;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">Proxy</span><span class="hljs-params">()</span> &#123;<br>        realSubject = <span class="hljs-keyword">new</span> <span class="hljs-title class_">RealSubject</span>();<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">doSomething</span><span class="hljs-params">()</span> &#123;<br>        System.out.println(<span class="hljs-string">&quot;Proxy is doing something before the RealSubject...&quot;</span>);<br>        realSubject.doSomething();<br>        System.out.println(<span class="hljs-string">&quot;Proxy is doing something after the RealSubject...&quot;</span>);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<ol start="4">
<li>å®¢æˆ·ç«¯ä»£ç ï¼š</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// Client.java</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Client</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br>        <span class="hljs-comment">// ä½¿ç”¨ä»£ç†å¯¹è±¡</span><br>        <span class="hljs-type">Subject</span> <span class="hljs-variable">proxy</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Proxy</span>();<br>        proxy.doSomething();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>è¾“å‡ºç»“æœï¼š</p>
<figure class="highlight gams"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs gams"><span class="hljs-function"><span class="hljs-title">Proxy</span></span> is doing something before the RealSubject...<br><span class="hljs-function"><span class="hljs-title">RealSubject</span></span> is doing something...<br><span class="hljs-function"><span class="hljs-title">Proxy</span></span> is doing something after the RealSubject...<br></code></pre></td></tr></table></figure>

<p>åœ¨ä¸Šé¢çš„ç¤ºä¾‹ä¸­ï¼ŒæŠ½è±¡ä¸»é¢˜ï¼ˆSubjectï¼‰å®šä¹‰äº†ä¸€ä¸ªæ¥å£ï¼ŒçœŸå®ä¸»é¢˜ï¼ˆRealSubjectï¼‰å®ç°äº†è¿™ä¸ªæ¥å£ï¼Œä»£ç†ç±»ï¼ˆProxyï¼‰ä¹Ÿå®ç°äº†è¿™ä¸ªæ¥å£ï¼Œå¹¶åœ¨æ–¹æ³•ä¸­è°ƒç”¨äº†çœŸå®ä¸»é¢˜å¯¹è±¡çš„æ–¹æ³•ï¼ŒåŒæ—¶æ·»åŠ äº†ä¸€äº›é¢å¤–çš„æ“ä½œã€‚å®¢æˆ·ç«¯é€šè¿‡ä»£ç†å¯¹è±¡æ¥è®¿é—®çœŸå®ä¸»é¢˜ï¼Œè€Œæ— éœ€ç›´æ¥ä¸çœŸå®ä¸»é¢˜äº¤äº’ã€‚è¿™æ ·ï¼Œä»£ç†å¯¹è±¡å°±æ§åˆ¶äº†å¯¹çœŸå®ä¸»é¢˜çš„è®¿é—®ï¼Œå¹¶ä¸”å¯ä»¥åœ¨è°ƒç”¨å‰åæ·»åŠ ä¸€äº›è‡ªå®šä¹‰çš„é€»è¾‘</p>
<h5 id="åŠ¨æ€ä»£ç†"><a href="#åŠ¨æ€ä»£ç†" class="headerlink" title="åŠ¨æ€ä»£ç†"></a>åŠ¨æ€ä»£ç†</h5><p>åŠ¨æ€ä»£ç†ä¸é™æ€ä»£ç†çš„åŒºåˆ«ï¼Œé¦–å…ˆè¦äº†è§£ä¸¤ä¸ªå‰ç½®çŸ¥è¯†ç‚¹ï¼šJavaç¨‹åºçš„æ‰§è¡Œä»¥åŠç±»åŠ è½½æœºåˆ¶</p>
<ul>
<li>Javaç¨‹åºçš„æ‰§è¡Œè¿‡ç¨‹<ul>
<li>ç¼–å†™æºä»£ç ï¼šé¦–å…ˆï¼Œå¼€å‘äººå‘˜ä½¿ç”¨Javaç¼–ç¨‹è¯­è¨€ç¼–å†™æºä»£ç ï¼Œæºä»£ç é€šå¸¸ä»¥<code>.java</code>ä¸ºæ‰©å±•å</li>
<li>ç¼–è¯‘æºä»£ç ï¼šä½¿ç”¨Javaç¼–è¯‘å™¨ï¼ˆjavacï¼‰å¯¹æºä»£ç è¿›è¡Œç¼–è¯‘ï¼Œå°†æºä»£ç è½¬æ¢ä¸ºå­—èŠ‚ç æ–‡ä»¶ã€‚å­—èŠ‚ç æ–‡ä»¶ä»¥<code>.class</code>ä¸ºæ‰©å±•åï¼Œå¹¶åŒ…å«Javaè™šæ‹Ÿæœºï¼ˆJVMï¼‰å¯æ‰§è¡Œçš„ä¸­é—´ä»£ç </li>
<li>æ‰§è¡Œ<code>.class</code> æ–‡ä»¶</li>
</ul>
</li>
<li>ç±»åŠ è½½æœºåˆ¶<ul>
<li><strong>åŠ è½½</strong>ï¼ˆloadingï¼‰ï¼šé€šè¿‡ä¸€ä¸ªç±»çš„å…¨é™å®šåæ¥è·å–å®šä¹‰æ­¤ç±»çš„äºŒè¿›åˆ¶å­—èŠ‚æµï¼Œå°†è¿™ä¸ªå­—èŠ‚æµæ‰€ä»£è¡¨çš„é™æ€å­˜å‚¨ç»“æ„è½¬åŒ–ä¸ºæ–¹æ³•åŒºçš„è¿è¡Œæ—¶æ•°æ®ç»“æ„ï¼›åœ¨å†…å­˜ä¸­ç”Ÿæˆä¸€ä¸ªä»£è¡¨è¿™ä¸ªç±»çš„ <code>java.lang.class</code> å¯¹è±¡ï¼Œä½œä¸ºæ–¹æ³•åŒºè¿™ä¸ªç±»çš„å„ç§æ•°æ®è®¿é—®å…¥å£</li>
<li><strong>è¿æ¥</strong>ï¼ˆLinkingï¼‰ï¼š<br>   ç±»åŠ è½½çš„è¿æ¥é˜¶æ®µåŒ…æ‹¬ä¸‰ä¸ªå­é˜¶æ®µï¼š<ul>
<li>éªŒè¯ï¼ˆVerificationï¼‰ï¼šå¯¹åŠ è½½çš„ç±»è¿›è¡ŒéªŒè¯ï¼Œç¡®ä¿å…¶ç¬¦åˆJavaè™šæ‹Ÿæœºè§„èŒƒå’Œå®‰å…¨è¦æ±‚</li>
<li>å‡†å¤‡ï¼ˆPreparationï¼‰ï¼šä¸ºç±»çš„é™æ€å˜é‡åˆ†é…å†…å­˜ç©ºé—´ï¼Œå¹¶è®¾ç½®é»˜è®¤åˆå§‹å€¼</li>
<li>è§£æï¼ˆResolutionï¼‰ï¼šå°†ç±»çš„ç¬¦å·å¼•ç”¨ï¼ˆå¸¸é‡æ± ä¸­çš„ç¬¦å·ï¼‰è§£æä¸ºç›´æ¥å¼•ç”¨ï¼Œå»ºç«‹å¯¹å…¶ä»–ç±»çš„å¼•ç”¨å…³ç³»</li>
</ul>
</li>
<li><strong>åˆå§‹åŒ–</strong>ï¼ˆInitializationï¼‰ï¼š<ul>
<li>åœ¨åˆå§‹åŒ–é˜¶æ®µï¼Œæ‰§è¡Œç±»çš„é™æ€ä»£ç å—å’Œé™æ€åˆå§‹åŒ–è¯­å¥ï¼Œå¯¹ç±»çš„é™æ€å˜é‡è¿›è¡Œåˆå§‹åŒ–</li>
<li>åˆå§‹åŒ–é˜¶æ®µæ˜¯ç±»åŠ è½½çš„æœ€åä¸€ä¸ªé˜¶æ®µï¼Œåœ¨æ­¤é˜¶æ®µå®Œæˆåï¼ŒJavaç±»å¯¹è±¡è¢«å®Œå…¨åˆå§‹åŒ–ï¼Œå¯ä»¥è¢«ä½¿ç”¨</li>
</ul>
</li>
</ul>
</li>
</ul>
<p>åŠ¨æ€ä»£ç†å’Œé™æ€ä»£ç†æ˜¯ä¸¤ç§ä¸åŒçš„ä»£ç†æ¨¡å¼å®ç°æ–¹å¼ï¼Œå®ƒä»¬åœ¨ä»£ç†å¯¹è±¡çš„åˆ›å»ºå’Œä½¿ç”¨æ–¹å¼ä¸Šå­˜åœ¨ä¸€äº›åŒºåˆ«</p>
<ol>
<li><p>åˆ›å»ºæ—¶æœºå’Œæ–¹å¼ï¼š</p>
<ul>
<li>é™æ€ä»£ç†ï¼šåœ¨ç¼–è¯‘é˜¶æ®µå°±éœ€è¦åˆ›å»ºä»£ç†ç±»ï¼Œä»£ç†ç±»æ˜¯ç”±å¼€å‘è€…æ‰‹åŠ¨ç¼–å†™çš„ã€‚å¯¹äºæ¯ä¸€ä¸ªè¢«ä»£ç†çš„ç±»ï¼Œéƒ½éœ€è¦åˆ›å»ºä¸€ä¸ªç›¸åº”çš„ä»£ç†ç±»</li>
<li>åŠ¨æ€ä»£ç†ï¼šåœ¨è¿è¡Œæ—¶åŠ¨æ€ç”Ÿæˆä»£ç†ç±»ï¼Œæ— éœ€æ‰‹åŠ¨ç¼–å†™ä»£ç†ç±»ã€‚ä»£ç†ç±»æ˜¯åœ¨ç¨‹åºè¿è¡Œæ—¶æ ¹æ®æ¥å£æˆ–ç±»ä¿¡æ¯åŠ¨æ€åˆ›å»ºçš„</li>
</ul>
</li>
<li><p>ä»£ç†å¯¹è±¡ä¸ç›®æ ‡å¯¹è±¡çš„å…³ç³»ï¼š</p>
<ul>
<li>é™æ€ä»£ç†ï¼šä»£ç†å¯¹è±¡å’Œç›®æ ‡å¯¹è±¡ä¹‹é—´çš„å…³ç³»æ˜¯é™æ€çš„ï¼Œå³åœ¨ç¼–è¯‘æ—¶å°±å·²ç»ç¡®å®šäº†ã€‚æ¯ä¸ªä»£ç†ç±»åªèƒ½ä»£ç†ä¸€ä¸ªç›®æ ‡ç±»ï¼Œä»£ç†ç±»ä¸ç›®æ ‡ç±»æ˜¯ä¸€ä¸€å¯¹åº”çš„å…³ç³»</li>
<li>åŠ¨æ€ä»£ç†ï¼šä»£ç†å¯¹è±¡å’Œç›®æ ‡å¯¹è±¡ä¹‹é—´çš„å…³ç³»æ˜¯åŠ¨æ€çš„ï¼Œå³åœ¨ç¨‹åºè¿è¡Œæ—¶æ ¹æ®éœ€è¦åŠ¨æ€ç”Ÿæˆä»£ç†ç±»ã€‚ä¸€ä¸ªåŠ¨æ€ä»£ç†ç±»å¯ä»¥ä»£ç†å¤šä¸ªç›®æ ‡ç±»ï¼Œä»£ç†å¯¹è±¡çš„å…³è”æ˜¯åœ¨è¿è¡Œæ—¶å†³å®šçš„</li>
</ul>
</li>
<li><p>å®ç°æ–¹å¼ï¼š</p>
<ul>
<li>é™æ€ä»£ç†ï¼šé€šè¿‡æ‰‹åŠ¨ç¼–å†™ä»£ç†ç±»æ¥å®ç°ï¼Œéœ€è¦ä¸ºæ¯ä¸€ä¸ªç›®æ ‡ç±»åˆ›å»ºä¸€ä¸ªä»£ç†ç±»</li>
<li>åŠ¨æ€ä»£ç†ï¼šä½¿ç”¨Javaçš„åå°„æœºåˆ¶ï¼Œåœ¨è¿è¡Œæ—¶åŠ¨æ€ç”Ÿæˆä»£ç†ç±»ã€‚Javaæä¾›äº†ä¸¤ç§åŠ¨æ€ä»£ç†çš„æ–¹å¼ï¼šåŸºäºæ¥å£çš„ä»£ç†ï¼ˆJDKåŠ¨æ€ä»£ç†ï¼‰å’ŒåŸºäºç±»çš„ä»£ç†ï¼ˆCGLIBåŠ¨æ€ä»£ç†ï¼‰</li>
</ul>
</li>
<li><p>çµæ´»æ€§ï¼š</p>
<ul>
<li>é™æ€ä»£ç†ï¼šä»£ç†ç±»çš„åˆ›å»ºå’Œç›®æ ‡ç±»çš„ç»‘å®šæ˜¯åœ¨ç¼–è¯‘æ—¶ç¡®å®šçš„ï¼Œå› æ­¤åœ¨ç¨‹åºè¿è¡Œæ—¶æ— æ³•åŠ¨æ€æ”¹å˜ä»£ç†å…³ç³»ã€‚</li>
<li>åŠ¨æ€ä»£ç†ï¼šç”±äºä»£ç†ç±»æ˜¯åœ¨è¿è¡Œæ—¶ç”Ÿæˆçš„ï¼Œå› æ­¤å¯ä»¥æ ¹æ®éœ€è¦åŠ¨æ€åœ°æ”¹å˜ä»£ç†å…³ç³»ï¼Œæ›´åŠ çµæ´»ã€‚</li>
</ul>
</li>
</ol>
<p>æ€»ä½“è€Œè¨€ï¼Œé™æ€ä»£ç†éœ€è¦æ‰‹åŠ¨ç¼–å†™ä»£ç†ç±»ï¼Œå¯¹äºå°‘é‡ç›®æ ‡ç±»çš„ä»£ç†æ˜¯å¯è¡Œçš„ï¼Œä½†å½“ç›®æ ‡ç±»æ•°é‡è¾ƒå¤šæ—¶ä¼šäº§ç”Ÿå¤§é‡é‡å¤ä»£ç ã€‚è€ŒåŠ¨æ€ä»£ç†é€šè¿‡åœ¨è¿è¡Œæ—¶åŠ¨æ€ç”Ÿæˆä»£ç†ç±»ï¼Œé¿å…äº†æ‰‹åŠ¨ç¼–å†™ä»£ç†ç±»çš„ç¹çè¿‡ç¨‹ï¼Œé€‚ç”¨äºä»£ç†å¯¹è±¡è¾ƒå¤šã€ä»£ç†å…³ç³»åŠ¨æ€å˜åŒ–çš„æƒ…å†µ</p>
<h5 id="JDKåŠ¨æ€ä»£ç†"><a href="#JDKåŠ¨æ€ä»£ç†" class="headerlink" title="JDKåŠ¨æ€ä»£ç†"></a>JDKåŠ¨æ€ä»£ç†</h5><p>JDKåŠ¨æ€ä»£ç†æ˜¯Javaä¸­å®ç°åŠ¨æ€ä»£ç†çš„ä¸€ç§æœºåˆ¶ï¼Œå®ƒæ˜¯Javaæ ‡å‡†åº“ï¼ˆ<code>java.lang.reflect</code>åŒ…ï¼‰æä¾›çš„ä¸€ç§ä»£ç†æ–¹å¼ã€‚JDKåŠ¨æ€ä»£ç†åŸºäºæ¥å£çš„ä»£ç†æ–¹å¼ï¼Œé€šè¿‡åœ¨è¿è¡Œæ—¶åŠ¨æ€ç”Ÿæˆä»£ç†ç±»æ¥å®ç°ä»£ç†åŠŸèƒ½ã€‚JDKåŠ¨æ€ä»£ç†ä½¿ç”¨äº†Javaçš„åå°„æœºåˆ¶æ¥å®ç°ï¼Œå¯ä»¥åœ¨è¿è¡Œæ—¶åˆ›å»ºä»£ç†å¯¹è±¡ï¼Œæ— éœ€æ‰‹åŠ¨ç¼–å†™ä»£ç†ç±»</p>
<p>JDKåŠ¨æ€ä»£ç†çš„æ ¸å¿ƒç±»æ˜¯<code>java.lang.reflect.Proxy</code>ï¼Œå®ƒæä¾›äº†é™æ€æ–¹æ³•<code>newProxyInstance()</code>æ¥åˆ›å»ºä»£ç†å¯¹è±¡ã€‚<code>newProxyInstance()</code>æ–¹æ³•æ¥æ”¶ä¸‰ä¸ªå‚æ•°ï¼š</p>
<ol>
<li><code>ClassLoader</code>ï¼šç”¨äºåŠ è½½åŠ¨æ€ç”Ÿæˆçš„ä»£ç†ç±»çš„ç±»åŠ è½½å™¨ã€‚</li>
<li><code>Class[] interfaces</code>ï¼šä»£ç†ç±»è¦å®ç°çš„æ¥å£æ•°ç»„ï¼Œä»£ç†å¯¹è±¡å°†å®ç°è¿™äº›æ¥å£ã€‚</li>
<li><code>InvocationHandler</code>ï¼šä»£ç†å¯¹è±¡çš„è°ƒç”¨å¤„ç†ç¨‹åºï¼Œå®ƒå®šä¹‰äº†ä»£ç†å¯¹è±¡åœ¨æ‰§è¡Œæ–¹æ³•æ—¶çš„è¡Œä¸ºã€‚</li>
</ol>
<p>ä»¥ä¸‹æ˜¯ä¸€ä¸ªä½¿ç”¨JDKåŠ¨æ€ä»£ç†çš„ç®€å•ç¤ºä¾‹ï¼š</p>
<ol>
<li>å®šä¹‰æŠ½è±¡ä¸»é¢˜æ¥å£ï¼ˆSubjectï¼‰ï¼š</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// Subject.java</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">Subject</span> &#123;<br>    <span class="hljs-keyword">void</span> <span class="hljs-title function_">doSomething</span><span class="hljs-params">()</span>;<br>&#125;<br></code></pre></td></tr></table></figure>

<ol start="2">
<li>å®šä¹‰çœŸå®ä¸»é¢˜ç±»ï¼ˆRealSubjectï¼‰ï¼š</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// RealSubject.java</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">RealSubject</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Subject</span> &#123;<br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">doSomething</span><span class="hljs-params">()</span> &#123;<br>        System.out.println(<span class="hljs-string">&quot;RealSubject is doing something...&quot;</span>);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<ol start="3">
<li>å®šä¹‰ä»£ç†å¤„ç†ç¨‹åºï¼ˆMyInvocationHandlerï¼‰ï¼š</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// MyInvocationHandler.java</span><br><span class="hljs-keyword">import</span> java.lang.reflect.InvocationHandler;<br><span class="hljs-keyword">import</span> java.lang.reflect.Method;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MyInvocationHandler</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">InvocationHandler</span> &#123;<br>    <span class="hljs-keyword">private</span> Object realSubject;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">MyInvocationHandler</span><span class="hljs-params">(Object realSubject)</span> &#123;<br>        <span class="hljs-built_in">this</span>.realSubject = realSubject;<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> Object <span class="hljs-title function_">invoke</span><span class="hljs-params">(Object proxy, Method method, Object[] args)</span> <span class="hljs-keyword">throws</span> Throwable &#123;<br>        System.out.println(<span class="hljs-string">&quot;Proxy is doing something before the RealSubject...&quot;</span>);<br>        <span class="hljs-type">Object</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> method.invoke(realSubject, args);<br>        System.out.println(<span class="hljs-string">&quot;Proxy is doing something after the RealSubject...&quot;</span>);<br>        <span class="hljs-keyword">return</span> result;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<ol start="4">
<li>å®¢æˆ·ç«¯ä»£ç ï¼š</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// Client.java</span><br><span class="hljs-keyword">import</span> java.lang.reflect.Proxy;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Client</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br>        <span class="hljs-comment">// åˆ›å»ºçœŸå®ä¸»é¢˜å¯¹è±¡</span><br>        <span class="hljs-type">Subject</span> <span class="hljs-variable">realSubject</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RealSubject</span>();<br><br>        <span class="hljs-comment">// åˆ›å»ºä»£ç†å¤„ç†ç¨‹åº</span><br>        <span class="hljs-type">MyInvocationHandler</span> <span class="hljs-variable">handler</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">MyInvocationHandler</span>(realSubject);<br>        <span class="hljs-comment">// è·å–å¯¹åº”çš„ ClassLoader</span><br>        <span class="hljs-type">ClassLoader</span> <span class="hljs-variable">classLoader</span> <span class="hljs-operator">=</span> realSubject.getClass().getClassLoader();<br>        <span class="hljs-comment">// è·å–æ‰€æœ‰æ¥å£çš„Classï¼Œè¿™é‡Œçš„UserServiceImplåªå®ç°äº†ä¸€ä¸ªæ¥å£UserService</span><br>        Class[] interfaces = realSubject.getClass().getInterfaces()<br><br>        <span class="hljs-comment">// åˆ›å»ºä»£ç†å¯¹è±¡</span><br>        <span class="hljs-type">Subject</span> <span class="hljs-variable">proxy</span> <span class="hljs-operator">=</span> (Subject) Proxy.newProxyInstance(<br>                classLoader,<br>                interfaces,<br>                handler);<br><br>        <span class="hljs-comment">// ä½¿ç”¨ä»£ç†å¯¹è±¡</span><br>        proxy.doSomething();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>è¾“å‡ºç»“æœï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs java">Proxy is doing something before the RealSubject...<br>RealSubject is doing something...<br>Proxy is doing something after the RealSubject...<br></code></pre></td></tr></table></figure>

<p>åœ¨ä¸Šé¢çš„ç¤ºä¾‹ä¸­ï¼Œæˆ‘ä»¬é€šè¿‡ <code>Proxy.newProxyInstance()</code> æ–¹æ³•åˆ›å»ºäº†ä¸€ä¸ªä»£ç†å¯¹è±¡ï¼Œè¯¥ä»£ç†å¯¹è±¡å®ç°äº†<code>Subject</code>æ¥å£ï¼Œå¹¶åœ¨è°ƒç”¨æ–¹æ³•æ—¶é€šè¿‡ <code>MyInvocationHandler</code> ä¸­å®šä¹‰çš„é€»è¾‘æ¥è¿›è¡Œå¢å¼ºæ“ä½œã€‚è¿™æ ·ï¼Œæˆ‘ä»¬å°±å®ç°äº†ä¸€ä¸ªåŸºäºJDKåŠ¨æ€ä»£ç†çš„ç®€å•ä»£ç†åŠŸèƒ½</p>
<h5 id="JDKåŠ¨æ€ä»£ç†åˆ†æ"><a href="#JDKåŠ¨æ€ä»£ç†åˆ†æ" class="headerlink" title="JDKåŠ¨æ€ä»£ç†åˆ†æ"></a>JDKåŠ¨æ€ä»£ç†åˆ†æ</h5><p><code> Proxy.newProxyInstance(ClassLoader loader, Class&lt;?&gt;[] interfaces,InvocationHandler h)</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Object <span class="hljs-title function_">newProxyInstance</span><span class="hljs-params">(ClassLoader loader,</span><br><span class="hljs-params">                                      Class&lt;?&gt;[] interfaces,</span><br><span class="hljs-params">                                      InvocationHandler h)</span> &#123;<br>    Objects.requireNonNull(h);<br><br>    <span class="hljs-keyword">final</span> Class&lt;?&gt;[] intfs = interfaces.clone();<br>    <span class="hljs-comment">// æŸ¥è¯¢ï¼ˆåœ¨ç¼“å­˜ä¸­å·²ç»æœ‰ï¼‰æˆ–ç”ŸæˆæŒ‡å®šçš„ä»£ç†ç±»çš„classå¯¹è±¡ã€‚</span><br>    Class&lt;?&gt; cl = getProxyClass0(loader, intfs);<br><br>    <span class="hljs-keyword">try</span> &#123;<br>        <span class="hljs-keyword">if</span> (sm != <span class="hljs-literal">null</span>) &#123;<br>            checkNewProxyPermission(Reflection.getCallerClass(), cl);<br>        &#125;<br>        <span class="hljs-comment">// è¿”å›å¯¹åº”å‚æ•°çš„å…¬å…±æ„é€ å‡½æ•°</span><br>        <span class="hljs-keyword">final</span> Constructor&lt;?&gt; cons = cl.getConstructor(constructorParams);<br>        <span class="hljs-keyword">final</span> <span class="hljs-type">InvocationHandler</span> <span class="hljs-variable">ih</span> <span class="hljs-operator">=</span> h;<br>        <span class="hljs-keyword">if</span> (!Modifier.isPublic(cl.getModifiers())) &#123;<br>            AccessController.doPrivileged(<span class="hljs-keyword">new</span> <span class="hljs-title class_">PrivilegedAction</span>&lt;Void&gt;() &#123;<br>                <span class="hljs-keyword">public</span> Void <span class="hljs-title function_">run</span><span class="hljs-params">()</span> &#123;<br>                    cons.setAccessible(<span class="hljs-literal">true</span>);<br>                    <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>                &#125;<br>            &#125;);<br>        &#125;<br>        <span class="hljs-comment">// ç”Ÿæˆä»£ç†å¯¹è±¡</span><br>        <span class="hljs-keyword">return</span> cons.newInstance(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[]&#123;h&#125;);<br>    &#125;   <br>    ... <span class="hljs-comment">// çœç•¥</span><br>&#125;<br></code></pre></td></tr></table></figure>

<p>æœ€åæ¥åˆ° <code>ProxyClassFactory</code> çš„ <code>apply()</code> æ–¹æ³•ï¼Œä»£ç†ç±»å°±æ˜¯åœ¨è¿™é‡Œç”Ÿæˆçš„</p>
<h5 id="CGLibåŠ¨æ€ä»£ç†"><a href="#CGLibåŠ¨æ€ä»£ç†" class="headerlink" title="CGLibåŠ¨æ€ä»£ç†"></a>CGLibåŠ¨æ€ä»£ç†</h5><p>CGLibåŠ¨æ€ä»£ç†æ˜¯å¦ä¸€ç§å®ç°åŠ¨æ€ä»£ç†çš„æ–¹å¼ï¼Œå®ƒä¸JDKåŠ¨æ€ä»£ç†ä¸åŒï¼Œä¸åŸºäºæ¥å£ï¼Œè€Œæ˜¯å¯¹ç±»è¿›è¡Œä»£ç†ã€‚CGLibæ˜¯ä¸€ä¸ªå¼ºå¤§çš„ä»£ç ç”Ÿæˆåº“ï¼Œå®ƒèƒ½å¤Ÿåœ¨è¿è¡Œæ—¶æ‰©å±•Javaç±»å’Œå®ç°ä»£ç†åŠŸèƒ½ã€‚CGLibåŠ¨æ€ä»£ç†çš„åŸç†æ˜¯é€šè¿‡ç”Ÿæˆç›®æ ‡ç±»çš„å­ç±»æ¥å®ç°ä»£ç†ï¼Œå› æ­¤è¢«ä»£ç†çš„ç±»ä¸èƒ½æ˜¯finalç±»ï¼Œä¸”ä»£ç†çš„æ–¹æ³•ä¸èƒ½æ˜¯finalæˆ–staticçš„ã€‚ä¸¤è€…çš„åŒºåˆ«æœ‰ä»¥ä¸‹å‡ ç‚¹ï¼š</p>
<ol>
<li>JavaåŠ¨æ€ä»£ç†åªèƒ½å¤Ÿå¯¹æ¥å£è¿›è¡Œä»£ç†ï¼Œä¸èƒ½å¯¹æ™®é€šçš„ç±»è¿›è¡Œä»£ç†ï¼ˆå› ä¸ºæ‰€æœ‰ç”Ÿæˆçš„ä»£ç†ç±»çš„çˆ¶ç±»ä¸ºProxyï¼ŒJavaç±»ç»§æ‰¿æœºåˆ¶ä¸å…è®¸å¤šé‡ç»§æ‰¿ï¼‰ï¼›CGLIBèƒ½å¤Ÿä»£ç†æ™®é€šç±»ã€‚</li>
<li>JavaåŠ¨æ€ä»£ç†ä½¿ç”¨JavaåŸç”Ÿçš„åå°„APIè¿›è¡Œæ“ä½œï¼Œåœ¨ç”Ÿæˆç±»ä¸Šæ¯”è¾ƒé«˜æ•ˆï¼›CGLIB ä½¿ç”¨ASMæ¡†æ¶ç›´æ¥å¯¹å­—èŠ‚ç è¿›è¡Œæ“ä½œï¼Œåœ¨ç±»çš„æ‰§è¡Œè¿‡ç¨‹ä¸­æ¯”è¾ƒé«˜æ•ˆã€‚</li>
</ol>
<p>CGLibåŠ¨æ€ä»£ç†çš„æ ¸å¿ƒç±»æ˜¯ <code>net.sf.cglib.proxy.Enhancer</code>ï¼Œå®ƒæ˜¯CGLibåº“ä¸­çš„ä»£ç†å¢å¼ºç±»ï¼Œç”¨äºç”Ÿæˆä»£ç†ç±»çš„å®ä¾‹ã€‚ä½¿ç”¨CGLibåŠ¨æ€ä»£ç†éœ€è¦ä¾èµ–CGLibåº“ã€‚</p>
<p>ä»¥ä¸‹æ˜¯ä¸€ä¸ªä½¿ç”¨CGLibåŠ¨æ€ä»£ç†çš„ç®€å•ç¤ºä¾‹ï¼š</p>
<ol>
<li>å®šä¹‰ç›®æ ‡ç±»ï¼ˆ<code>RealSubject</code>ï¼‰ï¼š</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// RealSubject.java</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">RealSubject</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">doSomething</span><span class="hljs-params">()</span> &#123;<br>        System.out.println(<span class="hljs-string">&quot;RealSubject is doing something...&quot;</span>);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<ol start="2">
<li>å®šä¹‰ä»£ç†å¤„ç†ç¨‹åºï¼ˆ<code>MyMethodInterceptor</code>ï¼‰ï¼š</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// MyMethodInterceptor.java</span><br><span class="hljs-keyword">import</span> net.sf.cglib.proxy.MethodInterceptor;<br><span class="hljs-keyword">import</span> net.sf.cglib.proxy.MethodProxy;<br><span class="hljs-keyword">import</span> java.lang.reflect.Method;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MyMethodInterceptor</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">MethodInterceptor</span> &#123;<br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> Object <span class="hljs-title function_">intercept</span><span class="hljs-params">(Object obj, Method method, Object[] args, MethodProxy proxy)</span> <span class="hljs-keyword">throws</span> Throwable &#123;<br>        <span class="hljs-comment">// before</span><br>        System.out.println(<span class="hljs-string">&quot;Proxy is doing something before the RealSubject...&quot;</span>);<br>        <span class="hljs-type">Object</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> proxy.invokeSuper(obj, args);<br>        <span class="hljs-comment">// after</span><br>        System.out.println(<span class="hljs-string">&quot;Proxy is doing something after the RealSubject...&quot;</span>);<br>        <span class="hljs-keyword">return</span> result;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p><code>intercept</code>æ–¹æ³•å››ä¸ªå‚æ•°çš„å«ä¹‰å¦‚ä¸‹ï¼š <code>obj</code>: ä»£ç†ç±»å¯¹è±¡ã€‚ <code>method</code>: è¢«ä»£ç†çš„ç±»ä¸­çš„æ–¹æ³•ã€‚ <code>args</code>: è°ƒç”¨æ–¹æ³•éœ€è¦çš„å‚æ•°ã€‚ <code>proxy</code>: ç”Ÿæˆçš„ä»£ç†ç±»å¯¹æ–¹æ³•çš„<strong>ä»£ç†å¼•ç”¨</strong></p>
<p>ç”¨æˆ·éœ€è¦å®ç°<code>MethodInterceptor</code>æ¥å£ï¼Œå®ç°å¯¹æ–¹æ³•çš„æ‹¦æˆªã€‚è¿™ä¸€ç‚¹ä¸JDKåŠ¨æ€ä»£ç†ä¸­ç”¨æˆ·éœ€è¦å®ç°<code>InvocationHandler</code>æ¥å£ç±»ä¼¼</p>
<ol start="3">
<li>å®¢æˆ·ç«¯ä»£ç ï¼š</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// Client.java</span><br><span class="hljs-keyword">import</span> net.sf.cglib.proxy.Enhancer;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Client</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br>        <span class="hljs-comment">// åˆ›å»ºä»£ç†å¤„ç†ç¨‹åº</span><br>        <span class="hljs-type">MyMethodInterceptor</span> <span class="hljs-variable">interceptor</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">MyMethodInterceptor</span>();<br><br>        <span class="hljs-comment">// ä½¿ç”¨Enhanceråˆ›å»ºä»£ç†å¯¹è±¡</span><br>        <span class="hljs-type">Enhancer</span> <span class="hljs-variable">enhancer</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Enhancer</span>();<br>        <span class="hljs-comment">// è®¾ç½®ç»§æ‰¿è¢«ä»£ç†ç±»</span><br>        enhancer.setSuperclass(RealSubject.class);<br>        <span class="hljs-comment">// è®¾ç½®å›è°ƒ</span><br>        enhancer.setCallback(interceptor);<br>        <span class="hljs-type">RealSubject</span> <span class="hljs-variable">proxy</span> <span class="hljs-operator">=</span> (RealSubject) enhancer.create();<br><br>        <span class="hljs-comment">// ä½¿ç”¨ä»£ç†å¯¹è±¡</span><br>        proxy.doSomething();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>è¾“å‡ºç»“æœï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs java">Proxy is doing something before the RealSubject...<br>RealSubject is doing something...<br>Proxy is doing something after the RealSubject...<br></code></pre></td></tr></table></figure>

<p>åœ¨ä¸Šé¢çš„ç¤ºä¾‹ä¸­ä½¿ç”¨CGLibçš„ <code>Enhancer</code> ç±»æ¥åˆ›å»ºäº†ä¸€ä¸ªä»£ç†å¯¹è±¡ï¼Œè¯¥ä»£ç†å¯¹è±¡ç»§æ‰¿äº† <code>RealSubject</code> ç±»ï¼Œå¹¶åœ¨è°ƒç”¨æ–¹æ³•æ—¶é€šè¿‡ <code>MyMethodInterceptor</code> ä¸­å®šä¹‰çš„é€»è¾‘æ¥è¿›è¡Œå¢å¼ºæ“ä½œã€‚è¿™æ ·å°±å®ç°äº†ä¸€ä¸ªåŸºäºCGLibåŠ¨æ€ä»£ç†çš„ç®€å•ä»£ç†åŠŸèƒ½</p>
<p>éœ€è¦æ³¨æ„çš„æ˜¯ï¼ŒCGLibåŠ¨æ€ä»£ç†ç›¸æ¯”äºJDKåŠ¨æ€ä»£ç†çš„ä¼˜ç‚¹åœ¨äºå®ƒå¯ä»¥ä»£ç†æ²¡æœ‰å®ç°æ¥å£çš„ç±»ï¼Œè€Œä¸”åœ¨ä¸€äº›åœºæ™¯ä¸‹ç”±äºç»§æ‰¿çš„æ–¹å¼ï¼Œå¯ä»¥æ›´é«˜æ•ˆåœ°æ‰§è¡Œä»£ç†ã€‚ç„¶è€Œï¼ŒCGLibåŠ¨æ€ä»£ç†ä¹Ÿæœ‰ä¸€äº›é™åˆ¶ï¼Œä¾‹å¦‚æ— æ³•ä»£ç† <code>final</code> ç±»å’Œ <code>final</code> æ–¹æ³•</p>
<h5 id="CGLibåŠ¨æ€ä»£ç†åˆ†æ"><a href="#CGLibåŠ¨æ€ä»£ç†åˆ†æ" class="headerlink" title="CGLibåŠ¨æ€ä»£ç†åˆ†æ"></a>CGLibåŠ¨æ€ä»£ç†åˆ†æ</h5><p><strong>ç”ŸæˆæŒ‡å®šç±»Classå¯¹è±¡å­—èŠ‚æ•°ç»„</strong>ï¼ŒCGLibåŠ¨æ€ä»£ç†ä¼šé€‰æ‹©ç›®æ ‡ç±»ï¼ˆè¢«ä»£ç†ç±»ï¼‰ä½œä¸ºçˆ¶ç±»ï¼Œç„¶åç”Ÿæˆä»£ç†ç±»çš„å­—èŠ‚ç â€”â€”é¦–å…ˆåˆ›å»º<code>Enhancer</code>å¯¹è±¡ï¼Œè®¾ç½®<code>SuperClass</code>çˆ¶ç±»ï¼ˆè¢«ä»£ç†ç±»ï¼‰ï¼Œç„¶åè°ƒç”¨<code>Enhancer</code>å¯¹è±¡çš„<code>create()</code>æ–¹æ³•</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> Object <span class="hljs-title function_">create</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-built_in">this</span>.classOnly = <span class="hljs-literal">false</span>;<br>    <span class="hljs-built_in">this</span>.argumentTypes = <span class="hljs-literal">null</span>;<br>    <span class="hljs-keyword">return</span> <span class="hljs-built_in">this</span>.createHelper();<br>&#125;<br><br><span class="hljs-keyword">private</span> Object <span class="hljs-title function_">createHelper</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-comment">//1.è¿›è¡Œæœ‰æ•ˆæ€§éªŒè¯</span><br>  <span class="hljs-comment">//1.1 callBackä¸èƒ½ä¸ºç©ºï¼Œä¹Ÿå°±æ˜¯è¯´è‡³å°‘è¦æœ‰ä¸€ä¸ªcallBack(callBackä¸ä»£ç†ç±»ç´§å¯†ç›¸å…³)</span><br>  <span class="hljs-comment">//1.2 æœ‰å¤šä¸ªcallBackæ—¶å¿…é¡»æœ‰callBackFilter</span><br>    <span class="hljs-built_in">this</span>.preValidate();<br>    <span class="hljs-comment">//2.å…ˆæ ¹æ®KEY_FACTORY ä»¥å½“å‰ä»£ç†ç±»çš„é…ç½®ä¿¡æ¯ ç”Ÿæˆä¸€ä¸ªç»„åˆKeyï¼Œå†åˆ©ç”¨è¿™ä¸ªç»„åˆKeyï¼Œè¿›è¡Œcreate</span><br>    <span class="hljs-type">Object</span> <span class="hljs-variable">key</span> <span class="hljs-operator">=</span> KEY_FACTORY.newInstance(<span class="hljs-built_in">this</span>.superclass != <span class="hljs-literal">null</span> ? <span class="hljs-built_in">this</span>.superclass.getName() : <span class="hljs-literal">null</span>, <br>                 ReflectUtils.getNames(<span class="hljs-built_in">this</span>.interfaces), <br>                 <span class="hljs-built_in">this</span>.filter == ALL_ZERO ? <span class="hljs-literal">null</span> : <span class="hljs-keyword">new</span> <span class="hljs-title class_">WeakCacheKey</span>(<span class="hljs-built_in">this</span>.filter),                  <br>                 <span class="hljs-built_in">this</span>.callbackTypes, <br>                 <span class="hljs-built_in">this</span>.useFactory, <br>                 <span class="hljs-built_in">this</span>.interceptDuringConstruction, <br>                 <span class="hljs-built_in">this</span>.serialVersionUID);<br>    <span class="hljs-built_in">this</span>.currentKey = key;<br>    <span class="hljs-comment">//æ ¹æ®ç”Ÿæˆçš„keyåˆ›å»ºä»£ç†å¯¹è±¡</span><br>    <span class="hljs-type">Object</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> <span class="hljs-built_in">super</span>.create(key);<br>    <span class="hljs-keyword">return</span> result;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>ç„¶ååˆ°äº† Enhance ç»§æ‰¿çš„ AbstractClassGenerator ç±»ä¸­çš„ create() æ–¹æ³•ï¼Œè¿™ä¸€æ­¥å°±æ˜¯ä¸ºäº†å¾—åˆ°åŠ¨æ€ç±»çš„Classå¯¹è±¡ï¼Œä¹‹åé€šè¿‡<strong>åå°„</strong>ç”Ÿæˆå…·ä½“çš„ç±»çš„å¯¹è±¡</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">protected</span> Object <span class="hljs-title function_">create</span><span class="hljs-params">(Object key)</span> &#123;<br>    <span class="hljs-keyword">try</span> &#123;<br>        <span class="hljs-comment">//1.è·å–å½“å‰ç±»åŠ è½½å™¨ï¼Œåº”ç”¨ç±»åŠ è½½å™¨</span><br>        <span class="hljs-type">ClassLoader</span> <span class="hljs-variable">loader</span> <span class="hljs-operator">=</span> <span class="hljs-built_in">this</span>.getClassLoader();<br>        <span class="hljs-comment">//2.ç¼“å­˜ï¼Œä¸€çº§ç¼“å­˜çš„keyæ˜¯ç±»åŠ è½½å™¨,valueæ˜¯ClassLoaderData</span><br>     <span class="hljs-comment">//2.1 cacheä¸­æœ‰åˆ™ç›´æ¥è·å–</span><br>        Map&lt;ClassLoader, ClassLoaderData&gt; cache = CACHE;<br>        <span class="hljs-type">ClassLoaderData</span> <span class="hljs-variable">data</span> <span class="hljs-operator">=</span> (ClassLoaderData)cache.get(loader);<br>        <span class="hljs-comment">//2.2 cacheä¸­æ²¡æœ‰åˆ™ç”Ÿæˆï¼ŒåŒé‡æ£€æŸ¥ğŸ”’</span><br>        <span class="hljs-keyword">if</span> (data == <span class="hljs-literal">null</span>) &#123;<br>            <span class="hljs-type">Class</span> <span class="hljs-variable">var5</span> <span class="hljs-operator">=</span> AbstractClassGenerator.class;<br>            <span class="hljs-keyword">synchronized</span>(AbstractClassGenerator.class) &#123;<br>                cache = CACHE;<br>                data = (ClassLoaderData)cache.get(loader);<br>                <span class="hljs-keyword">if</span> (data == <span class="hljs-literal">null</span>) &#123;<br>                    Map&lt;ClassLoader, ClassLoaderData&gt; newCache = <span class="hljs-keyword">new</span> <span class="hljs-title class_">WeakHashMap</span>(cache);<br>                    data = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ClassLoaderData</span>(loader);<br>                    newCache.put(loader, data);<br>                    CACHE = newCache;<br>                &#125;<br>            &#125;<br>        &#125;<br>        <span class="hljs-built_in">this</span>.key = key;<br>        <span class="hljs-comment">//3.è°ƒç”¨ getæ–¹æ³•è·å–å­—èŠ‚ç ï¼Œå¦‚æœæ²¡æœ‰å­—èŠ‚ç ï¼Œåˆ™ä¼šåˆ›å»ºå­—èŠ‚ç ï¼ˆClasså¯¹è±¡ï¼‰</span><br>        <span class="hljs-type">Object</span> <span class="hljs-variable">obj</span> <span class="hljs-operator">=</span> data.get(<span class="hljs-built_in">this</span>, <span class="hljs-built_in">this</span>.getUseCache());<br>        <span class="hljs-comment">//4.ç”ŸæˆåŠ¨æ€ä»£ç†ç±»</span><br>        <span class="hljs-keyword">return</span> obj <span class="hljs-keyword">instanceof</span> Class ? <span class="hljs-built_in">this</span>.firstInstance((Class)obj) : <span class="hljs-built_in">this</span>.nextInstance(obj);<br>    &#125; <span class="hljs-keyword">catch</span> (Error | RuntimeException var9) &#123;<br>        <span class="hljs-keyword">throw</span> var9;<br>    &#125; <span class="hljs-keyword">catch</span> (Exception var10) &#123;<br>        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">CodeGenerationException</span>(var10);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>ClassLoaderData.get() æ–¹æ³•</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> Object <span class="hljs-title function_">get</span><span class="hljs-params">(AbstractClassGenerator gen, <span class="hljs-type">boolean</span> useCache)</span> &#123;<br>    <span class="hljs-comment">//åˆ¤æ–­æ˜¯å¦å¼€å¯ç¼“å­˜ï¼Œå¯ç›´æ¥è®¾ç½®ï¼šenhancer.setUseCache(false); é»˜è®¤ä¸ºtrue</span><br>    <span class="hljs-keyword">if</span> (!useCache) &#123;<br>        <span class="hljs-keyword">return</span> gen.generate(<span class="hljs-built_in">this</span>);<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>        <span class="hljs-type">Object</span> <span class="hljs-variable">cachedValue</span> <span class="hljs-operator">=</span> <span class="hljs-built_in">this</span>.generatedClasses.get(gen);<br>        <span class="hljs-keyword">return</span> gen.unwrapCachedValue(cachedValue);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>è¿›åˆ° AbstractClassGenerator çš„ generate() æ–¹æ³•</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">protected</span> Class <span class="hljs-title function_">generate</span><span class="hljs-params">(ClassLoaderData data)</span> &#123;<br>		Class gen;<br>		<span class="hljs-type">Object</span> <span class="hljs-variable">save</span> <span class="hljs-operator">=</span> CURRENT.get();<br>		CURRENT.set(<span class="hljs-built_in">this</span>);<br>		<span class="hljs-keyword">try</span> &#123;<br>      <span class="hljs-comment">// 1.åˆ¤æ–­æœ‰æ— classLoader</span><br>			<span class="hljs-type">ClassLoader</span> <span class="hljs-variable">classLoader</span> <span class="hljs-operator">=</span> data.getClassLoader();<br>			<span class="hljs-keyword">if</span> (classLoader == <span class="hljs-literal">null</span>) &#123;<br>				<span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">IllegalStateException</span>(<span class="hljs-string">&quot;ClassLoader is null while trying to define class &quot;</span> +<br>						getClassName() + <span class="hljs-string">&quot;. It seems that the loader has been expired from a weak reference somehow. &quot;</span> +<br>						<span class="hljs-string">&quot;Please file an issue at cglib&#x27;s issue tracker.&quot;</span>);<br>			&#125;<br>      <span class="hljs-comment">// 2.ç”ŸæˆåŠ¨æ€ä»£ç†çš„ç±»å</span><br>			<span class="hljs-keyword">synchronized</span> (classLoader) &#123;<br>        <span class="hljs-comment">// ç”Ÿæˆä»£ç†ç±»åç§°</span><br>				<span class="hljs-type">String</span> <span class="hljs-variable">name</span> <span class="hljs-operator">=</span> generateClassName(data.getUniqueNamePredicate());<br>				data.reserveName(name);<br>				<span class="hljs-built_in">this</span>.setClassName(name);<br>			&#125;<br>			<span class="hljs-keyword">if</span> (attemptLoad) &#123;<br>				<span class="hljs-keyword">try</span> &#123;<br>					gen = classLoader.loadClass(getClassName());<br>					<span class="hljs-keyword">return</span> gen;<br>				&#125;<br>				<span class="hljs-keyword">catch</span> (ClassNotFoundException e) &#123;<br>					<span class="hljs-comment">// ignore</span><br>				&#125;<br>			&#125;<br>      <span class="hljs-comment">// 3.ç”ŸæˆåŠ¨æ€ä»£ç†ç±»çš„å­—èŠ‚ç </span><br>			<span class="hljs-type">byte</span>[] b = strategy.generate(<span class="hljs-built_in">this</span>);<br>			<span class="hljs-type">String</span> <span class="hljs-variable">className</span> <span class="hljs-operator">=</span> ClassNameReader.getClassName(<span class="hljs-keyword">new</span> <span class="hljs-title class_">ClassReader</span>(b));<br>			<span class="hljs-type">ProtectionDomain</span> <span class="hljs-variable">protectionDomain</span> <span class="hljs-operator">=</span> getProtectionDomain();<br>      <span class="hljs-comment">// 4.ç”Ÿæˆclassæ–‡ä»¶</span><br>			<span class="hljs-keyword">synchronized</span> (classLoader) &#123; <span class="hljs-comment">// just in case</span><br>				<span class="hljs-comment">// SPRING PATCH BEGIN</span><br>				gen = ReflectUtils.defineClass(className, b, classLoader, protectionDomain, contextClass);<br>				<span class="hljs-comment">// SPRING PATCH END</span><br>			&#125;<br>			<span class="hljs-keyword">return</span> gen;<br>		&#125;<br>		<span class="hljs-keyword">catch</span> (RuntimeException | Error ex) &#123;<br>			<span class="hljs-keyword">throw</span> ex;<br>		&#125;<br>		<span class="hljs-keyword">catch</span> (Exception ex) &#123;<br>			<span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">CodeGenerationException</span>(ex);<br>		&#125;<br>		<span class="hljs-keyword">finally</span> &#123;<br>			CURRENT.set(save);<br>		&#125;<br>	&#125;<br></code></pre></td></tr></table></figure>

<p>è¿™é‡Œç¬¬ä¸‰æ­¥çš„ strategy.generate() æ–¹æ³•æ˜¯ DefaultGeneratorStrategy ä¸­çš„æ–¹æ³•</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">DefaultGeneratorStrategy</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">GeneratorStrategy</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">DefaultGeneratorStrategy</span> <span class="hljs-variable">INSTANCE</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">DefaultGeneratorStrategy</span>();<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">DefaultGeneratorStrategy</span><span class="hljs-params">()</span> &#123;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-type">byte</span>[] generate(ClassGenerator cg) <span class="hljs-keyword">throws</span> Exception &#123;<br>        <span class="hljs-type">DebuggingClassWriter</span> <span class="hljs-variable">cw</span> <span class="hljs-operator">=</span> <span class="hljs-built_in">this</span>.getClassVisitor();<br>        <span class="hljs-built_in">this</span>.transform(cg).generateClass(cw);<br>        <span class="hljs-keyword">return</span> <span class="hljs-built_in">this</span>.transform(cw.toByteArray());<br>    &#125;<br>    ...<span class="hljs-comment">// çœç•¥</span><br>&#125;<br></code></pre></td></tr></table></figure>

<p>è¿™é‡Œçš„ <code>getClassVistor</code> è°ƒç”¨äº†asmçš„æ¥å£ï¼Œç”Ÿæˆäº†ä¸€ä¸ª <code>DebuggingClassWriter</code> å¯¹è±¡ï¼Œè¿™é‡Œçš„cgå°±æ˜¯ä¹‹å‰çš„ <code>Enhancer</code> å®ä¾‹ï¼Œç‚¹è¿› <code>generateClass()</code> æ–¹æ³•ï¼Œåˆå›åˆ° <code>Enhance</code> ç±»ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">generateClass</span><span class="hljs-params">(ClassVisitor v)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>		<span class="hljs-type">Class</span> <span class="hljs-variable">sc</span> <span class="hljs-operator">=</span> (superclass == <span class="hljs-literal">null</span>) ? Object.class : superclass;<br><br>		<span class="hljs-keyword">if</span> (TypeUtils.isFinal(sc.getModifiers()))<br>			<span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">IllegalArgumentException</span>(<span class="hljs-string">&quot;Cannot subclass final class &quot;</span> + sc.getName());<br>		<span class="hljs-type">List</span> <span class="hljs-variable">constructors</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>(Arrays.asList(sc.getDeclaredConstructors()));<br>		filterConstructors(sc, constructors);<br><br>		<span class="hljs-comment">// Order is very important: must add superclass, then</span><br>		<span class="hljs-comment">// its superclass chain, then each interface and</span><br>		<span class="hljs-comment">// its superinterfaces.</span><br>		<span class="hljs-type">List</span> <span class="hljs-variable">actualMethods</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>();<br>		<span class="hljs-type">List</span> <span class="hljs-variable">interfaceMethods</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>();<br>		<span class="hljs-keyword">final</span> <span class="hljs-type">Set</span> <span class="hljs-variable">forcePublic</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashSet</span>();<br>    <span class="hljs-comment">// 1.å¾—åˆ°æ‰€æœ‰çš„æ–¹æ³•ï¼ŒåŒ…æ‹¬åŸºç±»ã€æ¥å£</span><br>		getMethods(sc, interfaces, actualMethods, interfaceMethods, forcePublic);<br><br>		<span class="hljs-type">List</span> <span class="hljs-variable">methods</span> <span class="hljs-operator">=</span> CollectionUtils.transform(actualMethods, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Transformer</span>() &#123;<br>			<span class="hljs-keyword">public</span> Object <span class="hljs-title function_">transform</span><span class="hljs-params">(Object value)</span> &#123;<br>				<span class="hljs-type">Method</span> <span class="hljs-variable">method</span> <span class="hljs-operator">=</span> (Method) value;<br>				<span class="hljs-type">int</span> <span class="hljs-variable">modifiers</span> <span class="hljs-operator">=</span> Constants.ACC_FINAL<br>						| (method.getModifiers()<br>						&amp; ~Constants.ACC_ABSTRACT<br>						&amp; ~Constants.ACC_NATIVE<br>						&amp; ~Constants.ACC_SYNCHRONIZED);<br>				<span class="hljs-keyword">if</span> (forcePublic.contains(MethodWrapper.create(method))) &#123;<br>					modifiers = (modifiers &amp; ~Constants.ACC_PROTECTED) | Constants.ACC_PUBLIC;<br>				&#125;<br>				<span class="hljs-keyword">return</span> ReflectUtils.getMethodInfo(method, modifiers);<br>			&#125;<br>		&#125;);<br>    <span class="hljs-comment">// 2.ç”Ÿæˆå­—èŠ‚ç ï¼Œå‚æ•°è¿˜æ˜¯ä¹‹å‰çš„classWriter</span><br>		<span class="hljs-comment">// 2.1 è¿™é‡Œçš„classNameå°±æ˜¯ä¹‹å‰ç”Ÿæˆçš„className</span><br>		<span class="hljs-type">ClassEmitter</span> <span class="hljs-variable">e</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ClassEmitter</span>(v);<br>		<span class="hljs-keyword">if</span> (currentData == <span class="hljs-literal">null</span>) &#123;<br>			e.begin_class(Constants.V1_8,<br>					Constants.ACC_PUBLIC,<br>					getClassName(),<br>					Type.getType(sc),<br>					(useFactory ?<br>							TypeUtils.add(TypeUtils.getTypes(interfaces), FACTORY) :<br>							TypeUtils.getTypes(interfaces)),<br>					Constants.SOURCE_FILE);<br>		&#125;<br>		<span class="hljs-keyword">else</span> &#123;<br>			e.begin_class(Constants.V1_8,<br>					Constants.ACC_PUBLIC,<br>					getClassName(),<br>					<span class="hljs-literal">null</span>,<br>					<span class="hljs-keyword">new</span> <span class="hljs-title class_">Type</span>[]&#123;FACTORY&#125;,<br>					Constants.SOURCE_FILE);<br>		&#125;<br>		<span class="hljs-type">List</span> <span class="hljs-variable">constructorInfo</span> <span class="hljs-operator">=</span> CollectionUtils.transform(constructors, MethodInfoTransformer.getInstance());<br>    <span class="hljs-comment">// 2.2 è¿™äº›éƒ½æ˜¯å­—æ®µï¼Œä¹‹åæˆ‘ä»¬ä¼šåœ¨ç”Ÿæˆçš„æ–‡ä»¶ä¸­çœ‹åˆ°</span><br>		e.declare_field(Constants.ACC_PRIVATE, BOUND_FIELD, Type.BOOLEAN_TYPE, <span class="hljs-literal">null</span>);<br>		e.declare_field(Constants.ACC_PUBLIC | Constants.ACC_STATIC, FACTORY_DATA_FIELD, OBJECT_TYPE, <span class="hljs-literal">null</span>);<br>		<span class="hljs-keyword">if</span> (!interceptDuringConstruction) &#123;<br>			e.declare_field(Constants.ACC_PRIVATE, CONSTRUCTED_FIELD, Type.BOOLEAN_TYPE, <span class="hljs-literal">null</span>);<br>		&#125;<br>		e.declare_field(Constants.PRIVATE_FINAL_STATIC, THREAD_CALLBACKS_FIELD, THREAD_LOCAL, <span class="hljs-literal">null</span>);<br>		e.declare_field(Constants.PRIVATE_FINAL_STATIC, STATIC_CALLBACKS_FIELD, CALLBACK_ARRAY, <span class="hljs-literal">null</span>);<br>		<span class="hljs-keyword">if</span> (serialVersionUID != <span class="hljs-literal">null</span>) &#123;<br>			e.declare_field(Constants.PRIVATE_FINAL_STATIC, Constants.SUID_FIELD_NAME, Type.LONG_TYPE, serialVersionUID);<br>		&#125;<br>    <span class="hljs-comment">// 2.3 è¿™é‡Œå°±æ˜¯ç”Ÿæˆçš„callbackï¼Œå‘½åå°±æ˜¯CGLIB&amp;CALLBACK_åœ¨æ•°ç»„ä¸­çš„åºå·</span><br>		<span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; callbackTypes.length; i++) &#123;<br>			e.declare_field(Constants.ACC_PRIVATE, getCallbackField(i), callbackTypes[i], <span class="hljs-literal">null</span>);<br>		&#125;<br>		<span class="hljs-comment">// This is declared private to avoid &quot;public field&quot; pollution</span><br>		e.declare_field(Constants.ACC_PRIVATE | Constants.ACC_STATIC, CALLBACK_FILTER_FIELD, OBJECT_TYPE, <span class="hljs-literal">null</span>);<br><br>		<span class="hljs-keyword">if</span> (currentData == <span class="hljs-literal">null</span>) &#123;<br>      <span class="hljs-comment">// 2.5 filteråœ¨è¿™é‡Œå‘ç”Ÿä½œç”¨</span><br>			emitMethods(e, methods, actualMethods);<br>			emitConstructors(e, constructorInfo);<br>		&#125;<br>		<span class="hljs-keyword">else</span> &#123;<br>			emitDefaultConstructor(e);<br>		&#125;<br>		emitSetThreadCallbacks(e);<br>		emitSetStaticCallbacks(e);<br>		emitBindCallbacks(e);<br><br>		<span class="hljs-keyword">if</span> (useFactory || currentData != <span class="hljs-literal">null</span>) &#123;<br>			<span class="hljs-type">int</span>[] keys = getCallbackKeys();<br>			emitNewInstanceCallbacks(e);<br>			emitNewInstanceCallback(e);<br>			emitNewInstanceMultiarg(e, constructorInfo);<br>			emitGetCallback(e, keys);<br>			emitSetCallback(e, keys);<br>			emitGetCallbacks(e);<br>			emitSetCallbacks(e);<br>		&#125;<br><br>		e.end_class();<br>	&#125;<br></code></pre></td></tr></table></figure>

<p>å›åˆ°å‰é¢ <code>AbstractClassGenerator#create</code> æ–¹æ³•</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs java">...<br><span class="hljs-keyword">if</span> (obj <span class="hljs-keyword">instanceof</span> Class) &#123;<br>    <span class="hljs-keyword">return</span> firstInstance((Class) obj);<br>&#125;<br>...<br></code></pre></td></tr></table></figure>

<p>ç‚¹è¿› <code>firstInstance()</code> æ–¹æ³•é‡Œï¼Œæ¥åˆ° <code>Enhancer#firstInstance</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">protected</span> Object <span class="hljs-title function_">firstInstance</span><span class="hljs-params">(Class type)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>		<span class="hljs-keyword">if</span> (classOnly) &#123;<br>			<span class="hljs-keyword">return</span> type;<br>		&#125;<br>		<span class="hljs-keyword">else</span> &#123;<br>			<span class="hljs-keyword">return</span> createUsingReflection(type);<br>		&#125;<br>&#125;<br><br><span class="hljs-keyword">private</span> Object <span class="hljs-title function_">createUsingReflection</span><span class="hljs-params">(Class type)</span> &#123;<br>		setThreadCallbacks(type, callbacks);<br>		<span class="hljs-keyword">try</span> &#123;<br><br>			<span class="hljs-keyword">if</span> (argumentTypes != <span class="hljs-literal">null</span>) &#123;<br><br>				<span class="hljs-keyword">return</span> ReflectUtils.newInstance(type, argumentTypes, arguments);<br><br>			&#125;<br>			<span class="hljs-keyword">else</span> &#123;<br><br>				<span class="hljs-keyword">return</span> ReflectUtils.newInstance(type);<br><br>			&#125;<br>		&#125;<br>		<span class="hljs-keyword">finally</span> &#123;<br>			<span class="hljs-comment">// clear thread callbacks to allow them to be gc&#x27;d</span><br>			setThreadCallbacks(type, <span class="hljs-literal">null</span>);<br>		&#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>è¿™é‡Œä½¿ç”¨äº† <code>ReflectUtils</code> åå°„å·¥å…·ç±»ä¸­çš„æ–¹æ³•ï¼Œå®Œæˆäº†åŠ¨æ€ä»£ç†å¯¹è±¡çš„ç”Ÿæˆ</p>
<h3 id="åå°„"><a href="#åå°„" class="headerlink" title="åå°„"></a>åå°„</h3><p>åŠ¨æ€ä»£ç†é‡Œè®²åˆ°äº†åå°„ï¼Œåœ¨Javaä¸­ï¼ŒåŠ¨æ€ä»£ç†ä¸»è¦é€šè¿‡Javaåå°„æœºåˆ¶å®ç°ï¼Œå¯ä»¥åœ¨ç¨‹åºè¿è¡Œæ—¶åŠ¨æ€åˆ›å»ºä»£ç†å¯¹è±¡ï¼Œæ— éœ€æ‰‹åŠ¨ç¼–å†™ä»£ç†ç±»</p>
<p><strong>åå°„</strong>æ˜¯Javaè¯­è¨€ä¸­çš„ä¸€ç§æœºåˆ¶ï¼Œå…è®¸ç¨‹åºåœ¨è¿è¡Œæ—¶åŠ¨æ€åœ°è·å–ã€æ£€æŸ¥å’Œæ“ä½œç±»çš„ä¿¡æ¯ä»¥åŠå¯¹è±¡çš„å±æ€§å’Œæ–¹æ³•ã€‚Javaåå°„APIä½äº<code>java.lang.reflect</code>åŒ…ä¸­ï¼Œå®ƒæä¾›äº†ä¸€ç»„ç±»å’Œæ¥å£ï¼Œç”¨äºå®ç°åå°„åŠŸèƒ½ã€‚åå°„æœºåˆ¶ä¸ºå¼€å‘è€…æä¾›äº†åœ¨ç¼–è¯‘æ—¶æ— æ³•ç¡®å®šçš„ç±»ç»“æ„ä¿¡æ¯ï¼Œä»è€Œå®ç°ä¸€äº›çµæ´»ã€åŠ¨æ€çš„æ“ä½œ</p>
<p>åå°„çš„åŸºç¡€çŸ¥è¯†åŒ…æ‹¬ä»¥ä¸‹å‡ ä¸ªå…³é”®æ¦‚å¿µï¼š</p>
<ol>
<li><p><strong>Classç±»</strong>ï¼š<code>java.lang.Class</code> æ˜¯Javaåå°„æœºåˆ¶çš„æ ¸å¿ƒç±»ï¼Œå®ƒä»£è¡¨ä¸€ä¸ªJavaç±»çš„è¿è¡Œæ—¶ä¿¡æ¯ã€‚é€šè¿‡Classç±»ï¼Œå¯ä»¥è·å–ç±»çš„ç»“æ„ä¿¡æ¯ï¼Œå¦‚å­—æ®µã€æ–¹æ³•ã€æ„é€ å‡½æ•°ã€çˆ¶ç±»ã€å®ç°çš„æ¥å£ç­‰ã€‚</p>
</li>
<li><p><strong>è·å–Classå¯¹è±¡</strong>ï¼šå¯ä»¥é€šè¿‡ä¸‰ç§æ–¹å¼æ¥è·å–ä¸€ä¸ªç±»çš„Classå¯¹è±¡ï¼š</p>
<ul>
<li>ä½¿ç”¨<code>Class.forName(String className)</code>ï¼šæ ¹æ®ç±»çš„å…¨é™å®šåè·å–Classå¯¹è±¡ã€‚éœ€è¦å¤„ç†<code>ClassNotFoundException</code>å¼‚å¸¸ã€‚</li>
<li>ä½¿ç”¨<code>.class</code>è¯­æ³•ï¼šä¾‹å¦‚ï¼Œ<code>String.class</code>è·å–Stringç±»çš„Classå¯¹è±¡ã€‚</li>
<li>ä½¿ç”¨<code>Object.getClass()</code>æ–¹æ³•ï¼šé€šè¿‡å¯¹è±¡çš„<code>getClass()</code>æ–¹æ³•è·å–å¯¹è±¡æ‰€å±ç±»çš„Classå¯¹è±¡ã€‚</li>
</ul>
</li>
<li><p><strong>è·å–ç±»çš„ä¿¡æ¯</strong>ï¼šé€šè¿‡Classå¯¹è±¡çš„æ–¹æ³•ï¼Œå¯ä»¥è·å–ç±»çš„ç»“æ„ä¿¡æ¯ï¼Œä¾‹å¦‚ï¼š</p>
<ul>
<li><code>getFields()</code>ï¼šè·å–ç±»çš„å…¬å…±å­—æ®µã€‚</li>
<li><code>getMethods()</code>ï¼šè·å–ç±»çš„å…¬å…±æ–¹æ³•ã€‚</li>
<li><code>getConstructors()</code>ï¼šè·å–ç±»çš„å…¬å…±æ„é€ å‡½æ•°ã€‚</li>
<li><code>getDeclaredFields()</code>ï¼šè·å–ç±»çš„æ‰€æœ‰å­—æ®µï¼ˆåŒ…æ‹¬ç§æœ‰å­—æ®µï¼‰ã€‚</li>
<li><code>getDeclaredMethods()</code>ï¼šè·å–ç±»çš„æ‰€æœ‰æ–¹æ³•ï¼ˆåŒ…æ‹¬ç§æœ‰æ–¹æ³•ï¼‰ã€‚</li>
</ul>
</li>
<li><p><strong>åˆ›å»ºå¯¹è±¡</strong>ï¼šé€šè¿‡Classå¯¹è±¡çš„<code>newInstance()</code>æ–¹æ³•ï¼Œå¯ä»¥åˆ›å»ºç±»çš„å®ä¾‹ã€‚</p>
</li>
<li><p><strong>è®¿é—®å­—æ®µå’Œæ–¹æ³•</strong>ï¼šé€šè¿‡åå°„å¯ä»¥åŠ¨æ€åœ°è®¿é—®å’Œä¿®æ”¹ç±»çš„å­—æ®µå€¼å’Œè°ƒç”¨ç±»çš„æ–¹æ³•ã€‚</p>
</li>
</ol>
<p>åå°„æœºåˆ¶çš„ä¼˜ç‚¹åœ¨äºå®ƒæä¾›äº†åŠ¨æ€æ€§å’Œçµæ´»æ€§ï¼Œä½¿å¾—å¼€å‘è€…èƒ½å¤Ÿåœ¨è¿è¡Œæ—¶åŠ¨æ€åœ°è·å–å’Œæ“ä½œç±»çš„ä¿¡æ¯ï¼Œé¿å…äº†åœ¨ç¼–è¯‘æ—¶å›ºå®šçš„é™åˆ¶ã€‚ç„¶è€Œï¼Œç”±äºåå°„æ¶‰åŠåˆ°åŠ¨æ€ç”Ÿæˆä»£ç å’ŒåŠ¨æ€æ£€æŸ¥ç±»å‹ï¼Œå…¶æ€§èƒ½å¯èƒ½è¾ƒä½ï¼Œä¸å®œé¢‘ç¹åœ°ä½¿ç”¨ï¼Œæœ€å¥½åœ¨éœ€è¦æ—¶å†ä½¿ç”¨</p>
<h5 id="åå°„åŸç†"><a href="#åå°„åŸç†" class="headerlink" title="åå°„åŸç†"></a>åå°„åŸç†</h5><p>åå°„ï¼ˆ<em>Reflection</em>ï¼‰å’Œç±»åŠ è½½ï¼ˆ<em>Class Loading</em>ï¼‰æ˜¯Javaä¸­ä¸¤ä¸ªé‡è¦çš„æ¦‚å¿µï¼Œå®ƒä»¬ä¹‹é—´æœ‰ä¸€å®šçš„å…³ç³»ã€‚åå°„æ˜¯Javaè¯­è¨€æä¾›çš„ä¸€ç§æœºåˆ¶ï¼Œå…è®¸åœ¨<strong>è¿è¡Œæ—¶åŠ¨æ€åœ°è·å–ã€æ£€æŸ¥å’Œæ“ä½œç±»çš„ä¿¡æ¯</strong>ï¼Œè€Œ<strong>ç±»åŠ è½½</strong>æ˜¯<strong>Javaè™šæ‹Ÿæœºåœ¨å°†ç±»å­—èŠ‚ç åŠ è½½åˆ°å†…å­˜å¹¶ç”Ÿæˆç±»å¯¹è±¡çš„è¿‡ç¨‹</strong></p>
<p><strong>ç±»åŠ è½½æ˜¯åå°„çš„åŸºç¡€</strong>ï¼Œåå°„çš„æ“ä½œéƒ½æ˜¯åŸºäºç±»åŠ è½½å®Œæˆçš„ã€‚åœ¨ä½¿ç”¨åå°„ä¹‹å‰ï¼Œéœ€è¦å…ˆå°†ç±»åŠ è½½åˆ°å†…å­˜ä¸­ï¼Œç„¶åé€šè¿‡ç±»çš„Classå¯¹è±¡æ¥è¿›è¡Œåå°„æ“ä½œï¼Œjavaç±»çš„æ‰§è¡Œéœ€è¦ç»å†ä»¥ä¸‹è¿‡ç¨‹ï¼š</p>
<p><strong>ç¼–è¯‘</strong>ï¼šjavaæ–‡ä»¶ç¼–è¯‘åç”Ÿæˆ <code>.class</code> å­—èŠ‚ç æ–‡ä»¶ </p>
<p><strong>ç±»åŠ è½½</strong>ï¼š</p>
<p><img src="/posts/59835/16139181881678.png" srcset="/img/loading.gif" lazyload alt="Java ç±»åŠ è½½æœºåˆ¶- ç±»åŠ è½½çš„æ—¶æœºå’Œè¿‡ç¨‹"></p>
<ul>
<li><p><strong>åŠ è½½</strong>ï¼šç±»åŠ è½½å™¨è´Ÿè´£æ ¹æ®ä¸€ä¸ªç±»çš„å…¨é™å®šåæ¥è¯»å–æ­¤ç±»çš„äºŒè¿›åˆ¶å­—èŠ‚æµåˆ° JVM å†…éƒ¨ï¼Œå¹¶å­˜å‚¨åœ¨è¿è¡Œæ—¶å†…å­˜åŒºçš„æ–¹æ³•åŒºï¼Œç„¶åå°†å…¶è½¬æ¢ä¸ºä¸€ä¸ªä¸ç›®æ ‡ç±»å‹å¯¹åº”çš„ <code>java.lang.Class</code> å¯¹è±¡å®ä¾‹ </p>
</li>
<li><p><strong>è¿æ¥</strong>ï¼š</p>
<ul>
<li><p>éªŒè¯ï¼šæ ¼å¼ï¼ˆclassæ–‡ä»¶è§„èŒƒï¼‰ è¯­ä¹‰ï¼ˆfinalç±»æ˜¯å¦æœ‰å­ç±»ï¼‰ æ“ä½œ</p>
</li>
<li><p>å‡†å¤‡ï¼šé™æ€å˜é‡èµ‹åˆå€¼å’Œå†…å­˜ç©ºé—´ï¼Œfinalä¿®é¥°çš„å†…å­˜ç©ºé—´ç›´æ¥èµ‹åŸå€¼ï¼Œæ­¤å¤„ä¸æ˜¯ç”¨æˆ·æŒ‡å®šçš„åˆå€¼ã€‚</p>
</li>
<li><p>è§£æï¼šç¬¦å·å¼•ç”¨è½¬åŒ–ä¸ºç›´æ¥å¼•ç”¨ï¼Œåˆ†é…åœ°å€</p>
</li>
</ul>
</li>
<li><p><strong>åˆå§‹åŒ–</strong>ï¼šæœ‰çˆ¶ç±»å…ˆåˆå§‹åŒ–çˆ¶ç±»ï¼Œç„¶ååˆå§‹åŒ–è‡ªå·±ï¼›å°†staticä¿®é¥°ä»£ç æ‰§è¡Œä¸€éï¼Œå¦‚æœæ˜¯é™æ€å˜é‡ï¼Œåˆ™ç”¨ç”¨æˆ·æŒ‡å®šå€¼è¦†ç›–åŸæœ‰åˆå€¼ï¼›å¦‚æœæ˜¯ä»£ç å—ï¼Œåˆ™æ‰§è¡Œä¸€éæ“ä½œã€‚</p>
</li>
</ul>
<p>Javaçš„åå°„å°±æ˜¯åˆ©ç”¨ä¸Šé¢ç¬¬äºŒæ­¥åŠ è½½åˆ°jvmä¸­çš„ <code>.class</code> æ–‡ä»¶æ¥è¿›è¡Œæ“ä½œã€‚å…·ä½“æ¥è¯´ï¼Œåœ¨Javaè™šæ‹Ÿæœºå¯¹ç±»è¿›è¡ŒåŠ è½½å’Œè¿æ¥çš„è¿‡ç¨‹ä¸­ï¼Œ<strong>åå°„ä¸»è¦åœ¨è§£æé˜¶æ®µè¿›è¡Œ</strong>ï¼Œå…¶ä¸­<strong>è§£æçš„ä¸»è¦ç›®æ ‡æ˜¯å°†ç±»ã€å­—æ®µã€æ–¹æ³•çš„ç¬¦å·å¼•ç”¨è½¬æ¢ä¸ºç›´æ¥å¼•ç”¨ï¼Œå»ºç«‹ç±»ä¹‹é—´çš„å…³è”å…³ç³»</strong></p>
<p>ä»¥ä¸‹æ˜¯ä¸€ä¸ªä½¿ç”¨åå°„è°ƒç”¨æ–¹æ³•çš„ç®€å•ç¤ºä¾‹ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">import</span> java.lang.reflect.Method;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MyClass</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">sayHello</span><span class="hljs-params">()</span> &#123;<br>        System.out.println(<span class="hljs-string">&quot;Hello, World!&quot;</span>);<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">add</span><span class="hljs-params">(<span class="hljs-type">int</span> a, <span class="hljs-type">int</span> b)</span> &#123;<br>        <span class="hljs-keyword">return</span> a + b;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        <span class="hljs-comment">// è·å–Classå¯¹è±¡</span><br>        Class&lt;?&gt; clazz = MyClass.class;<br><br>        <span class="hljs-comment">// è·å–æ— å‚æ–¹æ³•çš„Methodå¯¹è±¡å¹¶è°ƒç”¨</span><br>        <span class="hljs-type">Method</span> <span class="hljs-variable">sayHelloMethod</span> <span class="hljs-operator">=</span> clazz.getMethod(<span class="hljs-string">&quot;sayHello&quot;</span>);<br>        sayHelloMethod.invoke(clazz.newInstance());<br><br>        <span class="hljs-comment">// è·å–æœ‰å‚æ–¹æ³•çš„Methodå¯¹è±¡å¹¶è°ƒç”¨</span><br>        <span class="hljs-type">Method</span> <span class="hljs-variable">addMethod</span> <span class="hljs-operator">=</span> clazz.getMethod(<span class="hljs-string">&quot;add&quot;</span>, <span class="hljs-type">int</span>.class, <span class="hljs-type">int</span>.class);<br>        <span class="hljs-type">int</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> (<span class="hljs-type">int</span>) addMethod.invoke(clazz.newInstance(), <span class="hljs-number">10</span>, <span class="hljs-number">20</span>);<br>        System.out.println(<span class="hljs-string">&quot;Result: &quot;</span> + result);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>è¾“å‡ºç»“æœï¼š</p>
<figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">Hello</span>, World!<br><span class="hljs-attribute">Result</span>: <span class="hljs-number">30</span><br></code></pre></td></tr></table></figure>

<p>éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œåœ¨ä½¿ç”¨åå°„è°ƒç”¨æ–¹æ³•æ—¶ï¼Œè¦ç¡®ä¿æ–¹æ³•çš„åç§°ã€å‚æ•°ç±»å‹å’Œè°ƒç”¨çš„æ–¹æ³•æ˜¯ä¸€è‡´çš„ï¼Œå¦åˆ™ä¼šæŠ›å‡º <code>NoSuchMethodException </code>æˆ– <code>IllegalArgumentException</code> å¼‚å¸¸</p>
<p>æ¥ä¸‹æ¥ä¸»è¦è§£æä¸€ä¸‹è·å– <code>Method</code> å¯¹è±¡å’Œ <code>Method.invoke()</code> æ–¹æ³•</p>
<h5 id="è·å–-Method-å¯¹è±¡"><a href="#è·å–-Method-å¯¹è±¡" class="headerlink" title="è·å– Method å¯¹è±¡"></a>è·å– Method å¯¹è±¡</h5><p>åœ¨Javaçš„åå°„æœºåˆ¶ä¸­ï¼Œå¯ä»¥é€šè¿‡<code>Class</code>å¯¹è±¡è·å–<code>Method</code>å¯¹è±¡ï¼Œ<code>Method</code>å¯¹è±¡ä»£è¡¨äº†ç±»ä¸­çš„æ–¹æ³•ã€‚é€šè¿‡<code>Method</code>å¯¹è±¡å¯ä»¥åœ¨è¿è¡Œæ—¶åŠ¨æ€åœ°è°ƒç”¨ç±»çš„æ–¹æ³•ã€‚Javaåå°„ä¸­è·å–<code>Method</code>å¯¹è±¡çš„æ–¹æ³•ä¸»è¦æœ‰ä»¥ä¸‹ä¸¤ä¸ªï¼š</p>
<ol>
<li><p><code>getMethod(String name, Class&lt;?&gt;... parameterTypes)</code>ï¼š</p>
<ul>
<li>ç”¨äºè·å–ç±»çš„å…¬å…±æ–¹æ³•ï¼ˆåŒ…æ‹¬ä»çˆ¶ç±»ç»§æ‰¿çš„å…¬å…±æ–¹æ³•ï¼‰ã€‚</li>
<li>å‚æ•°<code>name</code>æ˜¯è¦è·å–çš„æ–¹æ³•çš„åç§°ã€‚</li>
<li>å‚æ•°<code>parameterTypes</code>æ˜¯æ–¹æ³•çš„å‚æ•°ç±»å‹æ•°ç»„ï¼Œç”¨äºæŒ‡å®šæ–¹æ³•çš„å‚æ•°ç±»å‹ã€‚å¦‚æœæ–¹æ³•æœ‰å‚æ•°ï¼Œéœ€è¦å°†å‚æ•°ç±»å‹ä»¥Classå¯¹è±¡çš„å½¢å¼ä¼ é€’è¿›å»ã€‚å¦‚æœæ–¹æ³•æ²¡æœ‰å‚æ•°ï¼Œå¯ä»¥ä¸ä¼ é€’è¯¥å‚æ•°ã€‚</li>
<li>è¿”å›å€¼æ˜¯ä¸€ä¸ªMethodå¯¹è±¡ï¼Œè¡¨ç¤ºä¸æŒ‡å®šåç§°å’Œå‚æ•°ç±»å‹åŒ¹é…çš„å…¬å…±æ–¹æ³•ã€‚å¦‚æœæœªæ‰¾åˆ°å¯¹åº”çš„æ–¹æ³•ï¼Œåˆ™æŠ›å‡º<code>NoSuchMethodException</code>å¼‚å¸¸ã€‚</li>
</ul>
</li>
<li><p><code>getDeclaredMethod(String name, Class&lt;?&gt;... parameterTypes)</code>ï¼š</p>
<ul>
<li>ç”¨äºè·å–ç±»è‡ªèº«å£°æ˜çš„æ–¹æ³•ï¼ˆåŒ…æ‹¬ç§æœ‰æ–¹æ³•ï¼‰ã€‚</li>
<li>å‚æ•°<code>name</code>æ˜¯è¦è·å–çš„æ–¹æ³•çš„åç§°ã€‚</li>
<li>å‚æ•°<code>parameterTypes</code>æ˜¯æ–¹æ³•çš„å‚æ•°ç±»å‹æ•°ç»„ï¼Œç”¨äºæŒ‡å®šæ–¹æ³•çš„å‚æ•°ç±»å‹ã€‚å¦‚æœæ–¹æ³•æœ‰å‚æ•°ï¼Œéœ€è¦å°†å‚æ•°ç±»å‹ä»¥Classå¯¹è±¡çš„å½¢å¼ä¼ é€’è¿›å»ã€‚å¦‚æœæ–¹æ³•æ²¡æœ‰å‚æ•°ï¼Œå¯ä»¥ä¸ä¼ é€’è¯¥å‚æ•°ã€‚</li>
<li>è¿”å›å€¼æ˜¯ä¸€ä¸ªMethodå¯¹è±¡ï¼Œè¡¨ç¤ºä¸æŒ‡å®šåç§°å’Œå‚æ•°ç±»å‹åŒ¹é…çš„ç±»è‡ªèº«å£°æ˜çš„æ–¹æ³•ã€‚å¦‚æœæœªæ‰¾åˆ°å¯¹åº”çš„æ–¹æ³•ï¼Œåˆ™æŠ›å‡º<code>NoSuchMethodException</code>å¼‚å¸¸ã€‚</li>
</ul>
</li>
</ol>
<blockquote>
<p>ä¸Šè¿°ä¸¤ä¸ªæ–¹æ³•éƒ½æœ‰è·å–å¤æ•°ä¸ªçš„æ–¹æ³•ï¼ŒåŒºåˆ«å°±æ˜¯æ–¹æ³•ååæœ‰ â€œ<strong>s</strong>â€ åç¼€</p>
<p><strong>æ³¨æ„äº‹é¡¹</strong>ï¼š</p>
<ul>
<li>å½“è·å–ç§æœ‰æ–¹æ³•æ—¶ï¼Œä½¿ç”¨<code>getDeclaredMethod()</code>æ–¹æ³•ï¼›å½“è·å–å…¬å…±æ–¹æ³•æ—¶ï¼Œä½¿ç”¨<code>getMethod()</code>æ–¹æ³•ã€‚</li>
<li>å¦‚æœè·å–çš„æ–¹æ³•æ˜¯ç§æœ‰æ–¹æ³•ï¼Œéœ€è¦é€šè¿‡<code>setAccessible(true)</code>æ–¹æ³•å°†å…¶è®¾ç½®ä¸ºå¯è®¿é—®ï¼Œä»¥å…è®¸è®¿é—®ç§æœ‰æ–¹æ³•ã€‚</li>
</ul>
</blockquote>
<p>å…¶å®ä¸ç®¡æ˜¯<code>getMethod</code>è¿˜æ˜¯<code>getDeclaredMethod</code>ï¼Œåº•å±‚éƒ½è°ƒç”¨äº†åŒä¸€ä¸ªæ–¹æ³•ï¼š<code>privateGetDeclaredMethods</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">private</span> Method <span class="hljs-title function_">privateGetMethodRecursive</span><span class="hljs-params">(String name,</span><br><span class="hljs-params">            Class&lt;?&gt;[] parameterTypes,</span><br><span class="hljs-params">            <span class="hljs-type">boolean</span> includeStaticMethods,</span><br><span class="hljs-params">            MethodArray allInterfaceCandidates)</span> &#123;<br><br>        <span class="hljs-comment">// Must _not_ return root methods</span><br>        Method res;<br>        <span class="hljs-comment">// Search declared public methods æœç´¢æœ¬æ¥ä¸­å£°æ˜çš„å…¬å…±æ–¹æ³•</span><br>        <span class="hljs-keyword">if</span> ((res = searchMethods(privateGetDeclaredMethods(<span class="hljs-literal">true</span>),<br>                                 name,<br>                                 parameterTypes)) != <span class="hljs-literal">null</span>) &#123;<br>            <span class="hljs-keyword">if</span> (includeStaticMethods || !Modifier.isStatic(res.getModifiers()))<br>                <span class="hljs-keyword">return</span> res;<br>        &#125;<br>        <span class="hljs-comment">// å¦‚æœresä¸ºç©ºï¼Œç»§ç»­å‘çˆ¶ç±»æœç´¢</span><br>        <span class="hljs-comment">// Search superclass&#x27;s methods</span><br>        <span class="hljs-keyword">if</span> (!isInterface()) &#123;<br>            Class&lt;? <span class="hljs-built_in">super</span> T&gt; c = getSuperclass();<br>            <span class="hljs-keyword">if</span> (c != <span class="hljs-literal">null</span>) &#123;<br>                <span class="hljs-comment">// é€’å½’è°ƒç”¨getMethod0ï¼Œè·å–çˆ¶ç±»çš„æ–¹æ³•å®ç°</span><br>                <span class="hljs-keyword">if</span> ((res = c.getMethod0(name, parameterTypes, <span class="hljs-literal">true</span>)) != <span class="hljs-literal">null</span>) &#123;<br>                    <span class="hljs-keyword">return</span> res;<br>                &#125;<br>            &#125;<br>        &#125;<br>        <span class="hljs-comment">// resä»ç„¶ä¸ºç©ºï¼Œç»§ç»­å‘æ¥å£æœç´¢</span><br>        <span class="hljs-comment">// Search superinterfaces&#x27; methods</span><br>        Class&lt;?&gt;[] interfaces = getInterfaces();<br>        <span class="hljs-keyword">for</span> (Class&lt;?&gt; c : interfaces)<br>            <span class="hljs-keyword">if</span> ((res = c.getMethod0(name, parameterTypes, <span class="hljs-literal">false</span>)) != <span class="hljs-literal">null</span>)<br>                allInterfaceCandidates.add(res);<br>        <span class="hljs-comment">// Not found</span><br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>    &#125;<br></code></pre></td></tr></table></figure>

<p>ç„¶ååœ¨çœ‹çœ‹ <code>searchMethods()</code> æ–¹æ³•</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> Method <span class="hljs-title function_">searchMethods</span><span class="hljs-params">(Method[] methods,</span><br><span class="hljs-params">                                    String name,</span><br><span class="hljs-params">                                    Class&lt;?&gt;[] parameterTypes)</span><br>    &#123;<br>        <span class="hljs-type">Method</span> <span class="hljs-variable">res</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;<br>        <span class="hljs-type">String</span> <span class="hljs-variable">internedName</span> <span class="hljs-operator">=</span> name.intern();<br>        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; methods.length; i++) &#123;<br>            <span class="hljs-type">Method</span> <span class="hljs-variable">m</span> <span class="hljs-operator">=</span> methods[i];<br>            <span class="hljs-keyword">if</span> (m.getName() == internedName<br>                &amp;&amp; arrayContentsEq(parameterTypes, m.getParameterTypes())<br>                &amp;&amp; (res == <span class="hljs-literal">null</span><br>                    || res.getReturnType().isAssignableFrom(m.getReturnType())))<br>                res = m;<br>        &#125;<br><br>        <span class="hljs-keyword">return</span> (res == <span class="hljs-literal">null</span> ? res : getReflectionFactory().copyMethod(res));<br>    &#125;<br></code></pre></td></tr></table></figure>

<p>å…¶ä¸­å¾ªç¯äº† Method[] methods è¿™ä¸ªæ•°ç»„ï¼Œè€Œè¿™ä¸ªå‚æ•°æ˜¯ç”± privateGetDeclaredMethods(boolean <em>publicOnly</em>) è·å¾—çš„</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">private</span> Method[] privateGetDeclaredMethods(<span class="hljs-type">boolean</span> publicOnly) &#123;<br>    checkInitted();<br>    Method[] res;<br>    <span class="hljs-comment">// 1.ReflectionData å­˜å‚¨åå°„æ•°æ®çš„ç¼“å­˜ç»“æ„</span><br>    ReflectionData&lt;T&gt; rd = reflectionData();<br>    <span class="hljs-keyword">if</span> (rd != <span class="hljs-literal">null</span>) &#123;<br>        <span class="hljs-comment">// 2.å…ˆä»ç¼“å­˜ä¸­è·å–methods</span><br>        res = publicOnly ? rd.declaredPublicMethods : rd.declaredMethods;<br>        <span class="hljs-keyword">if</span> (res != <span class="hljs-literal">null</span>) <span class="hljs-keyword">return</span> res;<br>    &#125;<br>    <span class="hljs-comment">// No cached value available; request value from VM</span><br>    <span class="hljs-comment">// 3.æ²¡æœ‰ç¼“å­˜ï¼Œé€šè¿‡ JVM è·å–ï¼Œnativeæ–¹æ³•</span><br>    res = Reflection.filterMethods(<span class="hljs-built_in">this</span>, getDeclaredMethods0(publicOnly));<br>    <span class="hljs-keyword">if</span> (rd != <span class="hljs-literal">null</span>) &#123;<br>        <span class="hljs-keyword">if</span> (publicOnly) &#123;<br>            rd.declaredPublicMethods = res;<br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>            rd.declaredMethods = res;<br>        &#125;<br>    &#125;<br>    <span class="hljs-keyword">return</span> res;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>å…¶ä¸­çš„ <code>ReflectionData&lt;T&gt;</code>æ˜¯ç±»<code>Class</code>çš„é™æ€å†…éƒ¨ç±»ï¼Œ<code>&lt;T&gt;</code>è¡¨ç¤ºæ³›å‹ï¼Œä¸ºå…·ä½“çš„ç±»å¯¹è±¡ã€‚è¯¥ç¼“å­˜æ•°æ®ç»“æ„ä¸­å­˜å‚¨äº†ç±»çš„æ‰€æœ‰ä¿¡æ¯ã€‚<code>redefinedCount</code>æ˜¯ç±»çš„é‡å®šä¹‰æ¬¡æ•°ï¼Œå¯ä»¥ç†è§£ä¸ºç¼“å­˜çš„ç‰ˆæœ¬å·ï¼Œæ¯ä¸€ä¸ªç±»å¯¹è±¡ç†è®ºä¸Šéƒ½ä¼šæœ‰ï¼ˆè¢«åƒåœ¾å›æ”¶æˆ–ä»æ¥æ²¡è¢«åŠ è½½è¿‡å°±æ²¡æ²¡æœ‰ï¼‰ä¸€ä¸ª<code>ReflectionData&lt;T&gt;</code>çš„ç¼“å­˜ï¼Œé€šè¿‡ <code>reflectionData()</code> è·å–ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// Lazily create and cache ReflectionData</span><br><span class="hljs-keyword">private</span> ReflectionData&lt;T&gt; <span class="hljs-title function_">reflectionData</span><span class="hljs-params">()</span> &#123;<br>    SoftReference&lt;ReflectionData&lt;T&gt;&gt; reflectionData = <span class="hljs-built_in">this</span>.reflectionData;<br>    <span class="hljs-type">int</span> <span class="hljs-variable">classRedefinedCount</span> <span class="hljs-operator">=</span> <span class="hljs-built_in">this</span>.classRedefinedCount;<br>    ReflectionData&lt;T&gt; rd;<br>    <span class="hljs-keyword">if</span> (useCaches &amp;&amp;<br>        reflectionData != <span class="hljs-literal">null</span> &amp;&amp;<br>        (rd = reflectionData.get()) != <span class="hljs-literal">null</span> &amp;&amp;<br>        rd.redefinedCount == classRedefinedCount) &#123;<br>        <span class="hljs-keyword">return</span> rd;<br>    &#125;<br>    <span class="hljs-comment">// else no SoftReference or cleared SoftReference or stale ReflectionData</span><br>    <span class="hljs-comment">// -&gt; create and replace new instance</span><br>    <span class="hljs-keyword">return</span> newReflectionData(reflectionData, classRedefinedCount);<br>&#125;<br><br><span class="hljs-keyword">private</span> ReflectionData&lt;T&gt; <span class="hljs-title function_">newReflectionData</span><span class="hljs-params">(SoftReference&lt;ReflectionData&lt;T&gt;&gt; oldReflectionData, <span class="hljs-type">int</span> classRedefinedCount)</span> &#123;<br>    <span class="hljs-comment">// ä¸ä½¿ç”¨ç¼“å­˜åˆ™ç›´æ¥è¿”å›null</span><br>    <span class="hljs-keyword">if</span> (!useCaches) <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br><br>    <span class="hljs-comment">// ä½¿ç”¨while+CASæ–¹å¼æ›´æ–°æ•°æ®ï¼Œåˆ›å»ºä¸€ä¸ªæ–°çš„ReflectionDataï¼Œå¦‚æœæ›´æ–°æˆåŠŸç›´æ¥è¿”å›</span><br>    <span class="hljs-keyword">while</span> (<span class="hljs-literal">true</span>) &#123;<br>        ReflectionData&lt;T&gt; rd = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ReflectionData</span>&lt;&gt;(classRedefinedCount);<br>        <span class="hljs-comment">// try to CAS it...</span><br>        <span class="hljs-keyword">if</span> (Atomic.casReflectionData(<span class="hljs-built_in">this</span>, oldReflectionData, <span class="hljs-keyword">new</span> <span class="hljs-title class_">SoftReference</span>&lt;&gt;(rd))) &#123;<br>            <span class="hljs-keyword">return</span> rd;<br>        &#125;<br>        <span class="hljs-comment">// else retry</span><br>        <span class="hljs-comment">// è·å–åˆ°æ—§çš„reflectionDataå’ŒclassRedefinedCountçš„å€¼ï¼Œå¦‚æœæ—§çš„å€¼ä¸ä¸ºnull, å¹¶ä¸”ç¼“å­˜æœªå¤±æ•ˆï¼Œè¯´æ˜å…¶ä»–çº¿ç¨‹æ›´æ–°æˆåŠŸäº†ï¼Œç›´æ¥è¿”å›</span><br>        oldReflectionData = <span class="hljs-built_in">this</span>.reflectionData;<br>        classRedefinedCount = <span class="hljs-built_in">this</span>.classRedefinedCount;<br>        <span class="hljs-keyword">if</span> (oldReflectionData != <span class="hljs-literal">null</span> &amp;&amp;<br>            (rd = oldReflectionData.get()) != <span class="hljs-literal">null</span> &amp;&amp;<br>            rd.redefinedCount == classRedefinedCount) &#123;<br>            <span class="hljs-keyword">return</span> rd;<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<h5 id="Method-invoke"><a href="#Method-invoke" class="headerlink" title="Method.invoke()"></a>Method.invoke()</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> Object <span class="hljs-title function_">invoke</span><span class="hljs-params">(Object obj, Object... args)</span><br>    <span class="hljs-keyword">throws</span> IllegalAccessException, IllegalArgumentException,<br>       InvocationTargetException<br>&#123;<br>    <span class="hljs-keyword">if</span> (!override) &#123;<br>        <span class="hljs-comment">// 1.æ£€æŸ¥æƒé™ï¼Œå¦‚æœ override == trueï¼Œå°±è·³è¿‡æ£€æŸ¥</span><br>        <span class="hljs-comment">// é€šå¸¸åœ¨ Method#invoke ä¹‹å‰ï¼Œä¼šè°ƒç”¨ Method#setAccessible(true)ï¼Œå°±æ˜¯è®¾ç½® override å€¼ä¸º true</span><br>        <span class="hljs-keyword">if</span> (!Reflection.quickCheckMemberAccess(clazz, modifiers)) &#123;<br>            Class&lt;?&gt; caller = Reflection.getCallerClass();<br>            checkAccess(caller, clazz, obj, modifiers);<br>        &#125;<br>    &#125;<br>    <span class="hljs-comment">// 2.è·å– MethodAccessor</span><br>    <span class="hljs-type">MethodAccessor</span> <span class="hljs-variable">ma</span> <span class="hljs-operator">=</span> methodAccessor;             <span class="hljs-comment">// read volatile</span><br>    <span class="hljs-keyword">if</span> (ma == <span class="hljs-literal">null</span>) &#123;<br>        <span class="hljs-comment">// 2.1ä¸ºç©ºæ—¶åˆ›å»ºMethodAccessor</span><br>        ma = acquireMethodAccessor();<br>    &#125;<br>    <span class="hljs-comment">// 3.è°ƒç”¨ MethodAccessor.invoke</span><br>    <span class="hljs-keyword">return</span> ma.invoke(obj, args);<br>&#125;<br></code></pre></td></tr></table></figure>

<p>è¿™é‡Œä¼šè·å– <code>MethodAccessor</code> ï¼Œè¿™ä¸ªåœ¨ä¹‹å‰ <code>searchMethods()</code> æœ€åä¼šè°ƒç”¨ <code>Method#copy</code> ä¼šç»™ <code>Method</code> çš„ <code>methodAccessor</code> èµ‹å€¼ï¼Œå¦‚æœä¸ºç©ºåˆ™å»åˆ›å»º <code>MethodAccessor</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">private</span> MethodAccessor <span class="hljs-title function_">acquireMethodAccessor</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-comment">// First check to see if one has been created yet, and take it</span><br>    <span class="hljs-comment">// if so</span><br>    <span class="hljs-type">MethodAccessor</span> <span class="hljs-variable">tmp</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;<br>    <span class="hljs-keyword">if</span> (root != <span class="hljs-literal">null</span>) tmp = root.getMethodAccessor();<br>    <span class="hljs-keyword">if</span> (tmp != <span class="hljs-literal">null</span>) &#123;<br>        methodAccessor = tmp;<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>        <span class="hljs-comment">// Otherwise fabricate one and propagate it up to the root</span><br>        tmp = reflectionFactory.newMethodAccessor(<span class="hljs-built_in">this</span>);<br>        setMethodAccessor(tmp);<br>    &#125;<br><br>    <span class="hljs-keyword">return</span> tmp;<br>&#125;<br><br><span class="hljs-keyword">public</span> MethodAccessor <span class="hljs-title function_">newMethodAccessor</span><span class="hljs-params">(Method var1)</span> &#123;<br>    checkInitted();<br>    <span class="hljs-keyword">if</span> (noInflation &amp;&amp; !ReflectUtil.isVMAnonymousClass(var1.getDeclaringClass())) &#123;<br>        <span class="hljs-keyword">return</span> (<span class="hljs-keyword">new</span> <span class="hljs-title class_">MethodAccessorGenerator</span>()).generateMethod(var1.getDeclaringClass(), var1.getName(), var1.getParameterTypes(), var1.getReturnType(), var1.getExceptionTypes(), var1.getModifiers());<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>        <span class="hljs-type">NativeMethodAccessorImpl</span> <span class="hljs-variable">var2</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">NativeMethodAccessorImpl</span>(var1);<br>        <span class="hljs-type">DelegatingMethodAccessorImpl</span> <span class="hljs-variable">var3</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">DelegatingMethodAccessorImpl</span>(var2);<br>        var2.setParent(var3);<br>        <span class="hljs-keyword">return</span> var3;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>è¿™é‡Œä¼šå…ˆæŸ¥æ‰¾ <em>root</em> çš„ <code>MethodAccessor</code>ï¼Œè¿™é‡Œçš„ <em>root</em> åœ¨ä¸Šé¢ <code>Method#copy</code> ä¸­è®¾ç½®è¿‡ã€‚å¦‚æœè¿˜æ˜¯æ²¡æœ‰æ‰¾åˆ°ï¼Œå°±å»åˆ›å»º <code>MethodAccessor</code></p>
<p>åœ¨ <code>newMethodAccessor()</code> æ–¹æ³•é‡Œå¯ä»¥çœ‹åˆ°ä¸€å…±æœ‰ä¸‰ç§ <code>MethodAccessor</code>ï¼š</p>
<ul>
<li><code>MethodAccessorImpl</code></li>
<li><code>NativeMethodAccessorImpl</code></li>
<li><code>DelegatingMethodAccessorImpl</code></li>
</ul>
<p>é‡‡ç”¨å“ªç§ <code>MethodAccessor</code> æ ¹æ® <code>noInflation</code> è¿›è¡Œåˆ¤æ–­ï¼Œ<code>noInflation</code> é»˜è®¤å€¼ä¸º <code>false</code>ï¼Œåªæœ‰æŒ‡å®šäº† <code>sun.reflect.noInflation</code> å±æ€§ä¸º <code>true</code>ï¼Œæ‰ä¼šé‡‡ç”¨ <code>MethodAccessorImpl</code> ï¼Œæ‰€ä»¥é»˜è®¤ä¼šè°ƒç”¨ <code>NativeMethodAccessorImpl</code></p>
<p><code>MethodAccessorImpl</code> æ˜¯é€šè¿‡åŠ¨æ€ç”Ÿæˆå­—èŠ‚ç æ¥è¿›è¡Œæ–¹æ³•è°ƒç”¨çš„ï¼Œæ˜¯ Java ç‰ˆæœ¬çš„ <code>MethodAccessor</code></p>
<p><code>DelegatingMethodAccessorImpl</code> å°±æ˜¯å•çº¯çš„ä»£ç†ï¼ŒçœŸæ­£çš„å®ç°è¿˜æ˜¯ <code>NativeMethodAccessorImpl</code>ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">class</span> <span class="hljs-title class_">DelegatingMethodAccessorImpl</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">MethodAccessorImpl</span> &#123;<br>    <span class="hljs-keyword">private</span> MethodAccessorImpl delegate;<br> <br>    DelegatingMethodAccessorImpl(MethodAccessorImpl delegate) &#123;<br>        setDelegate(delegate);<br>    &#125;<br> <br>    <span class="hljs-keyword">public</span> Object <span class="hljs-title function_">invoke</span><span class="hljs-params">(Object obj, Object[] args)</span><br>        <span class="hljs-keyword">throws</span> IllegalArgumentException, InvocationTargetException<br>    &#123;<br>        <span class="hljs-keyword">return</span> delegate.invoke(obj, args);<br>    &#125;<br> <br>    <span class="hljs-keyword">void</span> <span class="hljs-title function_">setDelegate</span><span class="hljs-params">(MethodAccessorImpl delegate)</span> &#123;<br>        <span class="hljs-built_in">this</span>.delegate = delegate;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p><code>NativeMethodAccessorImpl</code> æ˜¯ <em>Native</em> ç‰ˆæœ¬çš„ <code>MethodAccessor</code> å®ç°ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">class</span> <span class="hljs-title class_">NativeMethodAccessorImpl</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">MethodAccessorImpl</span> &#123;<br>    <span class="hljs-keyword">public</span> Object <span class="hljs-title function_">invoke</span><span class="hljs-params">(Object obj, Object[] args)</span><br>        <span class="hljs-keyword">throws</span> IllegalArgumentException, InvocationTargetException<br>    &#123;<br>        <span class="hljs-comment">// We can&#x27;t inflate methods belonging to vm-anonymous classes because</span><br>        <span class="hljs-comment">// that kind of class can&#x27;t be referred to by name, hence can&#x27;t be</span><br>        <span class="hljs-comment">// found from the generated bytecode.</span><br>        <span class="hljs-keyword">if</span> (++numInvocations &gt; ReflectionFactory.inflationThreshold()<br>                &amp;&amp; !ReflectUtil.isVMAnonymousClass(method.getDeclaringClass())) &#123;<br>            <span class="hljs-comment">// Java ç‰ˆæœ¬çš„ MethodAccessor</span><br>            <span class="hljs-type">MethodAccessorImpl</span> <span class="hljs-variable">acc</span> <span class="hljs-operator">=</span> (MethodAccessorImpl)<br>                <span class="hljs-keyword">new</span> <span class="hljs-title class_">MethodAccessorGenerator</span>().<br>                    generateMethod(method.getDeclaringClass(),<br>                                   method.getName(),<br>                                   method.getParameterTypes(),<br>                                   method.getReturnType(),<br>                                   method.getExceptionTypes(),<br>                                   method.getModifiers());<br>            parent.setDelegate(acc);<br>        &#125;<br>        <span class="hljs-comment">// Native ç‰ˆæœ¬è°ƒç”¨</span><br>        <span class="hljs-keyword">return</span> invoke0(method, obj, args);<br>    &#125;<br> <br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">native</span> Object <span class="hljs-title function_">invoke0</span><span class="hljs-params">(Method m, Object obj, Object[] args)</span>;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>åœ¨ <code>NativeMethodAccessorImpl</code> çš„å®ç°ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼Œæœ‰ä¸€ä¸ª <code>numInvocations</code> é˜€å€¼æ§åˆ¶ï¼Œ<code>numInvocations</code> è¡¨ç¤ºè°ƒç”¨æ¬¡æ•°ã€‚å¦‚æœ <code>numInvocations</code> å¤§äº 15ï¼ˆé»˜è®¤é˜€å€¼æ˜¯ 15ï¼‰ï¼Œé‚£ä¹ˆå°±ä½¿ç”¨ Java ç‰ˆæœ¬çš„ <code>MethodAccessorImpl</code>ã€‚ ä¸ºä»€ä¹ˆé‡‡ç”¨è¿™ä¸ªç­–ç•¥å‘¢ï¼Œå¯ä»¥ JDK ä¸­çš„æ³¨é‡Šï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// &quot;Inflation&quot; mechanism. Loading bytecodes to implement</span><br></code></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// Method.invoke() and Constructor.newInstance() currently costs</span><br></code></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// 3-4x more than an invocation via native code for the first</span><br><span class="hljs-comment">// invocation (though subsequent invocations have been benchmarked</span><br><span class="hljs-comment">// to be over 20x faster). Unfortunately this cost increases</span><br><span class="hljs-comment">// startup time for certain applications that use reflection</span><br><span class="hljs-comment">// intensively (but only once per class) to bootstrap themselves.</span><br><span class="hljs-comment">// To avoid this penalty we reuse the existing JVM entry points</span><br><span class="hljs-comment">// for the first few invocations of Methods and Constructors and</span><br><span class="hljs-comment">// then switch to the bytecode-based implementations.</span><br><span class="hljs-comment">//</span><br><span class="hljs-comment">// Package-private to be accessible to NativeMethodAccessorImpl</span><br><span class="hljs-comment">// and NativeConstructorAccessorImpl</span><br><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-type">boolean</span> <span class="hljs-variable">noInflation</span>        <span class="hljs-operator">=</span> <span class="hljs-literal">false</span>;<br></code></pre></td></tr></table></figure>

<p>æ¯”èµ·é€šè¿‡æœ¬åœ°ä»£ç è¿›è¡Œçš„é¦–æ¬¡è°ƒç”¨ï¼Œæ–¹æ³•å’Œæ„é€ å‡½æ•°çš„é¦–æ¬¡è°ƒç”¨è¦å¿«3-4å€ï¼ˆè™½ç„¶åç»­çš„è°ƒç”¨å·²ç»ç»è¿‡åŸºå‡†æµ‹è¯•ï¼Œé€Ÿåº¦å¯ä»¥è¾¾åˆ°åŸæ¥çš„20å€ä»¥ä¸Šï¼‰ã€‚ç„¶è€Œï¼Œè¿™ä¸ªè¿‡ç¨‹ä¼šå¢åŠ æŸäº›å¯†é›†ä½¿ç”¨åå°„ï¼ˆä½†æ¯ä¸ªç±»ä»…ä¸€æ¬¡ï¼‰æ¥å¼•å¯¼è‡ªèº«çš„åº”ç”¨ç¨‹åºçš„å¯åŠ¨æ—¶é—´ã€‚ä¸ºäº†é¿å…è¿™ç§æ€§èƒ½æŸè€—ï¼Œæˆ‘ä»¬åœ¨æ–¹æ³•å’Œæ„é€ å‡½æ•°çš„å‰å‡ æ¬¡è°ƒç”¨ä¸­é‡ç”¨ç°æœ‰çš„JVMå…¥å£ç‚¹ï¼Œç„¶ååˆ‡æ¢åˆ°åŸºäºå­—èŠ‚ç çš„å®ç°</p>
<p><code>Method.invoke()</code> çš„æœ€åï¼Œè°ƒç”¨ <code>MethodAccessor#invoke</code> å®ç°æ–¹æ³•çš„è°ƒç”¨</p>
<h3 id="AOP"><a href="#AOP" class="headerlink" title="AOP"></a>AOP</h3><p>è¯´å®Œäº†å‰ç½®çŸ¥è¯†ï¼Œç»ˆäºå¯ä»¥å¼€å§‹æ­£é¢˜äº†</p>
<p>åœ¨ä¼ ç»Ÿçš„é¢å‘å¯¹è±¡ç¼–ç¨‹ä¸­ï¼Œç³»ç»Ÿçš„åŠŸèƒ½é€šå¸¸ä»¥å¯¹è±¡çš„å½¢å¼ç»„ç»‡ï¼Œä½†æŸäº›åŠŸèƒ½å¯èƒ½ä¼šæ•£å¸ƒåœ¨æ•´ä¸ªåº”ç”¨ç¨‹åºä¸­ï¼Œè€Œä¸å±€é™äºå•ä¸ªå¯¹è±¡æˆ–ç±»ã€‚è¿™äº›åŠŸèƒ½è¢«ç§°ä¸ºæ¨ªåˆ‡å…³æ³¨ç‚¹ï¼Œå¦‚æ—¥å¿—è®°å½•ã€å®‰å…¨æ€§ã€äº‹åŠ¡å¤„ç†ç­‰ã€‚AOPçš„ç›®æ ‡å°±æ˜¯é€šè¿‡æŠŠè¿™äº›æ¨ªåˆ‡å…³æ³¨ç‚¹ä»æ ¸å¿ƒä¸šåŠ¡é€»è¾‘ä¸­åˆ†ç¦»å‡ºæ¥ï¼Œå½¢æˆç‹¬ç«‹çš„æ¨¡å—ï¼Œå¹¶é€šè¿‡ç‰¹å®šçš„æ–¹å¼å°†å…¶ç»‡å…¥åˆ°åº”ç”¨ç¨‹åºä¸­ã€‚é€šä¿—ä¸€ç‚¹è¡¨è¾¾å°±æ˜¯ï¼š<strong>AOP è¦å®ç°çš„æ˜¯åœ¨æˆ‘ä»¬åŸæ¥å†™çš„ä»£ç çš„åŸºç¡€ä¸Šï¼Œè¿›è¡Œä¸€å®šçš„åŒ…è£…ï¼Œå¦‚åœ¨æ–¹æ³•æ‰§è¡Œå‰ã€æ–¹æ³•è¿”å›åã€æ–¹æ³•æŠ›å‡ºå¼‚å¸¸åç­‰åœ°æ–¹è¿›è¡Œä¸€å®šçš„æ‹¦æˆªå¤„ç†æˆ–è€…å«å¢å¼ºå¤„ç†</strong></p>
<p>ä½œä¸º Java å¼€å‘è€…éƒ½å¾ˆç†Ÿæ‚‰ <strong>AspectJ</strong> è¿™ä¸ªè¯ï¼Œç”šè‡³äºåœ¨æåˆ° AOP çš„æ—¶å€™ï¼Œæƒ³åˆ°çš„å¾€å¾€å°±æ˜¯ AspectJã€‚è¿™é‡Œç®€å•çš„å°† AspectJ å’Œ Spring AOP åšä¸ªå¯¹æ¯”ï¼š</p>
<h5 id="Spring-AOPï¼š"><a href="#Spring-AOPï¼š" class="headerlink" title="Spring AOPï¼š"></a><strong>Spring AOPï¼š</strong></h5><ul>
<li>å®ƒåŸºäºåŠ¨æ€ä»£ç†æ¥å®ç°ã€‚é»˜è®¤æ¥è¯´ï¼Œå¦‚æœä½¿ç”¨æ¥å£ï¼Œå®ƒä¼šé‡‡ç”¨ JDK æä¾›çš„åŠ¨æ€ä»£ç†å®ç°ï¼Œå¦‚æœæ²¡æœ‰æ¥å£ï¼Œåˆ™ä¼šä½¿ç”¨ CGLib å®ç°</li>
<li>Spring 3.2 ä»¥åï¼Œspring-core ç›´æ¥å°±æŠŠ CGLIB å’Œ ASM çš„æºç åŒ…æ‹¬è¿›æ¥äº†ï¼Œæ‰€ä»¥å¹³æ—¶å¼€å‘æ—¶ä¸éœ€è¦æ˜¾å¼å¼•å…¥è¿™ä¸¤ä¸ªä¾èµ–</li>
<li>å¦‚æœä½ æ˜¯ web å¼€å‘è€…ï¼Œæœ‰äº›æ—¶å€™å¯èƒ½éœ€è¦çš„æ˜¯ä¸€ä¸ª Filter æˆ–ä¸€ä¸ª Interceptorï¼Œè€Œä¸ä¸€å®šæ˜¯ AOP</li>
<li>Spring AOP åªèƒ½ä½œç”¨äº Spring å®¹å™¨ä¸­çš„ Beanï¼Œå®ƒæ˜¯ä½¿ç”¨çº¯ç²¹çš„ Java ä»£ç å®ç°çš„ï¼Œåªèƒ½ä½œç”¨äº bean çš„æ–¹æ³•</li>
<li>Spring æä¾›äº† AspectJ çš„æ”¯æŒï¼Œä½†ä¸€èˆ¬æ¥è¯´åªç”¨ Spring AOP å°±å¤Ÿ</li>
<li>å¾ˆå¤šäººä¼šå¯¹æ¯” Spring AOP å’Œ AspectJ çš„æ€§èƒ½ï¼ŒSpring AOP æ˜¯åŸºäºä»£ç†å®ç°çš„ï¼Œåœ¨å®¹å™¨å¯åŠ¨çš„æ—¶å€™éœ€è¦ç”Ÿæˆä»£ç†å®ä¾‹ï¼Œåœ¨æ–¹æ³•è°ƒç”¨ä¸Šä¹Ÿä¼šå¢åŠ æ ˆçš„æ·±åº¦ï¼Œä½¿å¾— Spring AOP çš„æ€§èƒ½ä¸å¦‚ AspectJ é‚£ä¹ˆå¥½</li>
</ul>
<h5 id="AspectJï¼š"><a href="#AspectJï¼š" class="headerlink" title="AspectJï¼š"></a><strong>AspectJï¼š</strong></h5><ul>
<li><p>AspectJ å‡ºèº«ä¹Ÿæ˜¯åé—¨ï¼Œæ¥è‡ªäº Eclipse åŸºé‡‘ä¼šï¼Œ<a target="_blank" rel="noopener" href="https://www.eclipse.org/aspectj">https://www.eclipse.org/aspectj</a></p>
</li>
<li><p>å±äºé™æ€ç»‡å…¥ï¼Œå®ƒæ˜¯é€šè¿‡ä¿®æ”¹ä»£ç æ¥å®ç°çš„ï¼Œå®ƒçš„ç»‡å…¥æ—¶æœºå¯ä»¥æ˜¯ï¼š</p>
<ul>
<li><em><strong>Compile-time weaving</strong></em>ï¼šç¼–è¯‘æœŸç»‡å…¥ï¼Œå¦‚ç±» A ä½¿ç”¨ AspectJ æ·»åŠ äº†ä¸€ä¸ªå±æ€§ï¼Œç±» B å¼•ç”¨äº†å®ƒï¼Œè¿™ä¸ªåœºæ™¯å°±éœ€è¦ç¼–è¯‘æœŸçš„æ—¶å€™å°±è¿›è¡Œç»‡å…¥ï¼Œå¦åˆ™æ²¡æ³•ç¼–è¯‘ç±» Bã€‚</li>
<li><em><strong>Post-compile weaving</strong></em>ï¼šä¹Ÿå°±æ˜¯å·²ç»ç”Ÿæˆäº† .class æ–‡ä»¶ï¼Œæˆ–å·²ç»æ‰“æˆ jar åŒ…äº†ï¼Œè¿™ç§æƒ…å†µæˆ‘ä»¬éœ€è¦å¢å¼ºå¤„ç†çš„è¯ï¼Œå°±è¦ç”¨åˆ°ç¼–è¯‘åç»‡å…¥ã€‚</li>
<li><em><strong>Load-time weaving</strong></em>ï¼šæŒ‡çš„æ˜¯åœ¨åŠ è½½ç±»çš„æ—¶å€™è¿›è¡Œç»‡å…¥ï¼Œè¦å®ç°è¿™ä¸ªæ—¶æœŸçš„ç»‡å…¥ï¼Œæœ‰å‡ ç§å¸¸è§çš„æ–¹æ³•ã€‚1ã€è‡ªå®šä¹‰ç±»åŠ è½½å™¨æ¥å¹²è¿™ä¸ªï¼Œè¿™ä¸ªåº”è¯¥æ˜¯æœ€å®¹æ˜“æƒ³åˆ°çš„åŠæ³•ï¼Œåœ¨è¢«ç»‡å…¥ç±»åŠ è½½åˆ° JVM å‰å»å¯¹å®ƒè¿›è¡ŒåŠ è½½ï¼Œè¿™æ ·å°±å¯ä»¥åœ¨åŠ è½½çš„æ—¶å€™å®šä¹‰è¡Œä¸ºäº†ã€‚2ã€åœ¨ JVM å¯åŠ¨çš„æ—¶å€™æŒ‡å®š AspectJ æä¾›çš„ agentï¼š<code>-javaagent:xxx/xxx/aspectjweaver.jar</code>ã€‚</li>
</ul>
</li>
<li><p>AspectJ èƒ½å¹²å¾ˆå¤š Spring AOP å¹²ä¸äº†çš„äº‹æƒ…ï¼Œå®ƒæ˜¯ <strong>AOP ç¼–ç¨‹çš„å®Œå…¨è§£å†³æ–¹æ¡ˆ</strong>ã€‚Spring AOP è‡´åŠ›äºè§£å†³çš„æ˜¯ä¼ä¸šçº§å¼€å‘ä¸­æœ€æ™®éçš„ AOP éœ€æ±‚ï¼ˆæ–¹æ³•ç»‡å…¥ï¼‰ï¼Œè€Œä¸æ˜¯åŠ›æ±‚æˆä¸ºä¸€ä¸ªåƒ AspectJ ä¸€æ ·çš„ AOP ç¼–ç¨‹å®Œå…¨è§£å†³æ–¹æ¡ˆã€‚</p>
</li>
<li><p>å› ä¸º AspectJ åœ¨å®é™…ä»£ç è¿è¡Œå‰å®Œæˆäº†ç»‡å…¥ï¼Œæ‰€ä»¥å¤§å®¶ä¼šè¯´å®ƒç”Ÿæˆçš„ç±»æ˜¯æ²¡æœ‰é¢å¤–è¿è¡Œæ—¶å¼€é”€çš„</p>
</li>
</ul>
<h5 id="AOPçš„å…³é”®æ¦‚å¿µï¼š"><a href="#AOPçš„å…³é”®æ¦‚å¿µï¼š" class="headerlink" title="AOPçš„å…³é”®æ¦‚å¿µï¼š"></a><strong>AOPçš„å…³é”®æ¦‚å¿µï¼š</strong></h5><ol>
<li><p>åˆ‡é¢ï¼ˆAspectï¼‰ï¼šåˆ‡é¢æ˜¯æ¨ªåˆ‡å…³æ³¨ç‚¹çš„æŠ½è±¡è¡¨ç¤ºï¼Œå®ƒåŒ…å«äº†ä¸æŸä¸ªæ¨ªåˆ‡å…³æ³¨ç‚¹ç›¸å…³çš„ä¸€ç»„é€šç”¨åŠŸèƒ½ã€‚æ¯”å¦‚ï¼Œæ—¥å¿—è®°å½•æ˜¯ä¸€ä¸ªåˆ‡é¢ï¼Œå®ƒå¯ä»¥åŒ…å«æ—¥å¿—è¾“å‡ºçš„åŠŸèƒ½</p>
</li>
<li><p>è¿æ¥ç‚¹ï¼ˆJoin Pointï¼‰ï¼šè¿æ¥ç‚¹æ˜¯åº”ç”¨ç¨‹åºä¸­å¯èƒ½è¢«åˆ‡é¢å½±å“çš„ç‚¹ã€‚åœ¨Javaä¸­ï¼Œè¿æ¥ç‚¹é€šå¸¸è¡¨ç¤ºä¸ºæ–¹æ³•çš„æ‰§è¡Œæˆ–å¼‚å¸¸çš„æŠ›å‡º</p>
</li>
<li><p>é€šçŸ¥ï¼ˆAdviceï¼‰ï¼šé€šçŸ¥æ˜¯åˆ‡é¢åœ¨ç‰¹å®šè¿æ¥ç‚¹ä¸Šæ‰§è¡Œçš„å…·ä½“åŠ¨ä½œã€‚é€šçŸ¥åŒ…æ‹¬å‰ç½®é€šçŸ¥ï¼ˆBeforeï¼‰ã€åç½®é€šçŸ¥ï¼ˆAfterï¼‰ã€è¿”å›é€šçŸ¥ï¼ˆAfter Returningï¼‰ã€å¼‚å¸¸é€šçŸ¥ï¼ˆAfter Throwingï¼‰å’Œç¯ç»•é€šçŸ¥ï¼ˆAroundï¼‰ç­‰</p>
</li>
<li><p>åˆ‡ç‚¹ï¼ˆPointcutï¼‰ï¼šåˆ‡ç‚¹æ˜¯ä¸€ç»„è¿æ¥ç‚¹çš„é›†åˆï¼Œå®ƒå®šä¹‰äº†åˆ‡é¢åœ¨å“ªäº›è¿æ¥ç‚¹ä¸Šèµ·ä½œç”¨ã€‚åˆ‡ç‚¹ä½¿ç”¨è¡¨è¾¾å¼æ¥åŒ¹é…è¿æ¥ç‚¹ï¼Œä»è€Œç¡®å®šåœ¨å“ªäº›è¿æ¥ç‚¹ä¸Šåº”ç”¨é€šçŸ¥</p>
</li>
<li><p>å¼•å…¥ï¼ˆIntroductionï¼‰ï¼šå¼•å…¥å…è®¸åœ¨ä¸ä¿®æ”¹ä»£ç çš„æƒ…å†µä¸‹å‘ç°æœ‰ç±»æ·»åŠ æ–°çš„æ–¹æ³•å’Œå±æ€§</p>
</li>
<li><p>ç»‡å…¥ï¼ˆWeavingï¼‰ï¼šç»‡å…¥æ˜¯å°†åˆ‡é¢åº”ç”¨åˆ°ç›®æ ‡å¯¹è±¡å¹¶åˆ›å»ºæ–°çš„ä»£ç†å¯¹è±¡çš„è¿‡ç¨‹ã€‚ç»‡å…¥å¯ä»¥åœ¨ç¼–è¯‘æ—¶ã€ç±»åŠ è½½æ—¶æˆ–è¿è¡Œæ—¶è¿›è¡Œ</p>
</li>
</ol>
<h4 id="Spring-AOP"><a href="#Spring-AOP" class="headerlink" title="Spring AOP"></a>Spring AOP</h4><p>è¿™é‡Œä»‹ç»çš„ Spring AOP æ˜¯çº¯çš„ Spring ä»£ç ï¼Œå’Œ AspectJ æ²¡ä»€ä¹ˆå…³ç³»ï¼Œä½†æ˜¯ Spring å»¶ç”¨äº† AspectJ ä¸­çš„æ¦‚å¿µï¼ŒåŒ…æ‹¬ä½¿ç”¨äº† AspectJ æä¾›çš„ jar åŒ…ä¸­çš„æ³¨è§£ï¼Œä½†æ˜¯ä¸ä¾èµ–äºå…¶å®ç°åŠŸèƒ½</p>
<blockquote>
<p>åé¢ä»‹ç»çš„å¦‚ @Aspectã€@Pointcutã€@Beforeã€@After ç­‰æ³¨è§£éƒ½æ˜¯æ¥è‡ªäº AspectJï¼Œä½†æ˜¯åŠŸèƒ½çš„å®ç°æ˜¯çº¯ Spring AOP è‡ªå·±å®ç°çš„</p>
</blockquote>
<p>åœ¨ Spring çš„å®¹å™¨ä¸­ï¼Œæˆ‘ä»¬é¢å‘çš„å¯¹è±¡æ˜¯ä¸€ä¸ªä¸ªçš„ bean å®ä¾‹ã€‚æˆ‘ä»¬å¯ä»¥ç®€å•ç†è§£ bean æ˜¯ BeanDefinition çš„å®ä¾‹ï¼ŒSpring ä¼šæ ¹æ® BeanDefinition ä¸­çš„ä¿¡æ¯ä¸ºæˆ‘ä»¬ç”Ÿäº§åˆé€‚çš„ bean å®ä¾‹å‡ºæ¥</p>
<p>å½“æˆ‘ä»¬éœ€è¦ä½¿ç”¨ bean çš„æ—¶å€™ï¼Œé€šè¿‡ IOC å®¹å™¨çš„ <code>getBean()</code> æ–¹æ³•ä»å®¹å™¨ä¸­è·å– bean å®ä¾‹ï¼Œåªä¸è¿‡å¤§éƒ¨åˆ†çš„åœºæ™¯ä¸‹ï¼Œæˆ‘ä»¬éƒ½ç”¨äº†ä¾èµ–æ³¨å…¥ï¼Œæ‰€ä»¥å¾ˆå°‘æ‰‹åŠ¨è°ƒç”¨ <code>getBean()</code> æ–¹æ³•</p>
<p>Spring AOP çš„åŸç†å¾ˆç®€å•ï¼Œå°±æ˜¯<strong>åŠ¨æ€ä»£ç†</strong>ï¼Œå®ƒå’Œ AspectJ ä¸ä¸€æ ·ï¼ŒAspectJ æ˜¯ç›´æ¥ä¿®æ”¹æ‰ä½ çš„å­—èŠ‚ç </p>
<p>ä»£ç†æ¨¡å¼å¾ˆç®€å•ï¼Œ<strong>æ¥å£ + çœŸå®å®ç°ç±» + ä»£ç†ç±»</strong>ï¼Œå…¶ä¸­ <strong>çœŸå®å®ç°ç±»</strong> å’Œ <strong>ä»£ç†ç±»</strong> éƒ½è¦å®ç°æ¥å£ï¼Œå®ä¾‹åŒ–çš„æ—¶å€™è¦ä½¿ç”¨ä»£ç†ç±»ã€‚æ‰€ä»¥ï¼Œ<strong>Spring AOP éœ€è¦åšçš„æ˜¯ç”Ÿæˆè¿™ä¹ˆä¸€ä¸ªä»£ç†ç±»</strong>ï¼Œç„¶å<strong>æ›¿æ¢æ‰</strong>çœŸå®å®ç°ç±»æ¥å¯¹å¤–æä¾›æœåŠ¡</p>
<p><strong>æ›¿æ¢</strong>è¿™ä¸ªæ“ä½œåœ¨ Spring IOC å®¹å™¨ä¸­éå¸¸å®¹æ˜“å®ç°ï¼Œå°±æ˜¯åœ¨ <code>getBean()</code> çš„æ—¶å€™è¿”å›çš„å®é™…ä¸Šæ˜¯ä»£ç†ç±»çš„å®ä¾‹ï¼Œè€Œè¿™ä¸ªä»£ç†ç±»æˆ‘ä»¬è‡ªå·±æ²¡å†™ä»£ç ï¼Œ<strong>å®ƒæ˜¯ Spring é‡‡ç”¨ JDK Proxy æˆ– CGLIB åŠ¨æ€ç”Ÿæˆçš„</strong></p>
<h4 id="Spring-2-0-AspectJ-é…ç½®"><a href="#Spring-2-0-AspectJ-é…ç½®" class="headerlink" title="Spring 2.0 @AspectJ é…ç½®"></a>Spring 2.0 @AspectJ é…ç½®</h4><p>åœ¨ Spring 2.0 ä¹‹åå¼•å…¥äº† <code>@AspectJ</code> å’Œ <code>Schema-based</code> çš„ä¸¤ç§é…ç½®æ–¹å¼ï¼Œè¿™é‡Œ<strong>ä»…ä»‹ç»</strong> <code>AspectJ</code> æ³¨è§£çš„æ–¹å¼ã€‚é¦–å…ˆï¼Œæˆ‘ä»¬éœ€è¦ä¾èµ– <code>aspectjweaver.jar</code> è¿™ä¸ªåŒ…ï¼Œè¿™ä¸ªåŒ…æ¥è‡ªäº <code>AspectJ</code>ï¼š</p>
<blockquote>
<p>å¹¶ä¸æ˜¯è¯´åŸºäº AspectJ å®ç°çš„ï¼Œè€Œä»…ä»…æ˜¯ä½¿ç”¨äº† AspectJ ä¸­çš„æ¦‚å¿µï¼ŒåŒ…æ‹¬ä½¿ç”¨çš„æ³¨è§£ä¹Ÿæ˜¯ç›´æ¥æ¥è‡ªäº AspectJ çš„åŒ…</p>
</blockquote>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.aspectj<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>aspectjweaver<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>1.8.11<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br></code></pre></td></tr></table></figure>

<p>å¦‚æœæ˜¯ä½¿ç”¨ Spring Boot çš„è¯ï¼Œæ·»åŠ ä»¥ä¸‹ä¾èµ–å³å¯ï¼š</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>   <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>   <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-starter-aop<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br></code></pre></td></tr></table></figure>

<p>é¦–å…ˆï¼Œæˆ‘ä»¬éœ€è¦<strong>å¼€å¯</strong> <code>@AspectJ</code> çš„æ³¨è§£é…ç½®æ–¹å¼ï¼š</p>
<ul>
<li>ä½¿ç”¨ <code>@EnableAspectJAutoProxy</code></li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Configuration</span><br><span class="hljs-meta">@EnableAspectJAutoProxy</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">AppConfig</span> &#123;<br><br>&#125;<br></code></pre></td></tr></table></figure>

<p>ä¸€æ—¦å¼€å¯äº†ä¸Šé¢çš„é…ç½®ï¼Œé‚£ä¹ˆæ‰€æœ‰ä½¿ç”¨ @Aspect æ³¨è§£çš„ <strong>bean</strong> éƒ½ä¼šè¢« Spring å½“åš<strong>ç”¨æ¥å®ç° AOP çš„é…ç½®ç±»</strong>ï¼Œæˆ‘ä»¬ç§°ä¹‹ä¸ºä¸€ä¸ª <strong>Aspect</strong></p>
<blockquote>
<p>æ³¨æ„ï¼Œ<code>@Aspect</code> æ³¨è§£è¦ä½œç”¨åœ¨ bean ä¸Šé¢ï¼Œä¸ç®¡æ˜¯ä½¿ç”¨ <code>@Component</code> ç­‰æ³¨è§£æ–¹å¼ï¼Œè¿˜æ˜¯åœ¨ xml ä¸­é…ç½® beanï¼Œé¦–å…ˆå®ƒéœ€è¦æ˜¯ä¸€ä¸ª bean</p>
<p><strong>æœ‰äº›æ—¶å€™å¹¶ä¸éœ€è¦</strong>åŠ è¿™ä¸ªæ³¨è§£å°±èƒ½ä½¿AOPç”Ÿæ•ˆï¼ŒåŸå› æ˜¯ä¾èµ–ä¸­ç›´æ¥æˆ–è€…é—´æ¥çš„å¼•å…¥äº† <code>spring-boot-autoconfigure</code>ï¼Œè¿™æ˜¯è‡ªåŠ¨è£…é…çš„ä¾èµ–ï¼Œä¹Ÿå°±æ˜¯ä¼šè¯»å–å…¶ä¸‹çš„ <code>spring.factories</code> æ–‡ä»¶ï¼Œåœ¨è¯¥æ–‡ä»¶ä¸­æœ‰ä¸‹é¢çš„é…ç½®</p>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs properties"><span class="hljs-comment"># Auto Configure</span><br><span class="hljs-attr">org.springframework.boot.autoconfigure.EnableAutoConfiguration</span>=<span class="hljs-string">\</span><br><span class="hljs-string">org.springframework.boot.autoconfigure.admin.SpringApplicationAdminJmxAutoConfiguration,\</span><br><span class="hljs-string">org.springframework.boot.autoconfigure.aop.**AopAutoConfiguration**</span><br></code></pre></td></tr></table></figure>

<p>åˆ™ä¼šåŠ è½½ <code>AopAutoConfiguration</code> ç±»</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// Auto-configuration for Spring&#x27;s AOP support. Equivalent to enabling @EnableAspectJAutoProxy in your configuration.</span><br><span class="hljs-meta">@Configuration(proxyBeanMethods = false)</span><br><span class="hljs-meta">@ConditionalOnProperty(prefix = &quot;spring.aop&quot;, name = &quot;auto&quot;, havingValue = &quot;true&quot;, matchIfMissing = true)</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">AopAutoConfiguration</span> &#123;<br>â€‹    ....<span class="hljs-comment">// çœç•¥</span><br>&#125;<br></code></pre></td></tr></table></figure>

<p>é»˜è®¤ç­‰åŒäº <code>@EnableAspectJAutoProxy</code></p>
</blockquote>
<ol>
<li>åˆ›å»ºä¸€ä¸ªæ¥å£å’Œå®ç°ç±»ï¼š</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// æ¥å£å®šä¹‰</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">UserService</span> &#123;<br>    <span class="hljs-keyword">void</span> <span class="hljs-title function_">addUser</span><span class="hljs-params">(String username)</span>;<br>&#125;<br><br><span class="hljs-comment">// å®ç°ç±»</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">UserServiceImpl</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">UserService</span> &#123;<br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">addUser</span><span class="hljs-params">(String username)</span> &#123;<br>        <span class="hljs-comment">// æ¨¡æ‹Ÿæ·»åŠ ç”¨æˆ·çš„æ“ä½œ</span><br>        System.out.println(<span class="hljs-string">&quot;User added: &quot;</span> + username);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<ol start="2">
<li>åˆ›å»ºä¸€ä¸ªåˆ‡é¢ç±»ï¼Œç”¨äºæ·»åŠ æ¨ªåˆ‡é€»è¾‘ï¼Œå¹¶å®šä¹‰<strong>Pointcut</strong>è¡¨è¾¾å¼ï¼š</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">import</span> org.aspectj.lang.annotation.After;<br><span class="hljs-keyword">import</span> org.aspectj.lang.annotation.Aspect;<br><span class="hljs-keyword">import</span> org.aspectj.lang.annotation.Pointcut;<br><span class="hljs-keyword">import</span> org.springframework.stereotype.Component;<br><br><span class="hljs-meta">@Aspect</span><br><span class="hljs-meta">@Component</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">LoggingAspect</span> &#123;<br><br>    <span class="hljs-comment">// å®šä¹‰Pointcutè¡¨è¾¾å¼ï¼Œé€‰æ‹©com.example.UserServiceæ¥å£çš„æ‰€æœ‰æ–¹æ³•</span><br>    <span class="hljs-meta">@Pointcut(&quot;execution(* com.example.UserService.*(..))&quot;)</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">userServiceMethods</span><span class="hljs-params">()</span> &#123;&#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>æˆ‘ä»¬çœ‹åˆ°ï¼Œ<code>@Pointcut</code> ä¸­ä½¿ç”¨äº† <strong>execution</strong> æ¥æ­£åˆ™åŒ¹é…æ–¹æ³•ç­¾åï¼Œè¿™ä¹Ÿæ˜¯æœ€å¸¸ç”¨çš„ï¼Œé™¤äº† executionï¼Œæˆ‘ä»¬å†çœ‹çœ‹å…¶ä»–çš„å‡ ä¸ªæ¯”è¾ƒå¸¸ç”¨çš„åŒ¹é…æ–¹å¼ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// ä»»æ„å…¬å…±æ–¹æ³•çš„æ‰§è¡Œï¼š</span><br>executionï¼ˆ<span class="hljs-keyword">public</span> * *ï¼ˆ..ï¼‰ï¼‰<br><br><span class="hljs-comment">// ä»»ä½•ä¸€ä¸ªåå­—ä»¥â€œsetâ€å¼€å§‹çš„æ–¹æ³•çš„æ‰§è¡Œï¼š</span><br>executionï¼ˆ* set*ï¼ˆ..ï¼‰ï¼‰<br><br><span class="hljs-comment">// AccountServiceæ¥å£å®šä¹‰çš„ä»»æ„æ–¹æ³•çš„æ‰§è¡Œï¼š</span><br>executionï¼ˆ* com.xyz.service.AccountService.*ï¼ˆ..ï¼‰ï¼‰<br><br><span class="hljs-comment">// åœ¨serviceåŒ…ä¸­å®šä¹‰çš„ä»»æ„æ–¹æ³•çš„æ‰§è¡Œï¼š</span><br>executionï¼ˆ* com.xyz.service.*.*ï¼ˆ..ï¼‰ï¼‰<br><br><span class="hljs-comment">// åœ¨serviceåŒ…æˆ–å…¶å­åŒ…ä¸­å®šä¹‰çš„ä»»æ„æ–¹æ³•çš„æ‰§è¡Œï¼š</span><br>executionï¼ˆ* com.xyz.service..*.*ï¼ˆ..ï¼‰ï¼‰<br><br><span class="hljs-comment">// åœ¨serviceåŒ…ä¸­çš„ä»»æ„è¿æ¥ç‚¹ï¼ˆåœ¨Spring AOPä¸­åªæ˜¯æ–¹æ³•æ‰§è¡Œï¼‰ï¼š</span><br>withinï¼ˆcom.xyz.service.*ï¼‰<br><br><span class="hljs-comment">// åœ¨serviceåŒ…æˆ–å…¶å­åŒ…ä¸­çš„ä»»æ„è¿æ¥ç‚¹ï¼ˆåœ¨Spring AOPä¸­åªæ˜¯æ–¹æ³•æ‰§è¡Œï¼‰ï¼š</span><br>withinï¼ˆcom.xyz.service..*ï¼‰<br><br><span class="hljs-comment">// å®ç°äº†AccountServiceæ¥å£çš„ä»£ç†å¯¹è±¡çš„ä»»æ„è¿æ¥ç‚¹ ï¼ˆåœ¨Spring AOPä¸­åªæ˜¯æ–¹æ³•æ‰§è¡Œï¼‰ï¼š</span><br><span class="hljs-built_in">this</span>ï¼ˆcom.xyz.service.AccountServiceï¼‰<span class="hljs-comment">// &#x27;this&#x27;åœ¨ç»‘å®šè¡¨å•ä¸­æ›´åŠ å¸¸ç”¨</span><br><br><span class="hljs-comment">// å®ç°AccountServiceæ¥å£çš„ç›®æ ‡å¯¹è±¡çš„ä»»æ„è¿æ¥ç‚¹ ï¼ˆåœ¨Spring AOPä¸­åªæ˜¯æ–¹æ³•æ‰§è¡Œï¼‰ï¼š</span><br>targetï¼ˆcom.xyz.service.AccountServiceï¼‰ <span class="hljs-comment">// &#x27;target&#x27;åœ¨ç»‘å®šè¡¨å•ä¸­æ›´åŠ å¸¸ç”¨</span><br><br><span class="hljs-comment">// ä»»ä½•ä¸€ä¸ªåªæ¥å—ä¸€ä¸ªå‚æ•°ï¼Œå¹¶ä¸”è¿è¡Œæ—¶æ‰€ä¼ å…¥çš„å‚æ•°æ˜¯Serializable æ¥å£çš„è¿æ¥ç‚¹ï¼ˆåœ¨Spring AOPä¸­åªæ˜¯æ–¹æ³•æ‰§è¡Œï¼‰</span><br>argsï¼ˆjava.io.Serializableï¼‰ <span class="hljs-comment">// &#x27;args&#x27;åœ¨ç»‘å®šè¡¨å•ä¸­æ›´åŠ å¸¸ç”¨; è¯·æ³¨æ„åœ¨ä¾‹å­ä¸­ç»™å‡ºçš„åˆ‡å…¥ç‚¹ä¸åŒäº execution(* *(java.io.Serializable))ï¼š argsç‰ˆæœ¬åªæœ‰åœ¨åŠ¨æ€è¿è¡Œæ—¶å€™ä¼ å…¥å‚æ•°æ˜¯Serializableæ—¶æ‰åŒ¹é…ï¼Œè€Œexecutionç‰ˆæœ¬åœ¨æ–¹æ³•ç­¾åä¸­å£°æ˜åªæœ‰ä¸€ä¸ª Serializableç±»å‹çš„å‚æ•°æ—¶å€™åŒ¹é…ã€‚</span><br><br><span class="hljs-comment">// ç›®æ ‡å¯¹è±¡ä¸­æœ‰ä¸€ä¸ª @Transactional æ³¨è§£çš„ä»»æ„è¿æ¥ç‚¹ ï¼ˆåœ¨Spring AOPä¸­åªæ˜¯æ–¹æ³•æ‰§è¡Œï¼‰</span><br><span class="hljs-meta">@target</span>ï¼ˆorg.springframework.transaction.annotation.Transactionalï¼‰<span class="hljs-comment">// &#x27;@target&#x27;åœ¨ç»‘å®šè¡¨å•ä¸­æ›´åŠ å¸¸ç”¨</span><br><br><span class="hljs-comment">// ä»»ä½•ä¸€ä¸ªç›®æ ‡å¯¹è±¡å£°æ˜çš„ç±»å‹æœ‰ä¸€ä¸ª @Transactional æ³¨è§£çš„è¿æ¥ç‚¹ ï¼ˆåœ¨Spring AOPä¸­åªæ˜¯æ–¹æ³•æ‰§è¡Œï¼‰ï¼š</span><br><span class="hljs-meta">@within</span>ï¼ˆorg.springframework.transaction.annotation.Transactionalï¼‰ <span class="hljs-comment">// &#x27;@within&#x27;åœ¨ç»‘å®šè¡¨å•ä¸­æ›´åŠ å¸¸ç”¨</span><br><br><span class="hljs-comment">// ä»»ä½•ä¸€ä¸ªæ‰§è¡Œçš„æ–¹æ³•æœ‰ä¸€ä¸ª @Transactional æ³¨è§£çš„è¿æ¥ç‚¹ ï¼ˆåœ¨Spring AOPä¸­åªæ˜¯æ–¹æ³•æ‰§è¡Œï¼‰</span><br><span class="hljs-meta">@annotation</span>ï¼ˆorg.springframework.transaction.annotation.Transactionalï¼‰ <span class="hljs-comment">// &#x27;@annotation&#x27;åœ¨ç»‘å®šè¡¨å•ä¸­æ›´åŠ å¸¸ç”¨</span><br><br><span class="hljs-comment">// ä»»ä½•ä¸€ä¸ªåªæ¥å—ä¸€ä¸ªå‚æ•°ï¼Œå¹¶ä¸”è¿è¡Œæ—¶æ‰€ä¼ å…¥çš„å‚æ•°ç±»å‹å…·æœ‰@Classified æ³¨è§£çš„è¿æ¥ç‚¹ï¼ˆåœ¨Spring AOPä¸­åªæ˜¯æ–¹æ³•æ‰§è¡Œï¼‰</span><br><span class="hljs-meta">@args</span>ï¼ˆcom.xyz.security.Classifiedï¼‰ <span class="hljs-comment">// &#x27;@args&#x27;åœ¨ç»‘å®šè¡¨å•ä¸­æ›´åŠ å¸¸ç”¨</span><br><br><span class="hljs-comment">// ä»»ä½•ä¸€ä¸ªåœ¨åä¸º&#x27;tradeService&#x27;çš„Spring beanä¹‹ä¸Šçš„è¿æ¥ç‚¹ ï¼ˆåœ¨Spring AOPä¸­åªæ˜¯æ–¹æ³•æ‰§è¡Œï¼‰</span><br>beanï¼ˆtradeServiceï¼‰<br><br><span class="hljs-comment">// ä»»ä½•ä¸€ä¸ªåœ¨åå­—åŒ¹é…é€šé…ç¬¦è¡¨è¾¾å¼&#x27;*Service&#x27;çš„Spring beanä¹‹ä¸Šçš„è¿æ¥ç‚¹ ï¼ˆåœ¨Spring AOPä¸­åªæ˜¯æ–¹æ³•æ‰§è¡Œï¼‰</span><br>beanï¼ˆ*Serviceï¼‰<br></code></pre></td></tr></table></figure>

<p>æ­¤å¤–Spring æ”¯æŒå¦‚ä¸‹ä¸‰ä¸ªé€»è¾‘è¿ç®—ç¬¦æ¥ç»„åˆåˆ‡å…¥ç‚¹è¡¨è¾¾å¼</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs java">&amp;&amp;ï¼šè¦æ±‚è¿æ¥ç‚¹åŒæ—¶åŒ¹é…ä¸¤ä¸ªåˆ‡å…¥ç‚¹è¡¨è¾¾å¼<br>||ï¼šè¦æ±‚è¿æ¥ç‚¹åŒ¹é…ä»»æ„ä¸ªåˆ‡å…¥ç‚¹è¡¨è¾¾å¼<br>!:ï¼šè¦æ±‚è¿æ¥ç‚¹ä¸åŒ¹é…æŒ‡å®šçš„åˆ‡å…¥ç‚¹è¡¨è¾¾å¼<br></code></pre></td></tr></table></figure>

<p>Spring AOP ç”¨æˆ·å¯èƒ½ä¼šç»å¸¸ä½¿ç”¨ execution åˆ‡å…¥ç‚¹æŒ‡ç¤ºç¬¦ã€‚æ‰§è¡Œè¡¨è¾¾å¼çš„æ ¼å¼å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java">executionï¼ˆmodifiers-pattern? ret-type-pattern declaring-type-pattern? name-patternï¼ˆparam-patternï¼‰ <span class="hljs-keyword">throws</span>-pattern?ï¼‰<br></code></pre></td></tr></table></figure>

<ul>
<li>ret-type-pattern è¿”å›ç±»å‹æ¨¡å¼, name-patternåå­—æ¨¡å¼å’Œparam-patternå‚æ•°æ¨¡å¼æ˜¯å¿…é€‰çš„ï¼Œ å…¶å®ƒéƒ¨åˆ†éƒ½æ˜¯å¯é€‰çš„ã€‚è¿”å›ç±»å‹æ¨¡å¼å†³å®šäº†æ–¹æ³•çš„è¿”å›ç±»å‹å¿…é¡»ä¾æ¬¡åŒ¹é…ä¸€ä¸ªè¿æ¥ç‚¹ã€‚ ä½ ä¼šä½¿ç”¨çš„æœ€é¢‘ç¹çš„è¿”å›ç±»å‹æ¨¡å¼æ˜¯<code>*</code>ï¼Œ<strong>å®ƒä»£è¡¨äº†åŒ¹é…ä»»æ„çš„è¿”å›ç±»å‹</strong>ã€‚</li>
<li>declaring-type-pattern, ä¸€ä¸ªå…¨é™å®šçš„ç±»å‹åå°†åªä¼šåŒ¹é…è¿”å›ç»™å®šç±»å‹çš„æ–¹æ³•ã€‚</li>
<li>name-pattern åå­—æ¨¡å¼åŒ¹é…çš„æ˜¯æ–¹æ³•åã€‚ ä½ å¯ä»¥ä½¿ç”¨<code>*</code>é€šé…ç¬¦ä½œä¸ºæ‰€æœ‰æˆ–è€…éƒ¨åˆ†å‘½åæ¨¡å¼ã€‚</li>
<li>param-pattern å‚æ•°æ¨¡å¼ç¨å¾®æœ‰ç‚¹å¤æ‚ï¼š()åŒ¹é…äº†ä¸€ä¸ªä¸æ¥å—ä»»ä½•å‚æ•°çš„æ–¹æ³•ï¼Œ è€Œ(..)åŒ¹é…äº†ä¸€ä¸ªæ¥å—ä»»æ„æ•°é‡å‚æ•°çš„æ–¹æ³•ï¼ˆé›¶æˆ–è€…æ›´å¤šï¼‰ã€‚ æ¨¡å¼(<em>)åŒ¹é…äº†ä¸€ä¸ªæ¥å—ä¸€ä¸ªä»»ä½•ç±»å‹çš„å‚æ•°çš„æ–¹æ³•ã€‚ æ¨¡å¼(</em>,String)åŒ¹é…äº†ä¸€ä¸ªæ¥å—ä¸¤ä¸ªå‚æ•°çš„æ–¹æ³•ï¼Œç¬¬ä¸€ä¸ªå¯ä»¥æ˜¯ä»»æ„ç±»å‹ï¼Œ ç¬¬äºŒä¸ªåˆ™å¿…é¡»æ˜¯Stringç±»å‹</li>
</ul>
<p>ä¸Šé¢åŒ¹é…ä¸­ï¼Œé€šå¸¸ â€œ.â€ ä»£è¡¨ä¸€ä¸ªåŒ…åï¼Œâ€..â€ ä»£è¡¨åŒ…åŠå…¶å­åŒ…ï¼Œæ–¹æ³•å‚æ•°ä»»æ„åŒ¹é…ä½¿ç”¨ä¸¤ä¸ªç‚¹ â€œ..â€</p>
<ol start="3">
<li><strong>é…ç½® Advice</strong></li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Aspect</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">AdviceExample</span> &#123;<br><br>    <span class="hljs-comment">// ä½¿ç”¨å®šä¹‰çš„Pointcutï¼Œåœ¨æ‰€æœ‰æ–¹æ³•æ‰§è¡Œåæ·»åŠ é¢å¤–é€»è¾‘</span><br>    <span class="hljs-meta">@After(&quot;com.javadoop.aop.LoggingAspect.userServiceMethods()&quot;)</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">logAfterExecution</span><span class="hljs-params">()</span> &#123;<br>        System.out.println(<span class="hljs-string">&quot;Method execution completed.&quot;</span>);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<ol start="4">
<li>åˆ›å»ºä¸€ä¸ªç®€å•çš„Mainç±»æ¥æµ‹è¯•ï¼š</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">import</span> org.springframework.context.ApplicationContext;<br><span class="hljs-keyword">import</span> org.springframework.context.support.ClassPathXmlApplicationContext;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Main</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br>        <span class="hljs-type">ApplicationContext</span> <span class="hljs-variable">context</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ClassPathXmlApplicationContext</span>(<span class="hljs-string">&quot;applicationContext.xml&quot;</span>);<br>        <span class="hljs-type">UserService</span> <span class="hljs-variable">userService</span> <span class="hljs-operator">=</span> (UserService) context.getBean(<span class="hljs-string">&quot;userService&quot;</span>);<br><br>        userService.addUser(<span class="hljs-string">&quot;John Doe&quot;</span>);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>åœ¨è¿è¡ŒMainç±»æ—¶ï¼Œä½ å°†çœ‹åˆ°ç±»ä¼¼ä»¥ä¸‹è¾“å‡ºï¼š</p>
<figure class="highlight oxygene"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs oxygene">User added: John Doe<br><span class="hljs-keyword">Method</span> <span class="hljs-title function_">execution</span> <span class="hljs-title function_">completed</span>.<br></code></pre></td></tr></table></figure>

<p>è¿™è¡¨æ˜ <code>addUser</code> æ–¹æ³•æ‰§è¡Œåï¼Œåˆ‡é¢ä¸­å®šä¹‰çš„ <code>logAfterExecution</code> æ–¹æ³•è¢«è°ƒç”¨ã€‚ä½¿ç”¨ <code>Pointcut</code>ï¼Œä½ å¯ä»¥æ›´ç»†ç²’åº¦åœ°æ§åˆ¶åˆ‡å…¥ç‚¹ï¼Œè€Œä¸æ˜¯ç›´æ¥åœ¨ç‰¹å®šæ–¹æ³•ä¸Šå®šä¹‰åˆ‡é¢é€»è¾‘</p>
<p>å¦‚æœ <code>Advice</code> æ–¹æ³•éœ€è¦è·å–å…¥å‚ï¼ŒSpring æä¾›äº†éå¸¸ç®€å•çš„è·å–å…¥å‚çš„æ–¹æ³•ï¼Œä½¿ç”¨ <code>org.aspectj.lang.JoinPoint</code> ä½œä¸º <code>Advice</code> çš„ç¬¬ä¸€ä¸ªå‚æ•°å³å¯ï¼Œå¦‚ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Before(&quot;com.javadoop.aop.LoggingAspect.userServiceMethods()&quot;)</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">logArgs</span><span class="hljs-params">(JoinPoint joinPoint)</span> &#123;<br>    System.out.println(<span class="hljs-string">&quot;æ–¹æ³•æ‰§è¡Œå‰ï¼Œæ‰“å°å…¥å‚ï¼š&quot;</span> + Arrays.toString(joinPoint.getArgs()));<br>&#125;<br></code></pre></td></tr></table></figure>

<blockquote>
<p>æ³¨æ„ <code>org.aspectj.lang.JoinPoint</code> çš„ä½¿ç”¨æ–¹æ³•ï¼š</p>
<ul>
<li>å¿…é¡»æ”¾ç½®åœ¨ç¬¬ä¸€ä¸ªå‚æ•°ä¸Š</li>
<li>å¦‚æœæ˜¯ @Aroundï¼Œæˆ‘ä»¬é€šå¸¸ä¼šä½¿ç”¨å…¶å­ç±» <code>ProceedingJoinPoint</code>ï¼Œå› ä¸ºå®ƒæœ‰ <code>procceed()</code>&#x2F; <code>procceed(args[])</code> æ–¹æ³•ã€‚</li>
</ul>
</blockquote>
<h4 id="AOPçš„åŸç†"><a href="#AOPçš„åŸç†" class="headerlink" title="AOPçš„åŸç†"></a>AOPçš„åŸç†</h4><p>æ‰€ä»¥ç†è§£Spring AOPçš„åˆå§‹åŒ–å¿…é¡»è¦å…ˆç†è§£Spring IOCçš„åˆå§‹åŒ–</p>
<h5 id="åŸºäºæ³¨è§£çš„åˆ‡é¢ä»£ç†åˆ›å»º"><a href="#åŸºäºæ³¨è§£çš„åˆ‡é¢ä»£ç†åˆ›å»º" class="headerlink" title="åŸºäºæ³¨è§£çš„åˆ‡é¢ä»£ç†åˆ›å»º"></a>åŸºäºæ³¨è§£çš„åˆ‡é¢ä»£ç†åˆ›å»º</h5><p>è¿™é‡Œç›´æ¥ä»ä¹‹å‰è¯´åˆ°çš„ <code>@EnableAspectJAutoProxy</code> åˆ‡å…¥ï¼Œå®ƒ @import äº† <code>AspectJAutoProxyRegistrar.class</code>  </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">class</span> <span class="hljs-title class_">AspectJAutoProxyRegistrar</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">ImportBeanDefinitionRegistrar</span> &#123;<br><br>	<span class="hljs-comment">/**</span><br><span class="hljs-comment">	 * Register, escalate, and configure the AspectJ auto proxy creator based on the value</span><br><span class="hljs-comment">	 * of the @&#123;<span class="hljs-doctag">@link</span> EnableAspectJAutoProxy#proxyTargetClass()&#125; attribute on the importing</span><br><span class="hljs-comment">	 * &#123;<span class="hljs-doctag">@code</span> <span class="hljs-doctag">@Configuration</span>&#125; class.</span><br><span class="hljs-comment">	 */</span><br>	<span class="hljs-meta">@Override</span><br>	<span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">registerBeanDefinitions</span><span class="hljs-params">(</span><br><span class="hljs-params">			AnnotationMetadata importingClassMetadata, BeanDefinitionRegistry registry)</span> &#123;<br><br>    <span class="hljs-comment">// æ³¨å†Œ AspectJAnnotationAutoProxyCreatorï¼Œå¦‚æœéœ€è¦çš„è¯</span><br>		AopConfigUtils.registerAspectJAnnotationAutoProxyCreatorIfNecessary(registry);<br>    ... <span class="hljs-comment">// çœç•¥</span><br>&#125;<br></code></pre></td></tr></table></figure>

<p><code>AopConfigUtils.registerAspectJAnnotationAutoProxyCreatorIfNecessary(registry)</code> è¿™ä¸ªæ–¹æ³•ç‚¹è¿›å»</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> BeanDefinition <span class="hljs-title function_">registerAspectJAnnotationAutoProxyCreatorIfNecessary</span><span class="hljs-params">(BeanDefinitionRegistry registry)</span> &#123;<br>	<span class="hljs-keyword">return</span> registerAspectJAnnotationAutoProxyCreatorIfNecessary(registry, <span class="hljs-literal">null</span>);<br>&#125;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> BeanDefinition <span class="hljs-title function_">registerAspectJAnnotationAutoProxyCreatorIfNecessary</span><span class="hljs-params">(</span><br><span class="hljs-params">		BeanDefinitionRegistry registry, <span class="hljs-meta">@Nullable</span> Object source)</span> &#123;<br><br>   <span class="hljs-comment">// æ³¨å†Œ AnnotationAwareAspectJAutoProxyCreator.class</span><br>	<span class="hljs-keyword">return</span> registerOrEscalateApcAsRequired(AnnotationAwareAspectJAutoProxyCreator.class, registry, source);<br>&#125;<br><br><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> BeanDefinition <span class="hljs-title function_">registerOrEscalateApcAsRequired</span><span class="hljs-params">(</span><br><span class="hljs-params">		Class&lt;?&gt; cls, BeanDefinitionRegistry registry, <span class="hljs-meta">@Nullable</span> Object source)</span> &#123;<br><br>	Assert.notNull(registry, <span class="hljs-string">&quot;BeanDefinitionRegistry must not be null&quot;</span>);<br><br>   <span class="hljs-comment">// å¦‚æœåä¸º org.springframework.aop.config.internalAutoProxyCreator çš„ bean å·²ç»åœ¨å†Œ</span><br>	<span class="hljs-keyword">if</span> (registry.containsBeanDefinition(AUTO_PROXY_CREATOR_BEAN_NAME)) &#123;<br>		<span class="hljs-type">BeanDefinition</span> <span class="hljs-variable">apcDefinition</span> <span class="hljs-operator">=</span> registry.getBeanDefinition(AUTO_PROXY_CREATOR_BEAN_NAME);<br>     <span class="hljs-comment">// å·²ç»åœ¨å†Œçš„ ProxyCreator ä¸å½“å‰æœŸæœ›çš„ç±»å‹ä¸ä¸€è‡´ï¼Œåˆ™ä¾æ®ä¼˜å…ˆçº§è¿›è¡Œé€‰æ‹©</span><br>		<span class="hljs-keyword">if</span> (!cls.getName().equals(apcDefinition.getBeanClassName())) &#123;<br>			<span class="hljs-type">int</span> <span class="hljs-variable">currentPriority</span> <span class="hljs-operator">=</span> findPriorityForClass(apcDefinition.getBeanClassName());<br>			<span class="hljs-type">int</span> <span class="hljs-variable">requiredPriority</span> <span class="hljs-operator">=</span> findPriorityForClass(cls);<br>       <span class="hljs-comment">// é€‰æ‹©ä¼˜å…ˆçº§é«˜çš„ ProxyCreator æ›´æ–°æ³¨å†Œ</span><br>			<span class="hljs-keyword">if</span> (currentPriority &lt; requiredPriority) &#123;<br>				apcDefinition.setBeanClassName(cls.getName());<br>			&#125;<br>		&#125;<br>		<span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>	&#125;<br><br>   <span class="hljs-comment">// æ²¡æœ‰å¯¹åº”åœ¨å†Œçš„ ProxyCreatorï¼Œæ³¨å†Œä¸€ä¸ªæ–°çš„</span><br>	<span class="hljs-type">RootBeanDefinition</span> <span class="hljs-variable">beanDefinition</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RootBeanDefinition</span>(cls);<br>	beanDefinition.setSource(source);<br>	beanDefinition.getPropertyValues().add(<span class="hljs-string">&quot;order&quot;</span>, Ordered.HIGHEST_PRECEDENCE);<br>	beanDefinition.setRole(BeanDefinition.ROLE_INFRASTRUCTURE);<br>	registry.registerBeanDefinition(AUTO_PROXY_CREATOR_BEAN_NAME, beanDefinition);<br>	<span class="hljs-keyword">return</span> beanDefinition;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>æ€»ç»“ä¸‹æ¥å°±æ˜¯æ³¨å†Œäº†ä¸€ä¸ªåä¸º <code>org.springframework.aop.config.internalAutoProxyCreator</code> çš„ <code>BeanDefinition</code>ï¼Œæˆ‘ä»¬ç§°ä¹‹ä¸ºä»£ç†åˆ›å»ºå™¨ï¼ˆ<em>ProxyCreator</em>ï¼‰ã€‚è¿™é‡Œä½¿ç”¨çš„é»˜è®¤å®ç°ä¸º <code>AnnotationAwareAspectJAutoProxyCreator.class</code> ç±»ï¼Œå¦‚æœå­˜åœ¨å¤šä¸ªå€™é€‰å®ç°ï¼Œåˆ™é€‰æ‹©ä¼˜å…ˆçº§æœ€é«˜çš„è¿›è¡Œæ³¨å†Œ</p>
<p>ç„¶åæ˜¯ <code>AspectJAutoProxyRegistrar#registerBeanDefinitions</code> åé¢çœç•¥çš„éƒ¨åˆ†æ˜¯ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">if</span> (enableAspectJAutoProxy != <span class="hljs-literal">null</span>) &#123;<br>			<span class="hljs-keyword">if</span> (enableAspectJAutoProxy.getBoolean(<span class="hljs-string">&quot;proxyTargetClass&quot;</span>)) &#123;<br>				AopConfigUtils.forceAutoProxyCreatorToUseClassProxying(registry);<br>			&#125;<br>			<span class="hljs-keyword">if</span> (enableAspectJAutoProxy.getBoolean(<span class="hljs-string">&quot;exposeProxy&quot;</span>)) &#123;<br>				AopConfigUtils.forceAutoProxyCreatorToExposeProxy(registry);<br>			&#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>è¿™é‡Œé…ç½®çš„ <code>proxy-target-class</code> å’Œ <code>expose-proxy</code> å±æ€§æ·»åŠ åˆ°å¯¹åº” BeanDefinition çš„å±æ€§åˆ—è¡¨ä¸­</p>
<p>è¿™æ˜¯ <code>AnnotationAwareAspectJAutoProxyCreator</code> çš„ç»§æ‰¿å…³ç³»å›¾ï¼š</p>
<p><img src="/posts/59835/image-20230721185238617.png" srcset="/img/loading.gif" lazyload alt="image-20230721185238617"></p>
<p>çœ‹å¾—å‡ºå®ƒå®ç°äº†ä¸¤ç±»æ¥å£ï¼š<code>BeanPostProcessor</code> å’Œ <code>Aware</code></p>
<p><code>BeanPostProcessor</code> æ¥å£æˆ‘ä»¬çŸ¥é“åœ¨å®¹å™¨å¯åŠ¨è¿‡ç¨‹ä¸­ä¼šåœ¨åˆå§‹åŒ– bean å®ä¾‹çš„å‰ååˆ†åˆ«è°ƒç”¨ <code>BeanPostProcessor</code> ä¸­å®šä¹‰çš„ <code>postProcessBeforeInitialization()</code> å’Œ <code>postProcessAfterInitialization()</code> ä¸¤ä¸ªæ–¹æ³•ã€‚é’ˆå¯¹è¿™ä¸¤ä¸ªæ–¹æ³•çš„å®ç°ä¸»è¦ä½äºç»§æ‰¿é“¾çš„ <code>AbstractAutoProxyCreator</code> ç±»ä¸­ï¼Œå¹¶ä¸”<strong>ä¸»è¦æ˜¯</strong>å®ç°äº† <code>BeanPostProcessor#postProcessAfterInitialization</code> æ–¹æ³•ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * Create a proxy with the configured interceptors if the bean is</span><br><span class="hljs-comment"> * identified as one to proxy by the subclass.</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@see</span> #getAdvicesAndAdvisorsForBean</span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">@Override</span><br><span class="hljs-keyword">public</span> Object <span class="hljs-title function_">postProcessAfterInitialization</span><span class="hljs-params">(<span class="hljs-meta">@Nullable</span> Object bean, String beanName)</span> &#123;<br>	<span class="hljs-keyword">if</span> (bean != <span class="hljs-literal">null</span>) &#123;<br>     <span class="hljs-comment">// å¦‚æœ beanName ä¸ä¸ºç©ºåˆ™ç›´æ¥ä½¿ç”¨ beanNameï¼ˆFactoryBean åˆ™ä½¿ç”¨ &amp;&#123;beanName&#125;ï¼‰ï¼Œå¦åˆ™ä½¿ç”¨ bean çš„ className</span><br>		<span class="hljs-type">Object</span> <span class="hljs-variable">cacheKey</span> <span class="hljs-operator">=</span> getCacheKey(bean.getClass(), beanName);<br>		<span class="hljs-keyword">if</span> (<span class="hljs-built_in">this</span>.earlyProxyReferences.remove(cacheKey) != bean) &#123;<br>       <span class="hljs-comment">// å°è¯•å¯¹ bean è¿›è¡Œå¢å¼ºï¼Œåˆ›å»ºè¿”å›å¢å¼ºåçš„ä»£ç†å¯¹è±¡</span><br>			<span class="hljs-keyword">return</span> wrapIfNecessary(bean, beanName, cacheKey);<br>		&#125;<br>	&#125;<br>	<span class="hljs-keyword">return</span> bean;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>è¯¥æ–¹æ³•çš„æ ¸å¿ƒåœ¨äºè°ƒç”¨ <code>AbstractAutoProxyCreator#wrapIfNecessary</code> æ–¹æ³•ï¼Œå°è¯•åŸºäº AOP é…ç½®å¯¹å½“å‰ bean è¿›è¡Œå¢å¼ºï¼Œå¹¶è¿”å›å¢å¼ºåçš„ä»£ç†å¯¹è±¡ã€‚æ–¹æ³• <code>AbstractAutoProxyCreator#wrapIfNecessary</code> çš„å®ç°å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">protected</span> Object <span class="hljs-title function_">wrapIfNecessary</span><span class="hljs-params">(Object bean, String beanName, Object cacheKey)</span> &#123;<br>	<span class="hljs-comment">// å·²ç»å¤„ç†è¿‡ï¼Œç›´æ¥è¿”å›</span><br>   <span class="hljs-keyword">if</span> (StringUtils.hasLength(beanName) &amp;&amp; <span class="hljs-built_in">this</span>.targetSourcedBeans.contains(beanName)) &#123;<br>		<span class="hljs-keyword">return</span> bean;<br>	&#125;<br>   <span class="hljs-comment">// ä¸éœ€è¦è¿›è¡Œå¢å¼ºçš„ bean å®ä¾‹ï¼Œç›´æ¥è·³è¿‡</span><br>	<span class="hljs-keyword">if</span> (Boolean.FALSE.equals(<span class="hljs-built_in">this</span>.advisedBeans.get(cacheKey))) &#123;<br>		<span class="hljs-keyword">return</span> bean;<br>	&#125;<br>   <span class="hljs-comment">// å¯¹äº AOP çš„åŸºç¡€æ”¯æ’‘ç±»ï¼Œæˆ–è€…æŒ‡å®šä¸éœ€è¦è¢«ä»£ç†çš„ç±»ï¼Œè®¾ç½®ä¸ºä¸è¿›è¡Œä»£ç†</span><br>	<span class="hljs-keyword">if</span> (isInfrastructureClass(bean.getClass()) || shouldSkip(bean.getClass(), beanName)) &#123;<br>		<span class="hljs-built_in">this</span>.advisedBeans.put(cacheKey, Boolean.FALSE);<br>		<span class="hljs-keyword">return</span> bean;<br>	&#125;<br><br>	<span class="hljs-comment">// Create proxy if we have advice.</span><br>   <span class="hljs-comment">// è·å–é€‚ç”¨äºå½“å‰ bean çš„ Advisor</span><br>	Object[] specificInterceptors = getAdvicesAndAdvisorsForBean(bean.getClass(), beanName, <span class="hljs-literal">null</span>);<br>   <span class="hljs-comment">// åŸºäºè·å–åˆ°çš„ Advisor ä¸ºå½“å‰ bean åˆ›å»ºä»£ç†å¯¹è±¡</span><br>	<span class="hljs-keyword">if</span> (specificInterceptors != DO_NOT_PROXY) &#123;<br>		<span class="hljs-built_in">this</span>.advisedBeans.put(cacheKey, Boolean.TRUE);<br>     <span class="hljs-comment">// åˆ›å»ºä»£ç†å¯¹è±¡</span><br>		<span class="hljs-type">Object</span> <span class="hljs-variable">proxy</span> <span class="hljs-operator">=</span> createProxy(<br>				bean.getClass(), beanName, specificInterceptors, <span class="hljs-keyword">new</span> <span class="hljs-title class_">SingletonTargetSource</span>(bean));<br>		<span class="hljs-built_in">this</span>.proxyTypes.put(cacheKey, proxy.getClass());<br>		<span class="hljs-keyword">return</span> proxy;<br>	&#125;<br><br>	<span class="hljs-built_in">this</span>.advisedBeans.put(cacheKey, Boolean.FALSE);<br>	<span class="hljs-keyword">return</span> bean;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>ä¸Šè¿°æ–¹æ³•ä¸»è¦çš„å·¥ä½œæ˜¯å¯¹ bean å®ä¾‹è¿›è¡Œç­›é€‰ï¼Œè¿‡æ»¤æ‰é‚£äº›å·²ç»å¢å¼ºè¿‡çš„ã€æ”¯æŒ AOP åŸºç¡€è¿è¡Œçš„ï¼Œä»¥åŠæŒ‡å®šä¸éœ€è¦è¢«ä»£ç†çš„ bean å®ä¾‹ã€‚å¯¹äºå‰©ä¸‹çš„ bean å®ä¾‹æ¥è¯´ï¼Œé¦–å…ˆä¼šè°ƒç”¨ <code>AbstractAdvisorAutoProxyCreator#getAdvicesAndAdvisorsForBean</code> æ–¹æ³•è·å–é€‚ç”¨äºå½“å‰ bean çš„å¢å¼ºå™¨ï¼ˆ<em>Advisor</em>ï¼‰ï¼Œå¹¶åŸºäºè¿™äº›å¢å¼ºå™¨è°ƒç”¨ <code>AbstractAutoProxyCreator#createProxy</code> æ–¹æ³•ä¸ºå½“å‰ bean åˆ›å»ºå¢å¼ºåçš„ä»£ç†å¯¹è±¡</p>
<h5 id="ç­›é€‰é€‚ç”¨äº-bean-çš„å¢å¼ºå™¨"><a href="#ç­›é€‰é€‚ç”¨äº-bean-çš„å¢å¼ºå™¨" class="headerlink" title="ç­›é€‰é€‚ç”¨äº bean çš„å¢å¼ºå™¨"></a>ç­›é€‰é€‚ç”¨äº bean çš„å¢å¼ºå™¨</h5><p>é¦–å…ˆæ¥çœ‹ä¸€ä¸‹ç­›é€‰é€‚ç”¨äºå½“å‰ bean çš„åˆæ ¼å¢å¼ºå™¨çš„è¿‡ç¨‹ï¼Œå®ç°ä½äº <code>AbstractAdvisorAutoProxyCreator#getAdvicesAndAdvisorsForBean</code> æ–¹æ³•ä¸­ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">protected</span> Object[] getAdvicesAndAdvisorsForBean(<br>        Class&lt;?&gt; beanClass, String beanName, <span class="hljs-meta">@Nullable</span> TargetSource targetSource) &#123;<br>    <span class="hljs-comment">// è·å–é€‚ç”¨äºå½“å‰ bean çš„ Advisor</span><br>    List&lt;Advisor&gt; advisors = <span class="hljs-built_in">this</span>.findEligibleAdvisors(beanClass, beanName);<br>    <span class="hljs-comment">// æ²¡æœ‰åˆæ ¼çš„ Advisorï¼Œä¸è¿›è¡Œä»£ç†</span><br>    <span class="hljs-keyword">if</span> (advisors.isEmpty()) &#123;<br>        <span class="hljs-keyword">return</span> DO_NOT_PROXY; <span class="hljs-comment">// null</span><br>    &#125;<br>    <span class="hljs-keyword">return</span> advisors.toArray();<br>&#125;<br><br><span class="hljs-keyword">protected</span> List&lt;Advisor&gt; <span class="hljs-title function_">findEligibleAdvisors</span><span class="hljs-params">(Class&lt;?&gt; beanClass, String beanName)</span> &#123;<br>    <span class="hljs-comment">// è·å–æ‰€æœ‰å€™é€‰çš„ Advisorï¼ˆåŒ…æ‹¬æ³¨è§£çš„ã€XML ä¸­é…ç½®çš„ï¼‰</span><br>    List&lt;Advisor&gt; candidateAdvisors = <span class="hljs-built_in">this</span>.findCandidateAdvisors();<br>    <span class="hljs-comment">// ä»æ‰€æœ‰ Advisor ä¸­å¯»æ‰¾é€‚ç”¨äºå½“å‰ bean çš„ Advisor</span><br>    List&lt;Advisor&gt; eligibleAdvisors = <span class="hljs-built_in">this</span>.findAdvisorsThatCanApply(candidateAdvisors, beanClass, beanName);<br>    <span class="hljs-comment">// å¦‚æœ Advisor ä¸ä¸ºç©ºï¼Œåˆ™åœ¨æœ€å‰é¢è¿½åŠ ä¸€ä¸ª ExposeInvocationInterceptor</span><br>    <span class="hljs-built_in">this</span>.extendAdvisors(eligibleAdvisors);<br>    <span class="hljs-comment">// å¯¹ Advisor è¿›è¡Œæ’åº</span><br>    <span class="hljs-keyword">if</span> (!eligibleAdvisors.isEmpty()) &#123;<br>        eligibleAdvisors = <span class="hljs-built_in">this</span>.sortAdvisors(eligibleAdvisors);<br>    &#125;<br>    <span class="hljs-keyword">return</span> eligibleAdvisors;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>æ•´ä¸ªæ–¹æ³•çš„æ‰§è¡Œæµç¨‹å¾ˆç®€å•ï¼Œè·å–æ‰€æœ‰çš„å€™é€‰å¢å¼ºå™¨ï¼Œå¹¶ä»ä¸­æ‰¾å‡ºé€‚ç”¨äºå½“å‰ bean çš„å¢å¼ºå™¨ã€‚é¦–å…ˆæ¥çœ‹è·å–æ‰€æœ‰å€™é€‰å¢å¼ºå™¨çš„è¿‡ç¨‹ï¼Œå®ç°ä½äº <code>AnnotationAwareAspectJAutoProxyCreator#findCandidateAdvisors</code> æ–¹æ³•ä¸­ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">protected</span> List&lt;Advisor&gt; <span class="hljs-title function_">findCandidateAdvisors</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-comment">// è°ƒç”¨çˆ¶ç±»çš„ findCandidateAdvisors æ–¹æ³•ï¼Œå…¼å®¹çˆ¶ç±»æŸ¥æ‰¾ Advisor çš„è§„åˆ™</span><br>    List&lt;Advisor&gt; advisors = <span class="hljs-built_in">super</span>.findCandidateAdvisors();<br>    <span class="hljs-comment">// è·å–æ‰€æœ‰æ³¨è§£å®šä¹‰çš„ Advisor</span><br>    <span class="hljs-keyword">if</span> (<span class="hljs-built_in">this</span>.aspectJAdvisorsBuilder != <span class="hljs-literal">null</span>) &#123;<br>        advisors.addAll(<span class="hljs-built_in">this</span>.aspectJAdvisorsBuilder.buildAspectJAdvisors());<br>    &#125;<br>    <span class="hljs-keyword">return</span> advisors;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>æ–¹æ³•é¦–å…ˆè°ƒç”¨äº†çˆ¶ç±»çš„å®ç°ï¼Œè¿™ä¸»è¦æ˜¯ä¸ºäº†å…¼å®¹çˆ¶ç±»æŸ¥æ‰¾å€™é€‰å¢å¼ºå™¨çš„è§„åˆ™ï¼Œä¾‹å¦‚æˆ‘ä»¬çš„ç¤ºä¾‹ä¸­ä½¿ç”¨çš„æ˜¯æ³¨è§£æ–¹å¼å®šä¹‰çš„å¢å¼ºï¼Œä½†æ˜¯çˆ¶ç±»å´æ˜¯åŸºäº XML é…ç½®çš„æ–¹å¼æŸ¥æ‰¾å¢å¼ºå™¨ï¼Œè¿™é‡Œçš„å…¼å®¹èƒ½å¤Ÿè®©æˆ‘ä»¬åœ¨ä»¥æ³¨è§£æ–¹å¼ç¼–ç¨‹æ—¶å…¼å®¹å…¶å®ƒä»¥ XML é…ç½®çš„æ–¹å¼å®šä¹‰çš„å¢å¼ºã€‚ä¸‹é¢è¿˜æ˜¯å°†ä¸»è¦ç²¾åŠ›æ”¾åœ¨è§£ææ³¨è§£å¼å¢å¼ºå®šä¹‰ä¸Šï¼Œè¯¥è¿‡ç¨‹ä½äº <code>BeanFactoryAspectJAdvisorsBuilder#buildAspectJAdvisors</code> æ–¹æ³•ä¸­ã€‚ä¸è¿‡è¯¥æ–¹æ³•å®ç°æ¯”è¾ƒå†—é•¿ï¼Œä½†æ˜¯é€»è¾‘å´å¾ˆæ¸…æ™°ï¼Œæ‰€ä»¥è¿™é‡Œä¸»è¦æ¦‚æ‹¬ä¸€ä¸‹å…¶æ‰§è¡Œæµç¨‹ï¼š</p>
<ol>
<li>è·å–æ‰€æœ‰ç±»å‹ bean å®ä¾‹å¯¹åº”çš„ beanName é›†åˆï¼›</li>
<li>è¿‡æ»¤ä¸æ˜¯åˆ‡é¢ç±»å‹çš„ bean å¯¹åº”çš„ beanNameï¼Œå³æ²¡æœ‰è¢« <code>@Aspect</code> æ³¨è§£ï¼Œæˆ–åŒ…å«ä»¥ <code>ajc$</code> å¼€å¤´çš„å­—æ®µï¼ŒåŒæ—¶æ”¯æŒè¦†ç›– <code>BeanFactoryAspectJAdvisorsBuilder#isEligibleBean</code> æ–¹æ³•æ‰©å±•è¿‡æ»¤è§„åˆ™ï¼›</li>
<li>å¯¹äºåˆ‡é¢ bean ç±»å‹ï¼Œè·å– bean ä¸­å®šä¹‰çš„æ‰€æœ‰åˆ‡ç‚¹ï¼Œå¹¶ä¸ºæ¯ä¸ªåˆ‡ç‚¹ç”Ÿæˆå¯¹åº”çš„å¢å¼ºå™¨ï¼›</li>
<li>ç¼“å­˜è§£æå¾—åˆ°çš„å¢å¼ºå™¨ï¼Œé¿å…é‡å¤è§£æã€‚</li>
</ol>
<p>ä¸Šè¿°æµç¨‹ä¸­æˆ‘ä»¬é‡ç‚¹çœ‹ä¸€ä¸‹è¿‡ç¨‹ 3ï¼Œå®ç°ä½äº <code>ReflectiveAspectJAdvisorFactory#getAdvisors</code> æ–¹æ³•ä¸­ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> List&lt;Advisor&gt; <span class="hljs-title function_">getAdvisors</span><span class="hljs-params">(MetadataAwareAspectInstanceFactory aspectInstanceFactory)</span> &#123;<br>    <span class="hljs-comment">// è·å–åˆ‡é¢ aspect å¯¹åº”çš„ class å’Œ beanName</span><br>    Class&lt;?&gt; aspectClass = aspectInstanceFactory.getAspectMetadata().getAspectClass();<br>    <span class="hljs-type">String</span> <span class="hljs-variable">aspectName</span> <span class="hljs-operator">=</span> aspectInstanceFactory.getAspectMetadata().getAspectName();<br>    <span class="hljs-comment">// æ ¡éªŒåˆ‡é¢å®šä¹‰çš„åˆæ³•æ€§</span><br>    <span class="hljs-built_in">this</span>.validate(aspectClass);<br><br>    <span class="hljs-comment">// We need to wrap the MetadataAwareAspectInstanceFactory with a decorator</span><br>    <span class="hljs-comment">// so that it will only instantiate once.</span><br>    <span class="hljs-type">MetadataAwareAspectInstanceFactory</span> <span class="hljs-variable">lazySingletonAspectInstanceFactory</span> <span class="hljs-operator">=</span><br>            <span class="hljs-keyword">new</span> <span class="hljs-title class_">LazySingletonAspectInstanceFactoryDecorator</span>(aspectInstanceFactory);<br><br>    List&lt;Advisor&gt; advisors = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();<br><br>    <span class="hljs-comment">// 1. éå†å¤„ç†åˆ‡é¢ä¸­é™¤è¢« @Pointcut æ³¨è§£ä»¥å¤–çš„æ–¹æ³•</span><br>    <span class="hljs-keyword">for</span> (Method method : <span class="hljs-built_in">this</span>.getAdvisorMethods(aspectClass)) &#123;<br>        <span class="hljs-type">Advisor</span> <span class="hljs-variable">advisor</span> <span class="hljs-operator">=</span> <span class="hljs-built_in">this</span>.getAdvisor(method, lazySingletonAspectInstanceFactory, advisors.size(), aspectName);<br>        <span class="hljs-keyword">if</span> (advisor != <span class="hljs-literal">null</span>) &#123;<br>            advisors.add(advisor);<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-comment">// 2. å¦‚æœå¢å¼ºå™¨ä¸ä¸ºç©ºï¼ŒåŒæ—¶åˆé…ç½®äº†å¢å¼ºå»¶è¿Ÿåˆå§‹åŒ–ï¼Œåˆ™éœ€è¦è¿½åŠ å®ä¾‹åŒ–å¢å¼ºå™¨ SyntheticInstantiationAdvisor</span><br>    <span class="hljs-keyword">if</span> (!advisors.isEmpty() &amp;&amp; lazySingletonAspectInstanceFactory.getAspectMetadata().isLazilyInstantiated()) &#123;<br>        <span class="hljs-type">Advisor</span> <span class="hljs-variable">instantiationAdvisor</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">SyntheticInstantiationAdvisor</span>(lazySingletonAspectInstanceFactory);<br>        advisors.add(<span class="hljs-number">0</span>, instantiationAdvisor);<br>    &#125;<br><br>    <span class="hljs-comment">// 3. è·å–æ‰€æœ‰å¼•ä»‹å¢å¼ºå®šä¹‰</span><br>    <span class="hljs-keyword">for</span> (Field field : aspectClass.getDeclaredFields()) &#123;<br>        <span class="hljs-comment">// åˆ›å»ºå¼•ä»‹å¢å¼ºå™¨ DeclareParentsAdvisor</span><br>        <span class="hljs-type">Advisor</span> <span class="hljs-variable">advisor</span> <span class="hljs-operator">=</span> <span class="hljs-built_in">this</span>.getDeclareParentsAdvisor(field);<br>        <span class="hljs-keyword">if</span> (advisor != <span class="hljs-literal">null</span>) &#123;<br>            advisors.add(advisor);<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-keyword">return</span> advisors;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>ä¸Šè¿°å®ç°çš„æ•´ä½“æ‰§è¡Œæµç¨‹å¦‚ä»£ç æ³¨é‡Šã€‚æ‹¿åˆ°ä¸€ä¸ªåˆ‡é¢å®šä¹‰ï¼ŒSpring é¦–å…ˆä¼šéå†è·å–åˆ‡é¢ä¸­çš„å¢å¼ºæ–¹æ³•ï¼Œå³è¢« <code>@Around</code>ã€<code>@Before</code>ã€<code>@After</code>ã€<code>@AfterReturning</code>ï¼Œä»¥åŠ <code>@AfterThrowing</code> æ³¨è§£çš„æ–¹æ³•ï¼Œå¹¶è°ƒç”¨ <code>ReflectiveAspectJAdvisorFactory#getAdvisor</code> æ–¹æ³•ä¸ºæ¯ä¸€ä¸ªå¢å¼ºæ–¹æ³•ç”Ÿæˆå¯¹åº”çš„å¢å¼ºå™¨ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> Advisor <span class="hljs-title function_">getAdvisor</span><span class="hljs-params">(Method candidateAdviceMethod,</span><br><span class="hljs-params">                          MetadataAwareAspectInstanceFactory aspectInstanceFactory,</span><br><span class="hljs-params">                          <span class="hljs-type">int</span> declarationOrderInAspect,</span><br><span class="hljs-params">                          String aspectName)</span> &#123;<br><br>    <span class="hljs-comment">// æ ¡éªŒåˆ‡é¢ç±»å®šä¹‰çš„åˆæ³•æ€§</span><br>    <span class="hljs-built_in">this</span>.validate(aspectInstanceFactory.getAspectMetadata().getAspectClass());<br><br>    <span class="hljs-comment">// è·å–æ³¨è§£é…ç½®çš„åˆ‡ç‚¹ä¿¡æ¯ï¼Œå°è£…æˆ AspectJExpressionPointcut å¯¹è±¡</span><br>    <span class="hljs-type">AspectJExpressionPointcut</span> <span class="hljs-variable">expressionPointcut</span> <span class="hljs-operator">=</span> <span class="hljs-built_in">this</span>.getPointcut(<br>            candidateAdviceMethod, aspectInstanceFactory.getAspectMetadata().getAspectClass());<br>    <span class="hljs-keyword">if</span> (expressionPointcut == <span class="hljs-literal">null</span>) &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>    &#125;<br><br>    <span class="hljs-comment">// ä¾æ®åˆ‡ç‚¹ä¿¡æ¯ç”Ÿæˆå¯¹åº”çš„å¢å¼ºå™¨</span><br>    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">InstantiationModelAwarePointcutAdvisorImpl</span>(<br>            expressionPointcut, candidateAdviceMethod, <span class="hljs-built_in">this</span>, aspectInstanceFactory, declarationOrderInAspect, aspectName);<br>&#125;<br></code></pre></td></tr></table></figure>

<p>ä¸Šè¿°å®ç°é¦–å…ˆå¯¹å½“å‰åˆ‡é¢å®šä¹‰æ‰§è¡Œåˆæ³•æ€§æ ¡éªŒï¼Œå¦‚æœåˆ‡é¢é…ç½®åˆæ³•åˆ™è·å–ç›®æ ‡æ–¹æ³•ä¸Šçš„åˆ‡ç‚¹æ³¨è§£å®šä¹‰ï¼Œå¹¶å°è£…æˆ AspectJExpressionPointcut å¯¹è±¡ã€‚è¯¥è¿‡ç¨‹ä½äº <code>ReflectiveAspectJAdvisorFactory#getPointcut</code> æ–¹æ³•ä¸­ï¼Œå®ç°æ¯”è¾ƒç®€å•ã€‚</p>
<p>æ‹¿åˆ°åˆ‡ç‚¹æ³¨è§£å®šä¹‰ä¹‹åï¼Œæ–¹æ³•ä¼šä¾æ®åˆ‡ç‚¹çš„é…ç½®ä¿¡æ¯ä½¿ç”¨ InstantiationModelAwarePointcutAdvisorImpl å®ç°ç±»åˆ›å»ºå¯¹åº”çš„å¢å¼ºå™¨ã€‚ç±» InstantiationModelAwarePointcutAdvisorImpl çš„å®ä¾‹åŒ–è¿‡ç¨‹é™¤äº†åˆå§‹åŒ–äº†ä¸€äº›åŸºæœ¬å±æ€§ä¹‹å¤–ï¼Œä¸»è¦æ˜¯è°ƒç”¨äº† <code>InstantiationModelAwarePointcutAdvisorImpl#instantiateAdvice</code> æ–¹æ³•ï¼Œä¾æ®å¢å¼ºç±»å‹å¯¹å¢å¼ºå™¨å®æ–½ç›¸åº”çš„åˆå§‹åŒ–æ“ä½œï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">private</span> Advice <span class="hljs-title function_">instantiateAdvice</span><span class="hljs-params">(AspectJExpressionPointcut pointcut)</span> &#123;<br>    <span class="hljs-type">Advice</span> <span class="hljs-variable">advice</span> <span class="hljs-operator">=</span> <span class="hljs-built_in">this</span>.aspectJAdvisorFactory.getAdvice(<br>            <span class="hljs-built_in">this</span>.aspectJAdviceMethod, pointcut, <span class="hljs-built_in">this</span>.aspectInstanceFactory, <span class="hljs-built_in">this</span>.declarationOrder, <span class="hljs-built_in">this</span>.aspectName);<br>    <span class="hljs-keyword">return</span> (advice != <span class="hljs-literal">null</span> ? advice : EMPTY_ADVICE);<br>&#125;<br><br><span class="hljs-comment">// org.springframework.aop.aspectj.annotation.ReflectiveAspectJAdvisorFactory#getAdvice</span><br><span class="hljs-keyword">public</span> Advice <span class="hljs-title function_">getAdvice</span><span class="hljs-params">(Method candidateAdviceMethod,</span><br><span class="hljs-params">                        AspectJExpressionPointcut expressionPointcut,</span><br><span class="hljs-params">                        MetadataAwareAspectInstanceFactory aspectInstanceFactory,</span><br><span class="hljs-params">                        <span class="hljs-type">int</span> declarationOrder,</span><br><span class="hljs-params">                        String aspectName)</span> &#123;<br><br>    <span class="hljs-comment">// è·å–åˆ‡é¢ class å¯¹è±¡ï¼Œå¹¶æ ¡éªŒåˆ‡é¢å®šä¹‰</span><br>    Class&lt;?&gt; candidateAspectClass = aspectInstanceFactory.getAspectMetadata().getAspectClass();<br>    <span class="hljs-built_in">this</span>.validate(candidateAspectClass);<br><br>    <span class="hljs-comment">// è·å–æ–¹æ³•çš„åˆ‡ç‚¹æ³¨è§£å®šä¹‰</span><br>    AspectJAnnotation&lt;?&gt; aspectJAnnotation =<br>            AbstractAspectJAdvisorFactory.findAspectJAnnotationOnMethod(candidateAdviceMethod);<br>    <span class="hljs-keyword">if</span> (aspectJAnnotation == <span class="hljs-literal">null</span>) &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>    &#125;<br><br>    <span class="hljs-comment">// If we get here, we know we have an AspectJ method.</span><br>    <span class="hljs-comment">// Check that it&#x27;s an AspectJ-annotated class</span><br>    <span class="hljs-keyword">if</span> (!<span class="hljs-built_in">this</span>.isAspect(candidateAspectClass)) &#123;<br>        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">AopConfigException</span>(<span class="hljs-string">&quot;Advice must be declared inside an aspect type: &quot;</span> +<br>                <span class="hljs-string">&quot;Offending method &#x27;&quot;</span> + candidateAdviceMethod + <span class="hljs-string">&quot;&#x27; in class [&quot;</span> + candidateAspectClass.getName() + <span class="hljs-string">&quot;]&quot;</span>);<br>    &#125;<br><br>    AbstractAspectJAdvice springAdvice;<br><br>    <span class="hljs-comment">// ä¾æ®åˆ‡ç‚¹æ³¨è§£ç±»å‹ä½¿ç”¨å¯¹åº”çš„å¢å¼ºç±»è¿›è¡Œå°è£…</span><br>    <span class="hljs-keyword">switch</span> (aspectJAnnotation.getAnnotationType()) &#123;<br>        <span class="hljs-comment">// @Pointcut</span><br>        <span class="hljs-keyword">case</span> AtPointcut:<br>            <span class="hljs-keyword">if</span> (logger.isDebugEnabled()) &#123;<br>                logger.debug(<span class="hljs-string">&quot;Processing pointcut &#x27;&quot;</span> + candidateAdviceMethod.getName() + <span class="hljs-string">&quot;&#x27;&quot;</span>);<br>            &#125;<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>        <span class="hljs-comment">// @Around</span><br>        <span class="hljs-keyword">case</span> AtAround:<br>            springAdvice = <span class="hljs-keyword">new</span> <span class="hljs-title class_">AspectJAroundAdvice</span>(candidateAdviceMethod, expressionPointcut, aspectInstanceFactory);<br>            <span class="hljs-keyword">break</span>;<br>        <span class="hljs-comment">// @Before</span><br>        <span class="hljs-keyword">case</span> AtBefore:<br>            springAdvice = <span class="hljs-keyword">new</span> <span class="hljs-title class_">AspectJMethodBeforeAdvice</span>(candidateAdviceMethod, expressionPointcut, aspectInstanceFactory);<br>            <span class="hljs-keyword">break</span>;<br>        <span class="hljs-comment">// @After</span><br>        <span class="hljs-keyword">case</span> AtAfter:<br>            springAdvice = <span class="hljs-keyword">new</span> <span class="hljs-title class_">AspectJAfterAdvice</span>(candidateAdviceMethod, expressionPointcut, aspectInstanceFactory);<br>            <span class="hljs-keyword">break</span>;<br>        <span class="hljs-comment">// @AfterReturning</span><br>        <span class="hljs-keyword">case</span> AtAfterReturning:<br>            springAdvice = <span class="hljs-keyword">new</span> <span class="hljs-title class_">AspectJAfterReturningAdvice</span>(candidateAdviceMethod, expressionPointcut, aspectInstanceFactory);<br>            <span class="hljs-type">AfterReturning</span> <span class="hljs-variable">afterReturningAnnotation</span> <span class="hljs-operator">=</span> (AfterReturning) aspectJAnnotation.getAnnotation();<br>            <span class="hljs-keyword">if</span> (StringUtils.hasText(afterReturningAnnotation.returning())) &#123;<br>                springAdvice.setReturningName(afterReturningAnnotation.returning());<br>            &#125;<br>            <span class="hljs-keyword">break</span>;<br>        <span class="hljs-comment">// @AfterThrowing</span><br>        <span class="hljs-keyword">case</span> AtAfterThrowing:<br>            springAdvice = <span class="hljs-keyword">new</span> <span class="hljs-title class_">AspectJAfterThrowingAdvice</span>(<br>                    candidateAdviceMethod, expressionPointcut, aspectInstanceFactory);<br>            <span class="hljs-type">AfterThrowing</span> <span class="hljs-variable">afterThrowingAnnotation</span> <span class="hljs-operator">=</span> (AfterThrowing) aspectJAnnotation.getAnnotation();<br>            <span class="hljs-keyword">if</span> (StringUtils.hasText(afterThrowingAnnotation.throwing())) &#123;<br>                springAdvice.setThrowingName(afterThrowingAnnotation.throwing());<br>            &#125;<br>            <span class="hljs-keyword">break</span>;<br>        <span class="hljs-keyword">default</span>:<br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">UnsupportedOperationException</span>(<span class="hljs-string">&quot;Unsupported advice type on method: &quot;</span> + candidateAdviceMethod);<br>    &#125;<br><br>    <span class="hljs-comment">// Now to configure the advice...</span><br>    springAdvice.setAspectName(aspectName);<br>    springAdvice.setDeclarationOrder(declarationOrder);<br>    String[] argNames = <span class="hljs-built_in">this</span>.parameterNameDiscoverer.getParameterNames(candidateAdviceMethod);<br>    <span class="hljs-keyword">if</span> (argNames != <span class="hljs-literal">null</span>) &#123;<br>        springAdvice.setArgumentNamesFromStringArray(argNames);<br>    &#125;<br>    springAdvice.calculateArgumentBindings();<br><br>    <span class="hljs-keyword">return</span> springAdvice;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>æ–¹æ³•çš„æ•´ä½“æ‰§è¡Œæµç¨‹å¦‚ä»£ç æ³¨é‡Šï¼Œé€»è¾‘æ¯”è¾ƒæ¸…æ™°ï¼ŒSpring ä¼šä¾æ®å…·ä½“çš„å¢å¼ºæ³¨è§£ç±»å‹ï¼Œé€‰æ‹©ç›¸åº”çš„å¢å¼ºç±»å¯¹åˆ‡ç‚¹å®šä¹‰è¿›è¡Œå°è£…ã€‚è¿™é‡Œæˆ‘ä»¬ä»¥ <code>@Before</code> ä¸ºä¾‹è¯´æ˜ä¸€ä¸‹å¢å¼ºçš„æ‰§è¡Œæµç¨‹ï¼ŒAspectJMethodBeforeAdvice å¢å¼ºç±»å…³è”æ³¨å†Œçš„å¤„ç†å™¨æ˜¯ MethodBeforeAdviceInterceptorï¼Œå½“æˆ‘ä»¬è°ƒç”¨ä¸€ä¸ªè¢«å‰ç½®å¢å¼ºçš„ç›®æ ‡æ–¹æ³•æ—¶ï¼Œ<code>MethodBeforeAdviceInterceptor#invoke</code> æ–¹æ³•ä¼šè¢«è§¦å‘ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> Object <span class="hljs-title function_">invoke</span><span class="hljs-params">(MethodInvocation mi)</span> <span class="hljs-keyword">throws</span> Throwable &#123;<br>    <span class="hljs-comment">// æ‰§è¡Œå¢å¼ºæ–¹æ³•</span><br>    <span class="hljs-built_in">this</span>.advice.before(mi.getMethod(), mi.getArguments(), mi.getThis());<br>    <span class="hljs-comment">// æ‰§è¡Œç›®æ ‡æ–¹æ³•</span><br>    <span class="hljs-keyword">return</span> mi.proceed();<br>&#125;<br></code></pre></td></tr></table></figure>

<p>è¿™é‡Œæ‰§è¡Œçš„å¢å¼ºæ–¹æ³•å°±å¯¹åº”ç€ <code>AspectJMethodBeforeAdvice#before</code> æ–¹æ³•ï¼Œè¯¥æ–¹æ³•ä¼šä¾æ®åˆ‡ç‚¹é…ç½®å°†ç›¸åº”çš„å‚æ•°ç»‘å®šä¼ é€’ç»™æˆ‘ä»¬è‡ªå®šä¹‰çš„å¢å¼ºæ–¹æ³•ï¼Œå¹¶æœ€ç»ˆé€šè¿‡åå°„è°ƒç”¨è§¦å‘æ‰§è¡Œã€‚</p>
<p>ä¸Šé¢åˆ†æäº†æ™®é€šæ–¹æ³•çº§åˆ«å¢å¼ºçš„å¤„ç†è¿‡ç¨‹ï¼Œå¯¹äºå¦å¤–ä¸€ç±»å¢å¼ºï¼ˆå¼•ä»‹å¢å¼ºï¼‰ï¼Œæ–¹æ³• <code>ReflectiveAspectJAdvisorFactory#getAdvisors</code> åˆ™ä½¿ç”¨ä¸“é—¨çš„ DeclareParentsAdvisor ç±»åˆ›å»ºå¯¹åº”çš„å¢å¼ºå™¨ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// 3. è·å–æ‰€æœ‰å¼•ä»‹å¢å¼ºå®šä¹‰</span><br><span class="hljs-keyword">for</span> (Field field : aspectClass.getDeclaredFields()) &#123;<br>    <span class="hljs-comment">// åˆ›å»ºå¼•ä»‹å¢å¼ºå™¨</span><br>    <span class="hljs-type">Advisor</span> <span class="hljs-variable">advisor</span> <span class="hljs-operator">=</span> <span class="hljs-built_in">this</span>.getDeclareParentsAdvisor(field);<br>    <span class="hljs-keyword">if</span> (advisor != <span class="hljs-literal">null</span>) &#123;<br>        advisors.add(advisor);<br>    &#125;<br>&#125;<br><br><span class="hljs-keyword">private</span> Advisor <span class="hljs-title function_">getDeclareParentsAdvisor</span><span class="hljs-params">(Field introductionField)</span> &#123;<br>    <span class="hljs-comment">// è·å– @DeclareParents æ³¨è§£å®šä¹‰</span><br>    <span class="hljs-type">DeclareParents</span> <span class="hljs-variable">declareParents</span> <span class="hljs-operator">=</span> introductionField.getAnnotation(DeclareParents.class);<br>    <span class="hljs-keyword">if</span> (declareParents == <span class="hljs-literal">null</span>) &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>    &#125;<br><br>    <span class="hljs-comment">// æ²¡æœ‰æŒ‡å®šé»˜è®¤çš„æ¥å£å®ç°ç±»</span><br>    <span class="hljs-keyword">if</span> (DeclareParents.class == declareParents.defaultImpl()) &#123;<br>        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">IllegalStateException</span>(<span class="hljs-string">&quot;&#x27;defaultImpl&#x27; attribute must be set on DeclareParents&quot;</span>);<br>    &#125;<br><br>    <span class="hljs-comment">// ä½¿ç”¨ DeclareParentsAdvisor ç±»å‹åˆ›å»ºå¯¹åº”çš„å¼•ä»‹å¢å¼ºå™¨</span><br>    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">DeclareParentsAdvisor</span>(<br>            introductionField.getType(), declareParents.value(), declareParents.defaultImpl());<br>&#125;<br></code></pre></td></tr></table></figure>

<p>å¯¹äºå¼•ä»‹å¢å¼ºæ¥è¯´ï¼ŒSpring ä¼šæ³¨å…¥ DelegatePerTargetObjectIntroductionInterceptor å¤„ç†å™¨å¯¹å…¶è¿›è¡Œä¸“é—¨çš„å¤„ç†ï¼Œæ€æƒ³ä¸Šä¸å‰é¢åˆ†æå‰ç½®å¢å¼ºå¤§åŒå°å¼‚ï¼Œè¿™é‡Œä¸å†å±•å¼€ã€‚</p>
<p>ç»§ç»­å›åˆ° <code>AbstractAdvisorAutoProxyCreator#findEligibleAdvisors</code> æ–¹æ³•ï¼Œä¸Šé¢çš„è¿‡ç¨‹æˆ‘ä»¬åˆ†æäº†è·å–æ‰€æœ‰ç±»å‹å¢å¼ºå™¨çš„è¿‡ç¨‹ï¼Œä½†æ˜¯è¿™äº›å¢å¼ºå™¨ä¸ä¸€å®šéƒ½é€‚ç”¨äºå½“å‰ bean å®ä¾‹ï¼Œæˆ‘ä»¬éœ€è¦ä¾æ®åˆ‡ç‚¹é…ç½®ä¿¡æ¯å¯¹å…¶è¿›è¡Œç­›é€‰ã€‚è¿™ä¸€è¿‡ç¨‹ä½äº <code>AbstractAdvisorAutoProxyCreator#findAdvisorsThatCanApply</code> æ–¹æ³•ä¸­ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">protected</span> List&lt;Advisor&gt; <span class="hljs-title function_">findAdvisorsThatCanApply</span><span class="hljs-params">(</span><br><span class="hljs-params">        List&lt;Advisor&gt; candidateAdvisors, Class&lt;?&gt; beanClass, String beanName)</span> &#123;<br>    ProxyCreationContext.setCurrentProxiedBeanName(beanName);<br>    <span class="hljs-keyword">try</span> &#123;<br>        <span class="hljs-keyword">return</span> AopUtils.findAdvisorsThatCanApply(candidateAdvisors, beanClass);<br>    &#125; <span class="hljs-keyword">finally</span> &#123;<br>        ProxyCreationContext.setCurrentProxiedBeanName(<span class="hljs-literal">null</span>);<br>    &#125;<br>&#125;<br><br><span class="hljs-comment">// org.springframework.aop.support.AopUtils#findAdvisorsThatCanApply</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> List&lt;Advisor&gt; <span class="hljs-title function_">findAdvisorsThatCanApply</span><span class="hljs-params">(List&lt;Advisor&gt; candidateAdvisors, Class&lt;?&gt; clazz)</span> &#123;<br>    <span class="hljs-comment">// æ²¡æœ‰å€™é€‰çš„å¢å¼ºå™¨ï¼Œç›´æ¥è¿”å›</span><br>    <span class="hljs-keyword">if</span> (candidateAdvisors.isEmpty()) &#123;<br>        <span class="hljs-keyword">return</span> candidateAdvisors;<br>    &#125;<br>    List&lt;Advisor&gt; eligibleAdvisors = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();<br><br>    <span class="hljs-comment">// 1. ç­›é€‰å¼•ä»‹å¢å¼ºå™¨</span><br>    <span class="hljs-keyword">for</span> (Advisor candidate : candidateAdvisors) &#123;<br>        <span class="hljs-keyword">if</span> (candidate <span class="hljs-keyword">instanceof</span> IntroductionAdvisor &amp;&amp; canApply(candidate, clazz)) &#123;<br>            eligibleAdvisors.add(candidate);<br>        &#125;<br>    &#125;<br>    <span class="hljs-comment">// è¡¨ç¤ºæ˜¯å¦å«æœ‰å¼•ä»‹å¢å¼º</span><br>    <span class="hljs-type">boolean</span> <span class="hljs-variable">hasIntroductions</span> <span class="hljs-operator">=</span> !eligibleAdvisors.isEmpty();<br><br>    <span class="hljs-comment">// 2. ç­›é€‰å…¶å®ƒç±»å‹çš„å¢å¼ºå™¨</span><br>    <span class="hljs-keyword">for</span> (Advisor candidate : candidateAdvisors) &#123;<br>        <span class="hljs-comment">// å¼•ä»‹å¢å¼ºå·²ç»å¤„ç†è¿‡ï¼Œè¿™é‡Œç›´æ¥è·³è¿‡</span><br>        <span class="hljs-keyword">if</span> (candidate <span class="hljs-keyword">instanceof</span> IntroductionAdvisor) &#123;<br>            <span class="hljs-comment">// already processed</span><br>            <span class="hljs-keyword">continue</span>;<br>        &#125;<br>        <span class="hljs-comment">// ç­›é€‰å…¶å®ƒç±»å‹çš„å¢å¼ºå™¨</span><br>        <span class="hljs-keyword">if</span> (canApply(candidate, clazz, hasIntroductions)) &#123;<br>            eligibleAdvisors.add(candidate);<br>        &#125;<br>    &#125;<br>    <span class="hljs-keyword">return</span> eligibleAdvisors;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>æ–¹æ³•é¦–å…ˆä¼šä½¿ç”¨ç±»è¿‡æ»¤å™¨ï¼ˆClassFilterï¼‰ç­›é€‰å¼•ä»‹å¢å¼ºå™¨ï¼Œé™¤äº†æˆ‘ä»¬æ‰‹åŠ¨æ³¨å†Œçš„ç±»è¿‡æ»¤å™¨å¤–ï¼Œè¿™é‡Œé»˜è®¤è¿˜ä¼šä½¿ç”¨ TypePatternClassFilter ç±»è¿‡æ»¤å™¨æ‰§è¡Œè¿‡æ»¤æ“ä½œã€‚ç„¶åï¼Œæ–¹æ³•ä¼šè¿‡æ»¤ç­›é€‰å…¶å®ƒç±»å‹çš„å¢å¼ºå™¨ï¼Œè¿™é‡Œé™¤äº†ä½¿ç”¨ç±»è¿‡æ»¤å™¨å¤–ï¼Œè€ƒè™‘æ–¹æ³•çº§åˆ«å¢å¼ºçš„å®šä¹‰å½¢å¼ï¼Œè¿˜ä¼šä½¿ç”¨æ–¹æ³•åŒ¹é…å™¨ï¼ˆMethodMatcherï¼‰è¿›è¡Œç­›é€‰ã€‚å¦‚æœå¢å¼ºå™¨é€‚ç”¨äºå½“å‰ bean ç±»å‹ï¼Œåˆ™å°†å…¶åŠ å…¥åˆ°é›†åˆä¸­ç”¨äºä¸‹ä¸€æ­¥ä¸ºå½“å‰ bean åˆ›å»ºå¢å¼ºä»£ç†å¯¹è±¡ã€‚å¦‚æœæ²¡æœ‰ä»»ä½•ä¸€ä¸ªå¢å¼ºå™¨é€‚ç”¨äºå½“å‰ bean ç±»å‹ï¼Œåˆ™æ–¹æ³• <code>AbstractAdvisorAutoProxyCreator#getAdvicesAndAdvisorsForBean</code> æœ€ç»ˆä¼šè¿”å›å€¼ä¸º null çš„ <code>DO_NOT_PROXY</code> æ•°ç»„å¯¹è±¡ï¼Œè¡¨ç¤ºå½“å‰ bean ä¸éœ€è¦è¢«å¢å¼ºã€‚</p>
<h5 id="ä¸º-bean-åˆ›å»ºå¢å¼ºä»£ç†å¯¹è±¡"><a href="#ä¸º-bean-åˆ›å»ºå¢å¼ºä»£ç†å¯¹è±¡" class="headerlink" title="ä¸º bean åˆ›å»ºå¢å¼ºä»£ç†å¯¹è±¡"></a>ä¸º bean åˆ›å»ºå¢å¼ºä»£ç†å¯¹è±¡</h5><p>å®Œæˆäº†å¯¹äºå½“å‰ bean å¢å¼ºå™¨çš„ç­›é€‰ï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬ç»§ç»­å›åˆ° <code>AbstractAutoProxyCreator#wrapIfNecessary</code> æ–¹æ³•ï¼Œçœ‹ä¸€ä¸‹åŸºäºå‰é¢ç­›é€‰å‡ºçš„å¢å¼ºå™¨ä¸ºå½“å‰ bean åˆ›å»ºå¢å¼ºä»£ç†å¯¹è±¡çš„è¿‡ç¨‹ï¼Œå®ç°ä½äº <code>AbstractAutoProxyCreator#createProxy</code> æ–¹æ³•ä¸­ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">protected</span> Object <span class="hljs-title function_">createProxy</span><span class="hljs-params">(Class&lt;?&gt; beanClass,</span><br><span class="hljs-params">                             <span class="hljs-meta">@Nullable</span> String beanName,</span><br><span class="hljs-params">                             <span class="hljs-meta">@Nullable</span> Object[] specificInterceptors,</span><br><span class="hljs-params">                             TargetSource targetSource)</span> &#123;<br><br>    <span class="hljs-keyword">if</span> (<span class="hljs-built_in">this</span>.beanFactory <span class="hljs-keyword">instanceof</span> ConfigurableListableBeanFactory) &#123;<br>        AutoProxyUtils.exposeTargetClass((ConfigurableListableBeanFactory) <span class="hljs-built_in">this</span>.beanFactory, beanName, beanClass);<br>    &#125;<br><br>    <span class="hljs-comment">// ProxyFactory ç”¨äºä¸ºç›®æ ‡ bean å®ä¾‹åˆ›å»ºä»£ç†å¯¹è±¡</span><br>    <span class="hljs-type">ProxyFactory</span> <span class="hljs-variable">proxyFactory</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ProxyFactory</span>();<br>    proxyFactory.copyFrom(<span class="hljs-built_in">this</span>);<br><br>    <span class="hljs-comment">// proxy-target-class = falseï¼Œè¡¨ç¤ºä½¿ç”¨ JDK åŸç”ŸåŠ¨æ€ä»£ç†</span><br>    <span class="hljs-keyword">if</span> (!proxyFactory.isProxyTargetClass()) &#123;<br>        <span class="hljs-comment">// æ£€æµ‹å½“å‰ bean æ˜¯å¦åº”è¯¥åŸºäºç±»è€Œéæ¥å£ç”Ÿæˆä»£ç†å¯¹è±¡ï¼Œå³åŒ…å« preserveTargetClass=true å±æ€§</span><br>        <span class="hljs-keyword">if</span> (<span class="hljs-built_in">this</span>.shouldProxyTargetClass(beanClass, beanName)) &#123;<br>            proxyFactory.setProxyTargetClass(<span class="hljs-literal">true</span>);<br>        &#125;<br>        <span class="hljs-comment">// å¦‚æœæ˜¯åŸºäºæ¥å£ç”Ÿæˆä»£ç†ï¼Œåˆ™æ·»åŠ éœ€è¦ä»£ç†çš„æ¥å£åˆ° ProxyFactory ä¸­ï¼ˆé™¤å†…ç½® callback æ¥å£ã€è¯­è¨€å†…åœ¨æ¥å£ï¼Œä»¥åŠæ ‡è®°æ¥å£ï¼‰</span><br>        <span class="hljs-keyword">else</span> &#123;<br>            <span class="hljs-built_in">this</span>.evaluateProxyInterfaces(beanClass, proxyFactory);<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-comment">// å°†æ‹¦æˆªå™¨å°è£…æˆ Advisor å¯¹è±¡</span><br>    Advisor[] advisors = <span class="hljs-built_in">this</span>.buildAdvisors(beanName, specificInterceptors);<br>    proxyFactory.addAdvisors(advisors);<br>    proxyFactory.setTargetSource(targetSource);<br>    <span class="hljs-comment">// æ¨¡æ¿æ–¹æ³•ï¼Œå®šåˆ¶ä»£ç†å·¥å‚</span><br>    <span class="hljs-built_in">this</span>.customizeProxyFactory(proxyFactory);<br><br>    <span class="hljs-comment">// è®¾ç½®ä»£ç†å·¥å‚è¢«é…ç½®ä¹‹åæ˜¯å¦è¿˜å…è®¸ä¿®æ”¹ï¼Œé»˜è®¤ä¸º falseï¼Œè¡¨ç¤ºä¸å…è®¸ä¿®æ”¹</span><br>    proxyFactory.setFrozen(<span class="hljs-built_in">this</span>.freezeProxy);<br>    <span class="hljs-keyword">if</span> (<span class="hljs-built_in">this</span>.advisorsPreFiltered()) &#123;<br>        proxyFactory.setPreFiltered(<span class="hljs-literal">true</span>);<br>    &#125;<br><br>    <span class="hljs-comment">// åŸºäº ProxyFactory åˆ›å»ºä»£ç†ç±»</span><br>    <span class="hljs-keyword">return</span> proxyFactory.getProxy(<span class="hljs-built_in">this</span>.getProxyClassLoader());<br>&#125;<br></code></pre></td></tr></table></figure>

<p>æ–¹æ³•çš„æ‰§è¡Œæµç¨‹å¦‚ä»£ç æ³¨é‡Šã€‚ä¸‹é¢æˆ‘ä»¬ä¸»è¦åˆ†æå°†æ‹¦æˆªå™¨å°è£…æˆ Advisor å¯¹è±¡çš„è¿‡ç¨‹ï¼Œä»¥åŠåŸºäº ProxyFactory åˆ›å»ºå¢å¼ºä»£ç†å¯¹è±¡çš„è¿‡ç¨‹ã€‚</p>
<p>Spring å®šä¹‰äº†éå¸¸å¤šçš„æ‹¦æˆªå™¨ã€å¢å¼ºå™¨ï¼Œä»¥åŠå¢å¼ºæ–¹æ³•ç­‰ï¼Œè¿™é‡Œé€šè¿‡ <code>AbstractAutoProxyCreator#buildAdvisors</code> æ–¹æ³•ç»Ÿä¸€å°†ä»–ä»¬å°è£…æˆ Advisor å¯¹è±¡ï¼Œä»è€Œç®€åŒ–ä»£ç†çš„åˆ›å»ºè¿‡ç¨‹ã€‚å°è£…çš„æ ¸å¿ƒæ­¥éª¤ç”± <code>DefaultAdvisorAdapterRegistry#wrap</code> æ–¹æ³•å®ç°ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> Advisor <span class="hljs-title function_">wrap</span><span class="hljs-params">(Object adviceObject)</span> <span class="hljs-keyword">throws</span> UnknownAdviceTypeException &#123;<br>    <span class="hljs-comment">// å·²ç»æ˜¯ Advisorï¼Œåˆ™æ— éœ€å¤šåšå¤„ç†</span><br>    <span class="hljs-keyword">if</span> (adviceObject <span class="hljs-keyword">instanceof</span> Advisor) &#123;<br>        <span class="hljs-keyword">return</span> (Advisor) adviceObject;<br>    &#125;<br>    <span class="hljs-comment">// è¦æ±‚å¿…é¡»æ˜¯ Advice ç±»å‹</span><br>    <span class="hljs-keyword">if</span> (!(adviceObject <span class="hljs-keyword">instanceof</span> Advice)) &#123;<br>        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">UnknownAdviceTypeException</span>(adviceObject);<br>    &#125;<br>    <span class="hljs-type">Advice</span> <span class="hljs-variable">advice</span> <span class="hljs-operator">=</span> (Advice) adviceObject;<br>    <span class="hljs-comment">// å¦‚æœæ˜¯ MethodInterceptorï¼Œåˆ™ç›´æ¥ä½¿ç”¨ DefaultPointcutAdvisor è¿›è¡ŒåŒ…è£…</span><br>    <span class="hljs-keyword">if</span> (advice <span class="hljs-keyword">instanceof</span> MethodInterceptor) &#123;<br>        <span class="hljs-comment">// So well-known it doesn&#x27;t even need an adapter.</span><br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">DefaultPointcutAdvisor</span>(advice);<br>    &#125;<br>    <span class="hljs-comment">// å¦åˆ™éå†æ³¨å†Œçš„é€‚é…å™¨ï¼Œå¦‚æœå­˜åœ¨å…³è”çš„é€‚é…å™¨åˆ™ä½¿ç”¨ DefaultPointcutAdvisor è¿›è¡ŒåŒ…è£…</span><br>    <span class="hljs-keyword">for</span> (AdvisorAdapter adapter : <span class="hljs-built_in">this</span>.adapters) &#123;<br>        <span class="hljs-comment">// Check that it is supported.</span><br>        <span class="hljs-keyword">if</span> (adapter.supportsAdvice(advice)) &#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">DefaultPointcutAdvisor</span>(advice);<br>        &#125;<br>    &#125;<br>    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">UnknownAdviceTypeException</span>(advice);<br>&#125;<br></code></pre></td></tr></table></figure>

<p>æ¥ä¸‹æ¥æˆ‘ä»¬é‡ç‚¹åˆ†æä¸€ä¸‹é€šè¿‡ä»£ç†å·¥å‚ ProxyFactory åˆ›å»ºå¢å¼ºä»£ç†å¯¹è±¡çš„è¿‡ç¨‹ï¼Œå®ç°ä½äº <code>ProxyFactory#getProxy</code> æ–¹æ³•ä¸­ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> Object <span class="hljs-title function_">getProxy</span><span class="hljs-params">(<span class="hljs-meta">@Nullable</span> ClassLoader classLoader)</span> &#123;<br>    <span class="hljs-keyword">return</span> <span class="hljs-built_in">this</span>.createAopProxy() <span class="hljs-comment">// 1. åˆ›å»º AOP ä»£ç†</span><br>            .getProxy(classLoader); <span class="hljs-comment">// 2. åŸºäº AOP ä»£ç†åˆ›å»ºç›®æ ‡ç±»çš„å¢å¼ºä»£ç†å¯¹è±¡</span><br>&#125;<br></code></pre></td></tr></table></figure>

<p>è¯¥æ–¹æ³•çš„æ‰§è¡Œè¿‡ç¨‹å¯ä»¥æ‹†åˆ†æˆä¸¤ä¸ªæ­¥éª¤ï¼š</p>
<ol>
<li>åˆ›å»º AOP ä»£ç†ï¼ŒSpring é»˜è®¤æä¾›äº†ä¸¤ç§ AOP ä»£ç†å®ç°ï¼Œå³ java åŸç”Ÿä»£ç†å’Œ CGLib ä»£ç†ï¼›</li>
<li>åŸºäº AOP ä»£ç†åˆ›å»ºç›®æ ‡ç±»çš„å¢å¼ºä»£ç†å¯¹è±¡ã€‚</li>
</ol>
<p>æˆ‘ä»¬é¦–å…ˆæ¥çœ‹ä¸€ä¸‹æ­¥éª¤ 1 çš„å®ç°ï¼Œä½äº <code>ProxyCreatorSupport#createAopProxy</code> æ–¹æ³•ä¸­ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">synchronized</span> AopProxy <span class="hljs-title function_">createAopProxy</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-keyword">if</span> (!<span class="hljs-built_in">this</span>.active) &#123;<br>        <span class="hljs-built_in">this</span>.activate();<br>    &#125;<br>    <span class="hljs-keyword">return</span> <span class="hljs-built_in">this</span>.getAopProxyFactory().createAopProxy(<span class="hljs-built_in">this</span>);<br>&#125;<br><br><span class="hljs-comment">// org.springframework.aop.framework.DefaultAopProxyFactory#createAopProxy</span><br><span class="hljs-keyword">public</span> AopProxy <span class="hljs-title function_">createAopProxy</span><span class="hljs-params">(AdvisedSupport config)</span> <span class="hljs-keyword">throws</span> AopConfigException &#123;<br>    <span class="hljs-keyword">if</span> (config.isOptimize() <span class="hljs-comment">// éœ€è¦å¯¹ä»£ç†ç­–ç•¥è¿›è¡Œä¼˜åŒ–</span><br>            || config.isProxyTargetClass() <span class="hljs-comment">// // æŒ‡å®šä½¿ç”¨ CGLib ç”Ÿæˆä»£ç†å¯¹è±¡</span><br>            || <span class="hljs-built_in">this</span>.hasNoUserSuppliedProxyInterfaces(config)) <span class="hljs-comment">// å½“å‰ç±»æ²¡æœ‰æ¥å£å®šä¹‰ï¼Œä¸å¾—ä¸ä½¿ç”¨ CGLib</span><br>    &#123;<br>        Class&lt;?&gt; targetClass = config.getTargetClass();<br>        <span class="hljs-keyword">if</span> (targetClass == <span class="hljs-literal">null</span>) &#123;<br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">AopConfigException</span>(<span class="hljs-string">&quot;TargetSource cannot determine target class: &quot;</span> +<br>                    <span class="hljs-string">&quot;Either an interface or a target is required for proxy creation.&quot;</span>);<br>        &#125;<br>        <span class="hljs-comment">// ç›®æ ‡ç±»æ˜¯æ¥å£æˆ–ä»£ç†ç±»ï¼Œä½¿ç”¨ JDK åŸç”Ÿä»£ç†</span><br>        <span class="hljs-keyword">if</span> (targetClass.isInterface() || Proxy.isProxyClass(targetClass)) &#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">JdkDynamicAopProxy</span>(config);<br>        &#125;<br>        <span class="hljs-comment">// ä½¿ç”¨ CGLib åŠ¨æ€ä»£ç†</span><br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjenesisCglibAopProxy</span>(config);<br>    &#125;<br>    <span class="hljs-comment">// ä½¿ç”¨ JDK åŸç”ŸåŠ¨æ€ä»£ç†</span><br>    <span class="hljs-keyword">else</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">JdkDynamicAopProxy</span>(config);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>è¿™éƒ¨åˆ†ä»£ç æ¸…æ™°è¯´æ˜äº† Spring åœ¨ç”Ÿæˆä»£ç†å¯¹è±¡æ—¶å¦‚ä½•åœ¨ java åŸç”Ÿä»£ç†å’Œ CGLib ä»£ç†ä¹‹é—´è¿›è¡Œé€‰æ‹©ï¼Œå¯ä»¥æ¦‚æ‹¬å¦‚ä¸‹ï¼š</p>
<ol>
<li>å¦‚æœç›®æ ‡ç±»å®ç°äº†æ¥å£ï¼Œåˆ™ Spring é»˜è®¤ä¼šä½¿ç”¨ java åŸç”Ÿä»£ç†ã€‚</li>
<li>å¦‚æœç›®æ ‡ç±»æœªå®ç°æ¥å£ï¼Œåˆ™ Spring ä¼šä½¿ç”¨ CGLib ç”Ÿæˆä»£ç†ã€‚</li>
<li>å¦‚æœç›®æ ‡ç±»å®ç°äº†æ¥å£ï¼Œä½†æ˜¯åœ¨é…ç½®æ—¶æŒ‡å®šäº† <code>proxy-target-class=true</code>ï¼Œåˆ™ä½¿ç”¨ CGLib ç”Ÿæˆä»£ç†ã€‚</li>
</ol>
<p>ä¸‹é¢åˆ†åˆ«å¯¹åŸºäº java åŸç”Ÿä»£ç†å’Œ CGLib ä»£ç†ç”Ÿæˆå¢å¼ºä»£ç†å¯¹è±¡çš„è¿‡ç¨‹è¿›è¡Œåˆ†æã€‚</p>
<h5 id="åŸºäº-Java-åŸç”Ÿä»£ç†åˆ›å»ºå¢å¼ºä»£ç†å¯¹è±¡"><a href="#åŸºäº-Java-åŸç”Ÿä»£ç†åˆ›å»ºå¢å¼ºä»£ç†å¯¹è±¡" class="headerlink" title="åŸºäº Java åŸç”Ÿä»£ç†åˆ›å»ºå¢å¼ºä»£ç†å¯¹è±¡"></a>åŸºäº Java åŸç”Ÿä»£ç†åˆ›å»ºå¢å¼ºä»£ç†å¯¹è±¡</h5><p>é¦–å…ˆæ¥çœ‹ä¸€ä¸‹åŸºäº Java åŸç”Ÿä»£ç†ç”Ÿæˆå¢å¼ºä»£ç†å¯¹è±¡çš„è¿‡ç¨‹ï¼Œä½äº <code>JdkDynamicAopProxy</code> ç±»ä¸­ã€‚Java åŸç”Ÿä»£ç†è¦æ±‚ä»£ç†ç±»å®ç° <code>InvocationHandler</code> æ¥å£ï¼Œå¹¶åœ¨ <code>InvocationHandler#invoke</code> æ–¹æ³•ä¸­å®ç°ä»£ç†å¢å¼ºé€»è¾‘ã€‚<code>JdkDynamicAopProxy</code> æ­£å¥½å®ç°äº†è¯¥æ¥å£ï¼Œå¯¹åº”çš„ <code>JdkDynamicAopProxy#invoke</code> æ–¹æ³•å®ç°å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> Object <span class="hljs-title function_">invoke</span><span class="hljs-params">(Object proxy, Method method, Object[] args)</span> <span class="hljs-keyword">throws</span> Throwable &#123;<br>    <span class="hljs-type">Object</span> <span class="hljs-variable">oldProxy</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;<br>    <span class="hljs-type">boolean</span> <span class="hljs-variable">setProxyContext</span> <span class="hljs-operator">=</span> <span class="hljs-literal">false</span>;<br><br>    <span class="hljs-type">TargetSource</span> <span class="hljs-variable">targetSource</span> <span class="hljs-operator">=</span> <span class="hljs-built_in">this</span>.advised.targetSource;<br>    <span class="hljs-type">Object</span> <span class="hljs-variable">target</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;<br><br>    <span class="hljs-keyword">try</span> &#123;<br>        <span class="hljs-comment">// å½“å‰æ˜¯ equals æ–¹æ³•ï¼Œä½†æ˜¯è¢«ä»£ç†ç±»æ¥å£ä¸­æœªå®šä¹‰ equals æ–¹æ³•</span><br>        <span class="hljs-keyword">if</span> (!<span class="hljs-built_in">this</span>.equalsDefined &amp;&amp; AopUtils.isEqualsMethod(method)) &#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-built_in">this</span>.equals(args[<span class="hljs-number">0</span>]);<br>        &#125;<br>        <span class="hljs-comment">// å½“å‰æ˜¯ hashCode æ–¹æ³•ï¼Œä½†æ˜¯è¢«ä»£ç†ç±»æ¥å£ä¸­æœªå®šä¹‰ hashCode æ–¹æ³•</span><br>        <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (!<span class="hljs-built_in">this</span>.hashCodeDefined &amp;&amp; AopUtils.isHashCodeMethod(method)) &#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-built_in">this</span>.hashCode();<br>        &#125;<br>        <span class="hljs-comment">// å¦‚æœæ˜¯ DecoratingProxy ä¸­å®šä¹‰çš„æ–¹æ³•ï¼ˆå³ DecoratingProxy#getDecoratedClassï¼‰ï¼Œç›´æ¥è¿”å›ç›®æ ‡ç±»å¯¹è±¡</span><br>        <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (method.getDeclaringClass() == DecoratingProxy.class) &#123;<br>            <span class="hljs-keyword">return</span> AopProxyUtils.ultimateTargetClass(<span class="hljs-built_in">this</span>.advised);<br>        &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (!<span class="hljs-built_in">this</span>.advised.opaque <span class="hljs-comment">// å…è®¸è¢«è½¬æ¢æˆ Advised ç±»å‹</span><br>                &amp;&amp; method.getDeclaringClass().isInterface() <span class="hljs-comment">// æ¥å£ç±»å‹</span><br>                &amp;&amp; method.getDeclaringClass().isAssignableFrom(Advised.class)) <span class="hljs-comment">// æ–¹æ³•æ‰€åœ¨ç±»æ˜¯ Advised ç±»åŠå…¶çˆ¶ç±»</span><br>        &#123;<br>            <span class="hljs-comment">// ç›´æ¥åå°„è°ƒç”¨è¯¥æ–¹æ³•</span><br>            <span class="hljs-keyword">return</span> AopUtils.invokeJoinpointUsingReflection(<span class="hljs-built_in">this</span>.advised, method, args);<br>        &#125;<br><br>        <span class="hljs-comment">// ç»“æœå€¼</span><br>        Object retVal;<br><br>        <span class="hljs-comment">// æŒ‡å®šå†…éƒ¨é—´è°ƒç”¨ä¹Ÿéœ€è¦ä»£ç†</span><br>        <span class="hljs-keyword">if</span> (<span class="hljs-built_in">this</span>.advised.exposeProxy) &#123;<br>            <span class="hljs-comment">// Make invocation available if necessary.</span><br>            oldProxy = AopContext.setCurrentProxy(proxy);<br>            setProxyContext = <span class="hljs-literal">true</span>;<br>        &#125;<br><br>        <span class="hljs-comment">// Get as late as possible to minimize the time we &quot;own&quot; the target, in case it comes from a pool.</span><br>        target = targetSource.getTarget();<br>        Class&lt;?&gt; targetClass = (target != <span class="hljs-literal">null</span> ? target.getClass() : <span class="hljs-literal">null</span>);<br><br>        <span class="hljs-comment">// è·å–å½“å‰æ–¹æ³•çš„æ‹¦æˆªå™¨é“¾</span><br>        List&lt;Object&gt; chain = <span class="hljs-built_in">this</span>.advised.getInterceptorsAndDynamicInterceptionAdvice(method, targetClass);<br><br>        <span class="hljs-comment">// Check whether we have any advice. If we don&#x27;t, we can fallback on direct</span><br>        <span class="hljs-comment">// reflective invocation of the target, and avoid creating a MethodInvocation.</span><br>        <span class="hljs-comment">// æ‹¦æˆªå™¨é“¾ä¸ºç©ºï¼Œåˆ™ç›´æ¥åå°„è°ƒç”¨å¢å¼ºæ–¹æ³•</span><br>        <span class="hljs-keyword">if</span> (chain.isEmpty()) &#123;<br>            <span class="hljs-comment">// We can skip creating a MethodInvocation: just invoke the target directly</span><br>            <span class="hljs-comment">// Note that the final invoker must be an InvokerInterceptor so we know it does</span><br>            <span class="hljs-comment">// nothing but a reflective operation on the target, and no hot swapping or fancy proxying.</span><br>            Object[] argsToUse = AopProxyUtils.adaptArgumentsIfNecessary(method, args);<br>            retVal = AopUtils.invokeJoinpointUsingReflection(target, method, argsToUse);<br>        &#125;<br>        <span class="hljs-comment">// å¦åˆ™éœ€è¦åˆ›å»ºå¯¹åº”çš„ MethodInvocationï¼Œä»¥é“¾å¼è°ƒç”¨æ‹¦æˆªå™¨æ–¹æ³•å’Œå¢å¼ºæ–¹æ³•</span><br>        <span class="hljs-keyword">else</span> &#123;<br>            <span class="hljs-type">MethodInvocation</span> <span class="hljs-variable">invocation</span> <span class="hljs-operator">=</span><br>                    <span class="hljs-keyword">new</span> <span class="hljs-title class_">ReflectiveMethodInvocation</span>(proxy, target, method, args, targetClass, chain);<br>            <span class="hljs-comment">// Proceed to the joinpoint through the interceptor chain.</span><br>            retVal = invocation.proceed();<br>        &#125;<br><br>        <span class="hljs-comment">// å¤„ç†è¿”å›å€¼</span><br>        Class&lt;?&gt; returnType = method.getReturnType();<br>        <span class="hljs-keyword">if</span> (retVal != <span class="hljs-literal">null</span> &amp;&amp; retVal == target &amp;&amp;<br>                returnType != Object.class &amp;&amp; returnType.isInstance(proxy) &amp;&amp;<br>                !RawTargetAccess.class.isAssignableFrom(method.getDeclaringClass())) &#123;<br>            <span class="hljs-comment">// Special case: it returned &quot;this&quot; and the return type of the method is type-compatible.</span><br>            <span class="hljs-comment">// Note that we can&#x27;t help if the target sets a reference to itself in another returned object.</span><br>            retVal = proxy;<br>        &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (retVal == <span class="hljs-literal">null</span> &amp;&amp; returnType != Void.TYPE &amp;&amp; returnType.isPrimitive()) &#123;<br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">AopInvocationException</span>(<br>                    <span class="hljs-string">&quot;Null return value from advice does not match primitive return type for: &quot;</span> + method);<br>        &#125;<br>        <span class="hljs-keyword">return</span> retVal;<br>    &#125; <span class="hljs-keyword">finally</span> &#123;<br>        <span class="hljs-keyword">if</span> (target != <span class="hljs-literal">null</span> &amp;&amp; !targetSource.isStatic()) &#123;<br>            <span class="hljs-comment">// Must have come from TargetSource.</span><br>            targetSource.releaseTarget(target);<br>        &#125;<br>        <span class="hljs-keyword">if</span> (setProxyContext) &#123;<br>            <span class="hljs-comment">// Restore old proxy.</span><br>            AopContext.setCurrentProxy(oldProxy);<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>ç”±ä¸Šè¿°æ–¹æ³•å®ç°ï¼Œæˆ‘ä»¬å¯ä»¥æ¦‚æ‹¬å‡ºæ•´ä¸ªå¢å¼ºä»£ç†çš„æ‰§è¡Œè¿‡ç¨‹ï¼Œå¦‚ä¸‹ï¼š</p>
<ol>
<li>ç‰¹æ®Šå¤„ç† <code>Object#equals</code>ã€<code>Object#hashCode</code>ã€<code>DecoratingProxy#getDecoratedClass</code>ï¼Œä»¥åŠ Advised ç±»åŠå…¶çˆ¶ç±»ä¸­å®šä¹‰çš„æ–¹æ³•ï¼›</li>
<li>å¦‚æœé…ç½®äº† expose-proxy å±æ€§ï¼Œåˆ™è®°å½•å½“å‰ä»£ç†å¯¹è±¡ï¼Œä»¥å¤‡åœ¨å†…éƒ¨é—´è°ƒç”¨æ—¶å®æ–½å¢å¼ºï¼›</li>
<li>è·å–å½“å‰æ–¹æ³•çš„æ‹¦æˆªå™¨é“¾ï¼›</li>
<li>å¦‚æœæ²¡æœ‰æ‹¦æˆªå™¨å®šä¹‰ï¼Œåˆ™ç›´æ¥åå°„è°ƒç”¨å¢å¼ºæ–¹æ³•ï¼Œå¦åˆ™å…ˆé€ä¸€æ‰§è¡Œæ‹¦æˆªå™¨æ–¹æ³•ï¼Œæœ€åå†åº”ç”¨å¢å¼ºæ–¹æ³•ï¼›</li>
<li>å¤„ç†è¿”å›å€¼ã€‚</li>
</ol>
<p>é‡ç‚¹æ¥çœ‹ä¸€ä¸‹æ­¥éª¤ 4 ä¸­åº”ç”¨æ‹¦æˆªå™¨æ–¹æ³•çš„å®ç°ï¼Œä½äº <code>ReflectiveMethodInvocation#proceed</code> æ–¹æ³•ä¸­ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> Object <span class="hljs-title function_">proceed</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Throwable &#123;<br>    <span class="hljs-comment">// å¦‚æœæ‰€æœ‰çš„å¢å¼ºéƒ½æ‰§è¡Œå®Œæˆï¼Œåˆ™æ‰§è¡Œå¢å¼ºæ–¹æ³•</span><br>    <span class="hljs-keyword">if</span> (<span class="hljs-built_in">this</span>.currentInterceptorIndex == <span class="hljs-built_in">this</span>.interceptorsAndDynamicMethodMatchers.size() - <span class="hljs-number">1</span>) &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-built_in">this</span>.invokeJoinpoint();<br>    &#125;<br><br>    <span class="hljs-comment">// è·å–ä¸‹ä¸€ä¸ªéœ€è¦æ‰§è¡Œçš„æ‹¦æˆªå™¨</span><br>    <span class="hljs-type">Object</span> <span class="hljs-variable">interceptorOrInterceptionAdvice</span> <span class="hljs-operator">=</span><br>            <span class="hljs-built_in">this</span>.interceptorsAndDynamicMethodMatchers.get(++<span class="hljs-built_in">this</span>.currentInterceptorIndex);<br>    <span class="hljs-comment">// åŠ¨æ€æ‹¦æˆªå™¨ï¼Œæ‰§è¡ŒåŠ¨æ€æ–¹æ³•åŒ¹é…</span><br>    <span class="hljs-keyword">if</span> (interceptorOrInterceptionAdvice <span class="hljs-keyword">instanceof</span> InterceptorAndDynamicMethodMatcher) &#123;<br>        <span class="hljs-comment">// Evaluate dynamic method matcher here: static part will already have been evaluated and found to match.</span><br>        <span class="hljs-type">InterceptorAndDynamicMethodMatcher</span> <span class="hljs-variable">dm</span> <span class="hljs-operator">=</span><br>                (InterceptorAndDynamicMethodMatcher) interceptorOrInterceptionAdvice;<br>        Class&lt;?&gt; targetClass = (<span class="hljs-built_in">this</span>.targetClass != <span class="hljs-literal">null</span> ? <span class="hljs-built_in">this</span>.targetClass : <span class="hljs-built_in">this</span>.method.getDeclaringClass());<br>        <span class="hljs-comment">// åŠ¨æ€åŒ¹é…æˆåŠŸï¼Œæ‰§è¡Œå¯¹åº”çš„æ‹¦æˆªæ–¹æ³•</span><br>        <span class="hljs-keyword">if</span> (dm.methodMatcher.matches(<span class="hljs-built_in">this</span>.method, targetClass, <span class="hljs-built_in">this</span>.arguments)) &#123;<br>            <span class="hljs-keyword">return</span> dm.interceptor.invoke(<span class="hljs-built_in">this</span>);<br>        &#125;<br>        <span class="hljs-comment">// åŠ¨æ€åŒ¹é…å¤±è´¥ï¼Œå¿½ç•¥å½“å‰æ‹¦æˆªå™¨æ–¹æ³•ï¼Œç»§ç»­æ‰§è¡Œä¸‹ä¸€ä¸ªæ‹¦æˆªå™¨</span><br>        <span class="hljs-keyword">else</span> &#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-built_in">this</span>.proceed();<br>        &#125;<br>    &#125;<br>    <span class="hljs-comment">// é™æ€æ‹¦æˆªå™¨ï¼Œç›´æ¥åº”ç”¨æ‹¦æˆªæ–¹æ³•</span><br>    <span class="hljs-keyword">else</span> &#123;<br>        <span class="hljs-keyword">return</span> ((MethodInterceptor) interceptorOrInterceptionAdvice).invoke(<span class="hljs-built_in">this</span>);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>æ‹¦æˆªå™¨æ–¹æ³•çš„æ‰§è¡Œæµç¨‹å¦‚ä¸Šè¿°ä»£ç æ³¨é‡Šï¼Œæ˜¯ä¸€ä¸ªé€’å½’è°ƒç”¨çš„è¿‡ç¨‹ï¼Œå¹¶åœ¨æœ€ååº”ç”¨å¢å¼ºæ–¹æ³•ã€‚</p>
<p>å®Œæˆäº†å¯¹äº AOP ä»£ç†å¯¹è±¡ <code>JdkDynamicAopProxy</code> çš„åˆ›å»ºï¼Œæœ€åæ¥çœ‹ä¸€ä¸‹è·å–è¯¥å¯¹è±¡çš„è¿‡ç¨‹ï¼Œå®ç°ä½äº <code>JdkDynamicAopProxy#getProxy</code> æ–¹æ³•ä¸­ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> Object <span class="hljs-title function_">getProxy</span><span class="hljs-params">(<span class="hljs-meta">@Nullable</span> ClassLoader classLoader)</span> &#123;<br>    <span class="hljs-comment">// è·å–éœ€è¦è¢«ä»£ç†çš„æ¥å£é›†åˆ</span><br>    Class&lt;?&gt;[] proxiedInterfaces = AopProxyUtils.completeProxiedInterfaces(<span class="hljs-built_in">this</span>.advised, <span class="hljs-literal">true</span>);<br>    <span class="hljs-comment">// æ£€æµ‹æ˜¯å¦åœ¨è¢«ä»£ç†æ¥å£ä¸­å£°æ˜äº† equals å’Œ hashCode æ–¹æ³•</span><br>    <span class="hljs-built_in">this</span>.findDefinedEqualsAndHashCodeMethods(proxiedInterfaces);<br>    <span class="hljs-comment">// åŸºäº Java åŸç”Ÿä»£ç†ç”Ÿæˆä»£ç†å¯¹è±¡</span><br>    <span class="hljs-keyword">return</span> Proxy.newProxyInstance(classLoader, proxiedInterfaces, <span class="hljs-built_in">this</span>);<br>&#125;<br></code></pre></td></tr></table></figure>

<p>è¿™é‡Œçš„é€»è¾‘ä¹Ÿå°±æ˜¯ Java åŸç”Ÿä»£ç†çš„æ¨¡æ¿ä»£ç ï¼Œå¦‚æœå¯¹ Java ä»£ç†æ¯”è¾ƒç†Ÿæ‚‰çš„è¯ï¼Œåº”è¯¥ä¸éš¾ç†è§£</p>
<h5 id="åŸºäº-CGLib-ä»£ç†åˆ›å»ºå¢å¼ºä»£ç†å¯¹è±¡"><a href="#åŸºäº-CGLib-ä»£ç†åˆ›å»ºå¢å¼ºä»£ç†å¯¹è±¡" class="headerlink" title="åŸºäº CGLib ä»£ç†åˆ›å»ºå¢å¼ºä»£ç†å¯¹è±¡"></a>åŸºäº CGLib ä»£ç†åˆ›å»ºå¢å¼ºä»£ç†å¯¹è±¡</h5><p>åŸºäº CGLib ä»£ç†ç”Ÿæˆå¢å¼ºä»£ç†å¯¹è±¡çš„è¿‡ç¨‹ä½äº <code>ObjenesisCglibAopProxy</code> ç±»ä¸­ï¼Œè¯¥ç±»ç»§æ‰¿è‡ª <code>CglibAopProxy</code> ç±»ã€‚è·å– CGLib ä»£ç†ç±»å¯¹è±¡çš„æ–¹æ³•å®šä¹‰åœ¨ <code>CglibAopProxy</code> ä¸­ï¼Œå³ <code>CglibAopProxy#getProxy</code> æ–¹æ³•ã€‚è¯¥æ–¹æ³•åŸºäº CGLib çš„ <code>Enhancer</code> ç±»åˆ›å»ºä»£ç†å¯¹è±¡ï¼Œå±äº CGLib çš„æ ‡å‡†ä½¿ç”¨æ¨¡å¼ï¼Œå› ä¸ºæœ‰å¤šä¸ª <code>callback</code> å®ç°ï¼Œæ‰€ä»¥è¿™é‡Œä½¿ç”¨äº† <code>CallbackFilter</code> æ¨¡å¼ï¼Œä¾æ®åœºæ™¯é€‰æ‹©å¹¶åº”ç”¨å¯¹åº”çš„ <code>callback</code> æ‹¦æˆªå™¨ã€‚</p>
<p>æˆ‘ä»¬é‡ç‚¹å…³æ³¨ <code>callback</code> çš„å®ç°ï¼Œä½äº <code>CglibAopProxy#getCallbacks</code> æ–¹æ³•ä¸­ã€‚å—åˆ¶äº CGLib åœ¨æ‰§è¡Œæ—¶ä¸€æ¬¡åªå…è®¸åº”ç”¨ä¸€ä¸ª <code>callback</code> çš„çº¦æŸï¼Œæ‰€ä»¥è¯¥æ–¹æ³•ä¾æ®å‚æ•°é…ç½®å®ç°äº†ä¸€ç»„ <code>callback</code>ï¼Œä»¥è¦†ç›–ä¸åŒçš„åœºæ™¯ã€‚æ ¸å¿ƒçš„ AOP callback å®ç°æ˜¯ <code>DynamicAdvisedInterceptor</code> ç±»ï¼Œå®ƒå®ç°äº† <code>MethodInterceptor</code> æ¥å£ï¼Œå¯¹åº”çš„ <code>DynamicAdvisedInterceptor#intercept</code> æ–¹æ³•å®ç°å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> Object <span class="hljs-title function_">intercept</span><span class="hljs-params">(Object proxy, Method method, Object[] args, MethodProxy methodProxy)</span> <span class="hljs-keyword">throws</span> Throwable &#123;<br>    <span class="hljs-type">Object</span> <span class="hljs-variable">oldProxy</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;<br>    <span class="hljs-type">boolean</span> <span class="hljs-variable">setProxyContext</span> <span class="hljs-operator">=</span> <span class="hljs-literal">false</span>;<br>    <span class="hljs-type">Object</span> <span class="hljs-variable">target</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;<br>    <span class="hljs-type">TargetSource</span> <span class="hljs-variable">targetSource</span> <span class="hljs-operator">=</span> <span class="hljs-built_in">this</span>.advised.getTargetSource();<br>    <span class="hljs-keyword">try</span> &#123;<br>        <span class="hljs-comment">// æŒ‡å®šå†…éƒ¨é—´è°ƒç”¨ä¹Ÿéœ€è¦ä»£ç†</span><br>        <span class="hljs-keyword">if</span> (<span class="hljs-built_in">this</span>.advised.exposeProxy) &#123;<br>            <span class="hljs-comment">// Make invocation available if necessary.</span><br>            oldProxy = AopContext.setCurrentProxy(proxy);<br>            setProxyContext = <span class="hljs-literal">true</span>;<br>        &#125;<br>        <span class="hljs-comment">// Get as late as possible to minimize the time we &quot;own&quot; the target, in case it comes from a pool...</span><br>        target = targetSource.getTarget();<br>        Class&lt;?&gt; targetClass = (target != <span class="hljs-literal">null</span> ? target.getClass() : <span class="hljs-literal">null</span>);<br><br>        <span class="hljs-comment">// è·å–å½“å‰æ–¹æ³•çš„æ‹¦æˆªå™¨é“¾</span><br>        List&lt;Object&gt; chain = <span class="hljs-built_in">this</span>.advised.getInterceptorsAndDynamicInterceptionAdvice(method, targetClass);<br>        <span class="hljs-comment">// ç»“æœå€¼</span><br>        Object retVal;<br>        <span class="hljs-comment">// Check whether we only have one InvokerInterceptor:</span><br>        <span class="hljs-comment">// that is, no real advice, but just reflective invocation of the target.</span><br>        <span class="hljs-comment">// æ‹¦æˆªå™¨é“¾ä¸ºç©ºï¼Œåˆ™ç›´æ¥åå°„è°ƒç”¨å¢å¼ºæ–¹æ³•</span><br>        <span class="hljs-keyword">if</span> (chain.isEmpty() &amp;&amp; Modifier.isPublic(method.getModifiers())) &#123;<br>            <span class="hljs-comment">// We can skip creating a MethodInvocation: just invoke the target directly.</span><br>            <span class="hljs-comment">// Note that the final invoker must be an InvokerInterceptor, so we know</span><br>            <span class="hljs-comment">// it does nothing but a reflective operation on the target, and no hot swapping or fancy proxying.</span><br>            Object[] argsToUse = AopProxyUtils.adaptArgumentsIfNecessary(method, args);<br>            retVal = methodProxy.invoke(target, argsToUse);<br>        &#125;<br>        <span class="hljs-comment">// å¦åˆ™éœ€è¦åˆ›å»ºå¯¹åº”çš„ MethodInvocationï¼Œä»¥é“¾å¼è°ƒç”¨æ‹¦æˆªå™¨æ–¹æ³•å’Œå¢å¼ºæ–¹æ³•</span><br>        <span class="hljs-keyword">else</span> &#123;<br>            retVal = <span class="hljs-keyword">new</span> <span class="hljs-title class_">CglibMethodInvocation</span>(proxy, target, method, args, targetClass, chain, methodProxy).proceed();<br>        &#125;<br>        <span class="hljs-comment">// å¤„ç†è¿”å›å€¼</span><br>        retVal = processReturnType(proxy, target, method, retVal);<br>        <span class="hljs-keyword">return</span> retVal;<br>    &#125; <span class="hljs-keyword">finally</span> &#123;<br>        <span class="hljs-keyword">if</span> (target != <span class="hljs-literal">null</span> &amp;&amp; !targetSource.isStatic()) &#123;<br>            targetSource.releaseTarget(target);<br>        &#125;<br>        <span class="hljs-keyword">if</span> (setProxyContext) &#123;<br>            <span class="hljs-comment">// Restore old proxy.</span><br>            AopContext.setCurrentProxy(oldProxy);<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>å¯ä»¥çœ‹å‡ºä¸Šè¿°æ–¹æ³•åœ¨å®ç°æµç¨‹ä¸Šä¸å‰é¢ä»‹ç»çš„ <code>JdkDynamicAopProxy#invoke</code> æ–¹æ³•æ˜¯ä¸€è‡´çš„ï¼Œåªæ˜¯è¿™é‡Œæ˜¯åŸºäº CGLib å®ç°</p>
<blockquote>
<p>å‚è€ƒ <a target="_blank" rel="noopener" href="https://my.oschina.net/wangzhenchao/blog/4279608">https://my.oschina.net/wangzhenchao/blog/4279608</a></p>
</blockquote>
<h4 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h4><ol>
<li><code>@EnableAspectJAutoProxy</code> å¼€å¯AOPåŠŸèƒ½ </li>
<li><code>@EnableAspectJAutoProxy</code> ä¼šç»™å®¹å™¨ä¸­æ³¨å†Œä¸€ä¸ªç»„ä»¶ <code>AnnotationAwareAspectJAutoProxyCreator</code> </li>
<li><code>AnnotationAwareAspectJAutoProxyCreator</code> æ˜¯ä¸€ä¸ª <code>InstantiationAwareBeanPostProcessor</code> ç±»å‹åç½®å¤„ç†å™¨ï¼ŒåŠŸèƒ½å¯ä»¥æ¦‚æ‹¬ä¸ºï¼š<ol>
<li>ä»å®¹å™¨ä¸­è·å–æ‰€æœ‰çš„åˆ‡é¢å®šä¹‰</li>
<li>ç­›é€‰é€‚ç”¨äºå½“å‰ bean çš„å¢å¼ºå™¨é›†åˆ</li>
<li>ä¾æ®å¢å¼ºå™¨é›†åˆåŸºäºåŠ¨æ€ä»£ç†æœºåˆ¶ç”Ÿæˆç›¸åº”çš„å¢å¼ºä»£ç†å¯¹è±¡</li>
</ol>
</li>
</ol>
<p>Spring AOP çš„å®ç°æœ¬è´¨ä¸Šæ˜¯ä¸€ä¸ªåŠ¨æ€ä»£ç†çš„è¿‡ç¨‹ï¼ŒSpring å¼•å…¥äº† Java åŸç”Ÿä»£ç†å’Œ CGLib ä»£ç†ï¼Œå¹¶ä¾æ®åœºæ™¯é€‰æ‹©åŸºäºå“ªç§ä»£ç†æœºåˆ¶å¯¹ç›®æ ‡å¯¹è±¡è¿›è¡Œå¢å¼ºã€‚Spring å®¹å™¨åœ¨å®Œæˆå¯¹ bean å¯¹è±¡çš„åˆ›å»ºä¹‹åä¼šæ‰§è¡Œåˆå§‹åŒ–æ“ä½œï¼Œè€Œ AOP åˆå§‹åŒ–çš„è¿‡ç¨‹å°±å‘ç”Ÿåœ¨ bean çš„åç½®åˆå§‹åŒ–é˜¶æ®µ</p>

                
              </div>
            
            <hr/>
            <div>
              <div class="post-metas my-3">
  
    <div class="post-meta mr-3 d-flex align-items-center">
      <i class="iconfont icon-category"></i>
      

<span class="category-chains">
  
  
    
      <span class="category-chain">
        
  <a href="/categories/Java/" class="category-chain-item">Java</a>
  
  

      </span>
    
  
</span>

    </div>
  
  
    <div class="post-meta">
      <i class="iconfont icon-tags"></i>
      
        <a href="/tags/Java/" class="print-no-link">#Java</a>
      
        <a href="/tags/AOP/" class="print-no-link">#AOP</a>
      
        <a href="/tags/Reflect/" class="print-no-link">#Reflect</a>
      
        <a href="/tags/Proxy/" class="print-no-link">#Proxy</a>
      
    </div>
  
</div>


              
  

  <div class="license-box my-3">
    <div class="license-title">
      <div>ä»£ç† Proxy åå°„ Reflect ä¸ Spring AOP</div>
      <div>https://sugayoiya.github.io/posts/59835.html</div>
    </div>
    <div class="license-meta">
      
        <div class="license-meta-item">
          <div>ä½œè€…</div>
          <div>Sugayoiya</div>
        </div>
      
      
        <div class="license-meta-item license-meta-date">
          <div>å‘å¸ƒäº</div>
          <div>2021å¹´8æœˆ1æ—¥</div>
        </div>
      
      
      
        <div class="license-meta-item">
          <div>è®¸å¯åè®®</div>
          <div>
            
              
              
                <a class="print-no-link" target="_blank" href="https://creativecommons.org/licenses/by-nc-sa/4.0/">
                  <span class="hint--top hint--rounded" aria-label="BY - ç½²å">
                    <i class="iconfont icon-by"></i>
                  </span>
                </a>
              
                <a class="print-no-link" target="_blank" href="https://creativecommons.org/licenses/by-nc-sa/4.0/">
                  <span class="hint--top hint--rounded" aria-label="NC - éå•†ä¸šæ€§ä½¿ç”¨">
                    <i class="iconfont icon-nc"></i>
                  </span>
                </a>
              
                <a class="print-no-link" target="_blank" href="https://creativecommons.org/licenses/by-nc-sa/4.0/">
                  <span class="hint--top hint--rounded" aria-label="SA - ç›¸åŒæ–¹å¼å…±äº«">
                    <i class="iconfont icon-sa"></i>
                  </span>
                </a>
              
            
          </div>
        </div>
      
    </div>
    <div class="license-icon iconfont"></div>
  </div>



              
                <div class="post-prevnext my-3">
                  <article class="post-prev col-6">
                    
                    
                      <a href="/posts/11853.html" title="Spring è§£å†³å¾ªç¯ä¾èµ–åŸç†">
                        <i class="iconfont icon-arrowleft"></i>
                        <span class="hidden-mobile">Spring è§£å†³å¾ªç¯ä¾èµ–åŸç†</span>
                        <span class="visible-mobile">ä¸Šä¸€ç¯‡</span>
                      </a>
                    
                  </article>
                  <article class="post-next col-6">
                    
                    
                      <a href="/posts/34792.html" title="Spring Bean çš„ç”Ÿå‘½å‘¨æœŸ">
                        <span class="hidden-mobile">Spring Bean çš„ç”Ÿå‘½å‘¨æœŸ</span>
                        <span class="visible-mobile">ä¸‹ä¸€ç¯‡</span>
                        <i class="iconfont icon-arrowright"></i>
                      </a>
                    
                  </article>
                </div>
              
            </div>

            
  
  
    <article id="comments" lazyload>
      
  <div id="waline"></div>
  <script type="text/javascript">
    Fluid.utils.loadComments('#waline', function() {
      Fluid.utils.createCssLink('https://cdn.staticfile.org/waline/2.15.5/waline.min.css')
      Fluid.utils.createScript('https://cdn.staticfile.org/waline/2.15.5/waline.min.js', function() {
        var options = Object.assign(
          {"serverURL":"waline-mongo-gamma.vercel.app","path":"window.location.pathname","meta":["nick","mail","link"],"requiredMeta":["nick"],"lang":"zh-CN","emoji":["https://cdn.jsdelivr.net/gh/walinejs/emojis/weibo","https://unpkg.com/@waline/emojis@1.1.0/bilibili"],"dark":"html[data-user-color-scheme=\"dark\"]","wordLimit":0,"pageSize":10},
          {
            el: '#waline',
            path: window.location.pathname
          }
        )
        Waline.init(options);
        Fluid.utils.waitElementVisible('#waline .vcontent', () => {
          var imgSelector = '#waline .vcontent img:not(.vemoji)';
          Fluid.plugins.imageCaption(imgSelector);
          Fluid.plugins.fancyBox(imgSelector);
        })
      });
    });
  </script>
  <noscript>Please enable JavaScript to view the comments</noscript>


    </article>
  


          </article>
        </div>
      </div>
    </div>

    <div class="side-col d-none d-lg-block col-lg-2">
      
  <aside class="sidebar" style="margin-left: -1rem">
    <div id="toc">
  <p class="toc-header">
    <i class="iconfont icon-list"></i>
    <span>ç›®å½•</span>
  </p>
  <div class="toc-body" id="toc-body"></div>
</div>



  </aside>


    </div>
  </div>
</div>





  



  



  



  



  







    

    
      <a id="scroll-top-button" aria-label="TOP" href="#" role="button">
        <i class="iconfont icon-arrowup" aria-hidden="true"></i>
      </a>
    

    
      <div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel"
     aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header text-center">
        <h4 class="modal-title w-100 font-weight-bold">æœç´¢</h4>
        <button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body mx-3">
        <div class="md-form mb-5">
          <input type="text" id="local-search-input" class="form-control validate">
          <label data-error="x" data-success="v" for="local-search-input">å…³é”®è¯</label>
        </div>
        <div class="list-group" id="local-search-result"></div>
      </div>
    </div>
  </div>
</div>

    

    
  </main>

  <footer>
    <div class="footer-inner">
  
    <div class="footer-content">
       <a href="https://hexo.io" target="_blank" rel="nofollow noopener"><span>Hexo</span></a> <i class="iconfont icon-love"></i> <a href="https://github.com/fluid-dev/hexo-theme-fluid" target="_blank" rel="nofollow noopener"><span>Fluid</span></a> 
    </div>
  
  
    <div class="statistics">
  
  

  
    
      <span id="busuanzi_container_site_pv" style="display: none">
        æ€»è®¿é—®é‡ 
        <span id="busuanzi_value_site_pv"></span>
         æ¬¡
      </span>
    
    
      <span id="busuanzi_container_site_uv" style="display: none">
        æ€»è®¿å®¢æ•° 
        <span id="busuanzi_value_site_uv"></span>
         äºº
      </span>
    
    
  
</div>

  
  
  
</div>

  </footer>

  <!-- Scripts -->
  
  <script  src="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.js" ></script>
  <link  rel="stylesheet" href="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.css" />

  <script>
    NProgress.configure({"showSpinner":false,"trickleSpeed":100})
    NProgress.start()
    window.addEventListener('load', function() {
      NProgress.done();
    })
  </script>


<script  src="https://lib.baomitu.com/jquery/3.6.4/jquery.min.js" ></script>
<script  src="https://lib.baomitu.com/twitter-bootstrap/4.6.1/js/bootstrap.min.js" ></script>
<script  src="/js/events.js" ></script>
<script  src="/js/plugins.js" ></script>


  <script  src="https://lib.baomitu.com/typed.js/2.0.12/typed.min.js" ></script>
  <script>
    (function (window, document) {
      var typing = Fluid.plugins.typing;
      var subtitle = document.getElementById('subtitle');
      if (!subtitle || !typing) {
        return;
      }
      var text = subtitle.getAttribute('data-typed-text');
      
        typing(text);
      
    })(window, document);
  </script>




  
    <script  src="/js/img-lazyload.js" ></script>
  




  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/tocbot/4.20.1/tocbot.min.js', function() {
    var toc = jQuery('#toc');
    if (toc.length === 0 || !window.tocbot) { return; }
    var boardCtn = jQuery('#board-ctn');
    var boardTop = boardCtn.offset().top;

    window.tocbot.init(Object.assign({
      tocSelector     : '#toc-body',
      contentSelector : '.markdown-body',
      linkClass       : 'tocbot-link',
      activeLinkClass : 'tocbot-active-link',
      listClass       : 'tocbot-list',
      isCollapsedClass: 'tocbot-is-collapsed',
      collapsibleClass: 'tocbot-is-collapsible',
      scrollSmooth    : true,
      includeTitleTags: true,
      headingsOffset  : -boardTop,
    }, CONFIG.toc));
    if (toc.find('.toc-list-item').length > 0) {
      toc.css('visibility', 'visible');
    }

    Fluid.events.registerRefreshCallback(function() {
      if ('tocbot' in window) {
        tocbot.refresh();
        var toc = jQuery('#toc');
        if (toc.length === 0 || !tocbot) {
          return;
        }
        if (toc.find('.toc-list-item').length > 0) {
          toc.css('visibility', 'visible');
        }
      }
    });
  });
</script>


  <script src=https://lib.baomitu.com/clipboard.js/2.0.11/clipboard.min.js></script>

  <script>Fluid.plugins.codeWidget();</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/anchor-js/4.3.1/anchor.min.js', function() {
    window.anchors.options = {
      placement: CONFIG.anchorjs.placement,
      visible  : CONFIG.anchorjs.visible
    };
    if (CONFIG.anchorjs.icon) {
      window.anchors.options.icon = CONFIG.anchorjs.icon;
    }
    var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
    var res = [];
    for (var item of el) {
      res.push('.markdown-body > ' + item.trim());
    }
    if (CONFIG.anchorjs.placement === 'left') {
      window.anchors.options.class = 'anchorjs-link-left';
    }
    window.anchors.add(res.join(', '));

    Fluid.events.registerRefreshCallback(function() {
      if ('anchors' in window) {
        anchors.removeAll();
        var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
        var res = [];
        for (var item of el) {
          res.push('.markdown-body > ' + item.trim());
        }
        if (CONFIG.anchorjs.placement === 'left') {
          anchors.options.class = 'anchorjs-link-left';
        }
        anchors.add(res.join(', '));
      }
    });
  });
</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.js', function() {
    Fluid.plugins.fancyBox();
  });
</script>


  <script>Fluid.plugins.imageCaption();</script>

  <script defer src="/js/leancloud.js" ></script>

  <script  src="/js/local-search.js" ></script>

  <script defer src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js" ></script>





<!-- ä¸»é¢˜çš„å¯åŠ¨é¡¹ï¼Œå°†å®ƒä¿æŒåœ¨æœ€åº•éƒ¨ -->
<!-- the boot of the theme, keep it at the bottom -->
<script  src="/js/boot.js" ></script>


  

  <noscript>
    <div class="noscript-warning">åšå®¢åœ¨å…è®¸ JavaScript è¿è¡Œçš„ç¯å¢ƒä¸‹æµè§ˆæ•ˆæœæ›´ä½³</div>
  </noscript>
</body>
</html>
